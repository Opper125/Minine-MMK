<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - MMK Mining (Static DB Version)</title>
  <script src="https://unpkg.com/lucide-static@latest/dist/lucide.min.js"></script>
  <style>
      /* Styles from your previous server.html - keeping them for layout */
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
      :root {
          --admin-primary: #007bff; /* Blue */
          --admin-secondary: #6c757d; /* Gray */
          --admin-success: #28a745; /* Green */
          --admin-danger: #dc3545; /* Red */
          --admin-warning: #ffc107; /* Yellow */
          --admin-info: #17a2b8; /* Teal */
          --admin-light: #f8f9fa; /* Light Gray */
          --admin-dark: #343a40; /* Dark Gray */
          --admin-bg: #f4f6f9; /* Background */
          --admin-text: #212529; /* Body text */
          --admin-surface: #ffffff; /* Card backgrounds */
          --admin-border: #dee2e6; /* Borders */
          --admin-font: 'Roboto', sans-serif;
      }
      body {
          font-family: var(--admin-font); margin: 0; background-color: var(--admin-bg);
          color: var(--admin-text); font-size: 15px; line-height: 1.5;
      }
      #admin-app header {
          background-color: var(--admin-dark); color: white; padding: 15px 25px;
          display: flex; justify-content: space-between; align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      #admin-app header h1 { margin: 0; font-size: 1.6em; font-weight: 500; }
      #admin-logout-button, #export-db-button { background-color: var(--admin-danger); color:white; border:none; padding: 8px 15px; cursor:pointer; border-radius:4px; font-size:0.9em; margin-left: 10px;}
      #admin-logout-button:hover, #export-db-button:hover { background-color: #c82333; }
      #export-db-button { background-color: var(--admin-info); }
      #export-db-button:hover { background-color: #117a8b; }

      #admin-login-section {
          width: 100%; max-width: 380px; margin: 60px auto; padding: 30px;
          background-color: var(--admin-surface); border-radius: 6px; box-shadow: 0 0 15px rgba(0,0,0,0.1);
      }
      #admin-login-section h2 { text-align: center; margin-bottom: 25px; color: var(--admin-dark); font-weight:500; }
      .admin-form-group { margin-bottom: 18px; }
      .admin-form-group label { display:block; margin-bottom:6px; font-weight:500; }
      .admin-form-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--admin-border); border-radius: 4px; box-sizing: border-box; font-size:1em;}
      .admin-button-primary { width: 100%; padding: 10px 15px; background-color: var(--admin-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size:1.05em; font-weight:500;}
      #admin-login-message { margin-top:15px; text-align:center; color: var(--admin-danger); }

      #admin-main-content { display: flex; min-height: calc(100vh - 67px); }
      #admin-main-content nav { width: 230px; background-color: var(--admin-dark); padding: 20px 0; color: #adb5bd; }
      #admin-main-content nav button {
          display: flex; align-items: center; gap: 10px; width: 100%; padding: 12px 20px;
          background-color: transparent; color: #adb5bd; border: none; text-align: left;
          cursor: pointer; font-size: 1em; transition: background-color 0.2s, color 0.2s;
      }
      #admin-main-content nav button:hover, #admin-main-content nav button.active { background-color: var(--admin-primary); color: white; }
      .admin-content-section { flex-grow: 1; padding: 25px; background-color: var(--admin-bg); }
      .admin-content-section h2 { margin-top: 0; color: var(--admin-dark); border-bottom: 1px solid var(--admin-border); padding-bottom:15px; margin-bottom:25px; font-size: 1.8em; font-weight: 500;}
      .admin-card { background-color: var(--admin-surface); padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 25px; }
      .admin-card h3 { margin-top:0; font-size:1.2em; color: var(--admin-primary); }
      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom:25px;}
      .stat-card { background-color: var(--admin-surface); padding: 20px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); text-align: center; }
      .stat-card .stat-value { font-size: 2em; font-weight: bold; color: var(--admin-primary); display:block; margin-bottom:5px;}
      .stat-card .stat-label { font-size: 0.95em; color: var(--admin-secondary); }
      .admin-table-wrapper { overflow-x: auto; }
      table.admin-table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: var(--admin-surface); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      .admin-table th, .admin-table td { border: 1px solid var(--admin-border); padding: 10px 12px; text-align: left; vertical-align: middle; }
      .admin-table th { background-color: var(--admin-light); font-weight: 500; }
      .admin-table td button { margin-right: 5px; padding: 6px 10px; cursor:pointer; border-radius:4px; border:1px solid transparent; font-size:0.85em; text-decoration: none; display:inline-flex; align-items:center; gap: 4px; }
      .admin-button-success { background-color: var(--admin-success); color:white; border-color:var(--admin-success);}
      .admin-button-danger { background-color: var(--admin-danger); color:white; border-color:var(--admin-danger);}
      .admin-button-warning { background-color: var(--admin-warning); color:var(--admin-text); border-color:var(--admin-warning);}
      .admin-button-info { background-color: var(--admin-info); color:white; border-color:var(--admin-info);}
      .admin-button-secondary { background-color: var(--admin-secondary); color:white; border-color:var(--admin-secondary);}
      .status-badge { padding: 4px 8px; border-radius: 10px; font-size: 0.8em; font-weight: 500; color: white; display: inline-block; }
      .status-pending_payment, .status-pending_approval, .status-pending-payment, .status-pending-approval { background-color: var(--admin-warning); color: var(--admin-text); }
      .status-active, .status-approved { background-color: var(--admin-success); }
      .status-completed, .status-processing { background-color: var(--admin-info); }
      .status-rejected_payment, .status-rejected, .status-rejected-payment { background-color: var(--admin-danger); }
      .status-expired { background-color: var(--admin-secondary); }
      #add-edit-plan-form .admin-form-group, #admin-settings-form .admin-form-group { margin-bottom: 15px; }
      #add-edit-plan-form textarea { min-height: 80px; }
      .data-update-info { background-color: var(--admin-warning); color: var(--admin-text); padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #ffab00; }
  </style>
</head>
<body>
  <div id="admin-app">
      <header>
          <h1><i data-lucide="shield-check"></i> Admin Dashboard (Static DB)</h1>
          <div>
              <button id="export-db-button" style="display:none;"><i data-lucide="database-export"></i> Export DB for Update</button>
              <button id="admin-logout-button" style="display:none;"><i data-lucide="log-out"></i> Logout</button>
          </div>
      </header>

      <section id="admin-login-section">
          <h2>Admin Login</h2>
          <form id="admin-login-form">
              <div class="admin-form-group">
                  <label for="admin-password">Admin Password:</label>
                  <input type="password" id="admin-password" required>
              </div>
              <button type="submit" class="admin-button-primary">Login</button>
          </form>
          <p id="admin-login-message" style="display:none;"></p>
      </section>

      <main id="admin-main-content" style="display:none;">
          <nav>
              <button data-section="dashboard-summary" class="active"><i data-lucide="layout-dashboard"></i> Dashboard</button>
              <button data-section="manage-users"><i data-lucide="users"></i> Users</button>
              <button data-section="manage-purchases"><i data-lucide="shopping-bag"></i> Purchases</button>
              <button data-section="manage-withdrawals"><i data-lucide="arrow-down-left-from-circle"></i> Withdrawals</button>
              <button data-section="manage-plans"><i data-lucide="server"></i> Mining Plans</button>
              <button data-section="admin-settings"><i data-lucide="settings"></i> Settings</button>
          </nav>

          <div class="admin-content-section" id="dashboard-summary-section">
              <h2>Dashboard Summary</h2>
              <div class="data-update-info">
                  <strong>Important:</strong> Data displayed here is from the locally loaded <code>database.js</code>.
                  To make changes permanent, you must use the "Export DB for Update" button after making modifications,
                  then manually update the <code>database.js</code> file in your project and redeploy the website.
              </div>
              <div class="stats-grid">
                  <div class="stat-card"><span id="total-users-stat" class="stat-value">0</span><span class="stat-label">Total Users</span></div>
                  <div class="stat-card"><span id="active-plans-stat" class="stat-value">0</span><span class="stat-label">Active User Plans</span></div>
                  <div class="stat-card"><span id="pending-purchases-stat" class="stat-value">0</span><span class="stat-label">Pending Purchases</span></div>
                  <div class="stat-card"><span id="pending-withdrawals-stat" class="stat-value">0</span><span class="stat-label">Pending Withdrawals</span></div>
              </div>
          </div>

          <div class="admin-content-section" id="manage-users-section" style="display:none;">
              <h2>Manage Users</h2>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="users-table">
                      <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Balance (MMK)</th><th>Is Admin?</th><th>Joined</th></tr></thead>
                      <tbody><!-- User data here --></tbody>
                  </table>
              </div>
          </div>

          <div class="admin-content-section" id="manage-purchases-section" style="display:none;">
              <h2>Manage Purchase Orders</h2>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="purchases-table">
                      <thead><tr><th>User Email</th><th>Plan Name</th><th>Price</th><th>Receipt (Simulated)</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                      <tbody><!-- Purchase data here --></tbody>
                  </table>
              </div>
          </div>
          
          <div class="admin-content-section" id="manage-withdrawals-section" style="display:none;">
              <h2>Manage Withdrawal Requests</h2>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="withdrawals-table">
                      <thead><tr><th>User Email</th><th>Amount</th><th>Method</th><th>Phone</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                      <tbody><!-- Withdrawal data here --></tbody>
                  </table>
              </div>
          </div>

          <div class="admin-content-section" id="manage-plans-section" style="display:none;">
              <h2>Manage Mining Plans</h2>
              <button id="add-new-plan-button" class="admin-button-primary" style="margin-bottom:20px; width:auto;"><i data-lucide="plus-circle"></i> Add New Plan</button>
              <div id="add-edit-plan-form-container" class="admin-card" style="display:none;">
                  <h3 id="plan-form-title">Add New Plan</h3>
                  <form id="add-edit-plan-form">
                      <input type="hidden" id="plan-id-admin">
                      <div class="admin-form-group"><label for="plan-name-admin">Name:</label><input type="text" id="plan-name-admin" required></div>
                      <div class="admin-form-group"><label for="plan-price-admin">Price (MMK):</label><input type="number" step="1000" id="plan-price-admin" required></div>
                      <div class="admin-form-group"><label for="plan-duration-admin">Duration (Days):</label><input type="number" id="plan-duration-admin" required></div>
                      <div class="admin-form-group"><label for="plan-return-multiplier-admin">Total Return Multiplier (e.g., 1.8):</label><input type="number" step="0.01" id="plan-return-multiplier-admin" required></div>
                      <div class="admin-form-group"><label for="plan-power-admin">Power (MMK/sec):</label><input type="number" step="0.00001" id="plan-power-admin" required></div>
                      <div class="admin-form-group"><label for="plan-description-admin">Description:</label><textarea id="plan-description-admin"></textarea></div>
                      <div class="admin-form-group" style="display:flex; align-items:center;"><input type="checkbox" id="plan-active-admin" checked style="width:auto; margin-right:10px;"><label for="plan-active-admin" style="margin-bottom:0;">Active</label></div>
                      <div class="form-actions">
                          <button type="submit" id="save-plan-button" class="admin-button-success">Save Plan (Locally)</button>
                          <button type="button" id="cancel-plan-button" class="admin-button-secondary">Cancel</button>
                      </div>
                  </form>
              </div>
              <div id="mining-plans-list-admin" class="admin-card">
                  <h3>Existing Plans</h3>
                  <!-- Admin list of plans with edit/delete -->
              </div>
          </div>
          
          <div class="admin-content-section" id="admin-settings-section" style="display:none;">
              <h2>Admin Settings</h2>
              <div class="admin-card">
                  <form id="admin-settings-form">
                      <div class="admin-form-group">
                          <label for="setting-payment-phone">Payment Phone Number (for KPay/Wave):</label>
                          <input type="text" id="setting-payment-phone" name="payment_phone_number">
                      </div>
                       <div class="admin-form-group">
                          <label for="setting-admin-password">New Admin Panel Password (leave blank to keep current):</label>
                          <input type="password" id="setting-admin-password" name="admin_panel_password">
                          <small>Current password is in <code>database.js</code>. Changing it here only affects the current session's data. You must export and update <code>database.js</code> for it to be permanent.</small>
                      </div>
                      <button type="submit" class="admin-button-primary" style="width:auto;">Save Settings (Locally)</button>
                  </form>
                  <p id="admin-settings-message" style="display:none; margin-top:15px;"></p>
              </div>
          </div>
      </main>
  </div>

  <script type="module">
      import { dbData as adminDbData } from './database.js'; // Load the database

      // Make a working copy for admin modifications
      let currentWorkingDbData = JSON.parse(JSON.stringify(adminDbData));
      window.globalAdminDbData = currentWorkingDbData; // For easier access if needed, and for export

      let adminLoggedIn = false;

      // DOM Elements
      const adminLoginSectionEl = document.getElementById('admin-login-section');
      const adminLoginFormEl = document.getElementById('admin-login-form');
      const adminLoginMessageEl = document.getElementById('admin-login-message');
      const adminMainContentEl = document.getElementById('admin-main-content');
      const adminLogoutButtonEl = document.getElementById('admin-logout-button');
      const exportDbButtonEl = document.getElementById('export-db-button');
      const adminNavButtonsEl = document.querySelectorAll('#admin-main-content nav button');
      const adminContentSectionsEl = document.querySelectorAll('#admin-main-content .admin-content-section');
      
      // Dashboard Stats Elements
      const totalUsersStatEl = document.getElementById('total-users-stat');
      const activePlansStatEl = document.getElementById('active-plans-stat');
      const pendingPurchasesStatEl = document.getElementById('pending-purchases-stat');
      const pendingWithdrawalsStatEl = document.getElementById('pending-withdrawals-stat');

      // Users Table
      const usersTableBodyEl = document.querySelector('#users-table tbody');
      // Purchases Table
      const purchasesTableBodyEl = document.querySelector('#purchases-table tbody');
      // Withdrawals Table
      const withdrawalsTableBodyEl = document.querySelector('#withdrawals-table tbody');
      // Mining Plans
      const addNewPlanButtonEl = document.getElementById('add-new-plan-button');
      const addEditPlanFormContainerEl = document.getElementById('add-edit-plan-form-container');
      const planFormTitleEl = document.getElementById('plan-form-title');
      const addEditPlanFormEl = document.getElementById('add-edit-plan-form');
      const miningPlansListAdminEl = document.getElementById('mining-plans-list-admin');
      const planIdAdminInputEl = document.getElementById('plan-id-admin'); // Ensure this input exists in your form
      const savePlanButtonEl = document.getElementById('save-plan-button');
      const cancelPlanButtonEl = document.getElementById('cancel-plan-button');
      // Admin Settings
      const adminSettingsFormEl = document.getElementById('admin-settings-form');
      const settingPaymentPhoneInputEl = document.getElementById('setting-payment-phone');
      const settingAdminPasswordInputEl = document.getElementById('setting-admin-password');
      const adminSettingsMessageEl = document.getElementById('admin-settings-message');


      function generateSimpleIdAdmin(prefix = "item-") {
        return prefix + Date.now() + Math.random().toString(16).slice(2);
      }

      function showAdminLoginMessage(message, isError = true) {
          adminLoginMessageEl.textContent = message;
          adminLoginMessageEl.style.color = isError ? 'var(--admin-danger)' : 'var(--admin-success)';
          adminLoginMessageEl.style.display = 'block';
      }
      function showAdminSettingsMessage(message, isError = true) {
          adminSettingsMessageEl.textContent = message;
          adminSettingsMessageEl.style.color = isError ? 'var(--admin-danger)' : 'var(--admin-success)';
          adminSettingsMessageEl.style.display = 'block';
          setTimeout(() => { adminSettingsMessageEl.style.display = 'none'; }, 3000);
      }

      function showAdminSection(sectionId) {
          adminContentSectionsEl.forEach(section => section.style.display = 'none');
          adminNavButtonsEl.forEach(btn => btn.classList.remove('active'));
          document.getElementById(sectionId + '-section').style.display = 'block';
          document.querySelector(`#admin-main-content nav button[data-section="${sectionId}"]`).classList.add('active');
          
          if (sectionId === 'dashboard-summary') loadDashboardSummaryAdmin();
          if (sectionId === 'manage-users') loadUsersAdmin();
          if (sectionId === 'manage-purchases') loadPurchasesAdmin();
          if (sectionId === 'manage-withdrawals') loadWithdrawalsAdmin();
          if (sectionId === 'manage-plans') loadMiningPlansAdmin();
          if (sectionId === 'admin-settings') loadCurrentAdminSettingsAdmin();
          if (window.lucide) window.lucide.createIcons();
      }
      
      const formatDateAdmin = (dateString) => dateString ? new Date(dateString).toLocaleString() : 'N/A';

      adminLoginFormEl.addEventListener('submit', (e) => {
          e.preventDefault();
          const password = document.getElementById('admin-password').value;
          // IMPORTANT: This is highly insecure. For demo purposes only.
          if (password === currentWorkingDbData.admin_settings.admin_panel_password) {
              adminLoggedIn = true;
              sessionStorage.setItem('mmk_admin_logged_in', 'true'); // Simple session persistence
              adminLoginSectionEl.style.display = 'none';
              adminMainContentEl.style.display = 'flex';
              adminLogoutButtonEl.style.display = 'inline-block';
              exportDbButtonEl.style.display = 'inline-block';
              showAdminSection('dashboard-summary');
          } else {
              showAdminLoginMessage("Invalid admin password.");
          }
      });

      adminLogoutButtonEl.addEventListener('click', () => {
          adminLoggedIn = false;
          sessionStorage.removeItem('mmk_admin_logged_in');
          adminMainContentEl.style.display = 'none';
          adminLogoutButtonEl.style.display = 'none';
          exportDbButtonEl.style.display = 'none';
          adminLoginSectionEl.style.display = 'block';
          document.getElementById('admin-password').value = '';
      });
      
      exportDbButtonEl.addEventListener('click', () => {
          if (window.adminUtils && typeof window.adminUtils.exportDbDataForUpdate === 'function') {
              // Update the global dbData in database.js module scope before exporting
              // This is tricky because module exports are live bindings for non-primitives.
              // We are modifying currentWorkingDbData which is what adminUtils.exportDbDataForUpdate will stringify
              // if it's correctly referencing the shared object.
              // The database.js script already sets up window.adminUtils.exportDbDataForUpdate
              // to use its own `dbData` which we named `adminDbData` on import.
              // To ensure it exports the *modified* data:
              Object.assign(adminDbData, currentWorkingDbData); // Overwrite the imported module's data with our working copy
              window.adminUtils.exportDbDataForUpdate();
          } else {
              // Fallback if the function isn't on window for some reason
              const dataStr = JSON.stringify(currentWorkingDbData, null, 2);
              console.log("--- COPY MANUALLY --- \n" + `export let dbData = ${dataStr};`);
              alert("Export function not found on window.adminUtils. Data logged to console. Manually copy, update database.js, and redeploy.");
          }
      });

      adminNavButtonsEl.forEach(button => {
          button.addEventListener('click', () => showAdminSection(button.dataset.section));
      });

      // --- Data Loading Functions ---
      function loadDashboardSummaryAdmin() {
          totalUsersStatEl.textContent = currentWorkingDbData.users.length;
          activePlansStatEl.textContent = currentWorkingDbData.user_purchased_plans.filter(p => p.status === 'active').length;
          pendingPurchasesStatEl.textContent = currentWorkingDbData.user_purchased_plans.filter(p => p.status === 'pending_payment').length;
          pendingWithdrawalsStatEl.textContent = currentWorkingDbData.withdrawal_requests.filter(w => w.status === 'pending_approval').length;
      }

      function loadUsersAdmin() {
          usersTableBodyEl.innerHTML = '';
          currentWorkingDbData.users.forEach(user => {
              const row = usersTableBodyEl.insertRow();
              row.innerHTML = `
                  <td>${user.id}</td>
                  <td>${user.name}</td>
                  <td>${user.email}</td>
                  <td>${parseFloat(user.balance || 0).toLocaleString()}</td>
                  <td>${user.is_admin ? 'Yes' : 'No'}</td>
                  <td>${formatDateAdmin(user.created_at)}</td>
              `;
          });
      }
      
      function loadPurchasesAdmin() {
          purchasesTableBodyEl.innerHTML = '';
          currentWorkingDbData.user_purchased_plans.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).forEach(purchase => {
              const user = currentWorkingDbData.users.find(u => u.id === purchase.user_id);
              const plan = currentWorkingDbData.mining_plans.find(p => p.id === purchase.plan_id);
              const row = purchasesTableBodyEl.insertRow();
              row.innerHTML = `
                  <td>${user ? user.email : 'Unknown User'}</td>
                  <td>${plan ? plan.name : 'Unknown Plan'}</td>
                  <td>${parseFloat(purchase.purchase_price).toLocaleString()}</td>
                  <td>${purchase.payment_receipt_url ? `<a href="${purchase.payment_receipt_url}" target="_blank">${purchase.payment_receipt_url.substring(0,30)}...</a>` : 'N/A'}</td>
                  <td><span class="status-badge status-${purchase.status.replace('_','-')}">${purchase.status.replace('_',' ')}</span></td>
                  <td>${formatDateAdmin(purchase.created_at)}</td>
                  <td>
                      ${purchase.status === 'pending_payment' ? `
                          <button class="admin-button-success approve-purchase-btn" data-id="${purchase.id}"><i data-lucide="check"></i> Approve</button>,
                          <button class="admin-button-danger reject-purchase-btn" data-id="${purchase.id}"><i data-lucide="x"></i> Reject</button>` : 
                          (purchase.status === 'active' ? `<button class="admin-button-warning complete-purchase-btn" data-id="${purchase.id}"><i data-lucide="check-check"></i> Mark Completed</button>` : purchase.status)}
                  </td>`;
          });
          if(window.lucide) lucide.createIcons();
      }
      
      function loadWithdrawalsAdmin() {
          withdrawalsTableBodyEl.innerHTML = '';
          currentWorkingDbData.withdrawal_requests.sort((a,b) => new Date(b.requested_at) - new Date(a.requested_at)).forEach(withdrawal => {
              const user = currentWorkingDbData.users.find(u => u.id === withdrawal.user_id);
              const row = withdrawalsTableBodyEl.insertRow();
              row.innerHTML = `
                  <td>${user ? user.email : 'Unknown User'}</td>
                  <td>${parseFloat(withdrawal.amount).toLocaleString()}</td>
                  <td>${withdrawal.payment_method}</td>
                  <td>${withdrawal.recipient_phone}</td>
                  <td><span class="status-badge status-${withdrawal.status.replace('_','-')}">${withdrawal.status.replace('_',' ')}</span></td>
                  <td>${formatDateAdmin(withdrawal.requested_at)}</td>
                  <td>
                      ${withdrawal.status === 'pending_approval' ? `
                          <button class="admin-button-success approve-withdrawal-btn" data-id="${withdrawal.id}"><i data-lucide="check"></i> Approve</button>
                          <button class="admin-button-danger reject-withdrawal-btn" data-id="${withdrawal.id}"><i data-lucide="x"></i> Reject</button>` :
                          (withdrawal.status === 'approved' ? `<button class="admin-button-info process-withdrawal-btn" data-id="${withdrawal.id}"><i data-lucide="loader"></i> Mark Processing</button>` : 
                          (withdrawal.status === 'processing' ? `<button class="admin-button-success complete-withdrawal-btn" data-id="${withdrawal.id}"><i data-lucide="check-check"></i> Mark Completed</button>` : withdrawal.status)
                          )}
                  </td>`;
          });
          if(window.lucide) lucide.createIcons();
      }

      // --- Action Handlers (Modify currentWorkingDbData) ---
      document.addEventListener('click', (e) => {
          if (!adminLoggedIn) return;
          const target = e.target.closest('button');
          if (!target) return;

          const purchaseId = target.dataset.id;
          if (target.classList.contains('approve-purchase-btn')) {
              const purchase = currentWorkingDbData.user_purchased_plans.find(p => p.id === purchaseId);
              const plan = currentWorkingDbData.mining_plans.find(p => p.id === purchase.plan_id);
              if (purchase && plan) {
                  purchase.status = 'active';
                  purchase.start_date = new Date().toISOString();
                  const endDate = new Date();
                  endDate.setDate(endDate.getDate() + plan.duration_days);
                  purchase.end_date = endDate.toISOString();
                  purchase.admin_notes = `Approved by admin at ${new Date().toLocaleString()}`;
                  purchase.updated_at = new Date().toISOString();
                  alert(`Purchase ${purchaseId} approved (locally). Export DB to save.`);
                  loadPurchasesAdmin(); loadDashboardSummaryAdmin();
              }
          } else if (target.classList.contains('reject-purchase-btn')) {
              const purchase = currentWorkingDbData.user_purchased_plans.find(p => p.id === purchaseId);
              if (purchase) {
                  const reason = prompt("Reason for rejection (optional):", "Payment not confirmed");
                  purchase.status = 'rejected_payment';
                  purchase.admin_notes = `Rejected by admin: ${reason || 'N/A'} at ${new Date().toLocaleString()}`;
                  purchase.updated_at = new Date().toISOString();
                  alert(`Purchase ${purchaseId} rejected (locally). Export DB to save.`);
                  loadPurchasesAdmin(); loadDashboardSummaryAdmin();
              }
          } else if (target.classList.contains('complete-purchase-btn')) {
              const purchase = currentWorkingDbData.user_purchased_plans.find(p => p.id === purchaseId);
              if (purchase) {
                  purchase.status = 'completed';
                  purchase.admin_notes += ` | Marked completed by admin at ${new Date().toLocaleString()}`;
                  purchase.updated_at = new Date().toISOString();
                  alert(`Purchase ${purchaseId} marked completed (locally). Export DB to save.`);
                  loadPurchasesAdmin();
              }
          } else if (target.classList.contains('approve-withdrawal-btn')) {
              const withdrawal = currentWorkingDbData.withdrawal_requests.find(w => w.id === purchaseId); // purchaseId is generic data-id
              const user = currentWorkingDbData.users.find(u => u.id === withdrawal.user_id);
              if (withdrawal && user) {
                  if (parseFloat(user.balance || 0) < parseFloat(withdrawal.amount)) {
                      alert(`User ${user.email} has insufficient balance (${user.balance || 0}) for withdrawal of ${withdrawal.amount}. Rejecting.`);
                      withdrawal.status = 'rejected';
                      withdrawal.admin_notes = `Rejected due to insufficient balance at time of approval. Admin: ${new Date().toLocaleString()}`;
                  } else {
                      user.balance = (parseFloat(user.balance || 0) - parseFloat(withdrawal.amount));
                      withdrawal.status = 'approved';
                      withdrawal.admin_notes = `Approved by admin at ${new Date().toLocaleString()}. User balance updated.`;
                  }
                  withdrawal.updated_at = new Date().toISOString();
                  alert(`Withdrawal ${withdrawal.id} status updated to ${withdrawal.status} (locally). User balance: ${user.balance}. Export DB to save.`);
                  loadWithdrawalsAdmin(); loadUsersAdmin(); loadDashboardSummaryAdmin();
              }
          } else if (target.classList.contains('reject-withdrawal-btn')) {
             const withdrawal = currentWorkingDbData.withdrawal_requests.find(w => w.id === purchaseId);
              if (withdrawal) {
                  const reason = prompt("Reason for rejection (optional):", "");
                  withdrawal.status = 'rejected';
                  withdrawal.admin_notes = `Rejected by admin: ${reason || 'N/A'} at ${new Date().toLocaleString()}`;
                  withdrawal.updated_at = new Date().toISOString();
                  alert(`Withdrawal ${withdrawal.id} rejected (locally). Export DB to save.`);
                  loadWithdrawalsAdmin(); loadDashboardSummaryAdmin();
              }
          } else if (target.classList.contains('process-withdrawal-btn')) {
              const withdrawal = currentWorkingDbData.withdrawal_requests.find(w => w.id === purchaseId);
              if(withdrawal) { withdrawal.status = 'processing'; withdrawal.updated_at = new Date().toISOString(); loadWithdrawalsAdmin(); }
          } else if (target.classList.contains('complete-withdrawal-btn')) {
              const withdrawal = currentWorkingDbData.withdrawal_requests.find(w => w.id === purchaseId);
              if(withdrawal) { withdrawal.status = 'completed'; withdrawal.processed_at = new Date().toISOString(); withdrawal.updated_at = new Date().toISOString(); loadWithdrawalsAdmin(); }
          }
      });

      // Mining Plans Management
      function loadMiningPlansAdmin() {
          miningPlansListAdminEl.innerHTML = '<h3>Existing Plans</h3>';
          if (currentWorkingDbData.mining_plans.length === 0) {
              miningPlansListAdminEl.innerHTML += '<p>No mining plans created yet.</p>'; return;
          }
          currentWorkingDbData.mining_plans.forEach(plan => {
              const planItem = document.createElement('div');
              planItem.className = 'plan-item'; // Add a class for styling if needed
              planItem.style.cssText = "display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;";
              planItem.innerHTML = `
                  <div><strong>${plan.name}</strong> (Price: ${plan.price}, Active: ${plan.is_active})</div>
                  <div>
                      <button class="admin-button-warning edit-plan-btn" data-plan-id="${plan.id}"><i data-lucide="edit"></i> Edit</button>
                      <button class="admin-button-danger delete-plan-btn" data-plan-id="${plan.id}"><i data-lucide="trash"></i> Delete</button>
                  </div>`;
              miningPlansListAdminEl.appendChild(planItem);
          });
          if(window.lucide) lucide.createIcons();

          miningPlansListAdminEl.querySelectorAll('.edit-plan-btn').forEach(btn => btn.addEventListener('click', (e) => {
              const plan = currentWorkingDbData.mining_plans.find(p => p.id === e.currentTarget.dataset.planId);
              populatePlanFormAdmin(plan);
          }));
          miningPlansListAdminEl.querySelectorAll('.delete-plan-btn').forEach(btn => btn.addEventListener('click', (e) => {
              if (!confirm("Are you sure you want to delete this plan (locally)? Export DB to make permanent.")) return;
              currentWorkingDbData.mining_plans = currentWorkingDbData.mining_plans.filter(p => p.id !== e.currentTarget.dataset.planId);
              loadMiningPlansAdmin();
          }));
      }

      addNewPlanButtonEl.addEventListener('click', () => {
          addEditPlanFormEl.reset(); planIdAdminInputEl.value = '';
          planFormTitleEl.textContent = 'Add New Plan';
          addEditPlanFormContainerEl.style.display = 'block';
          savePlanButtonEl.textContent = 'Create Plan (Locally)';
      });
      cancelPlanButtonEl.addEventListener('click', () => { addEditPlanFormContainerEl.style.display = 'none'; });

      addEditPlanFormEl.addEventListener('submit', (e) => {
          e.preventDefault();
          const planData = {
              id: planIdAdminInputEl.value || generateSimpleIdAdmin("plan-"),
              name: document.getElementById('plan-name-admin').value,
              price: parseFloat(document.getElementById('plan-price-admin').value),
              duration_days: parseInt(document.getElementById('plan-duration-admin').value),
              total_return_multiplier: parseFloat(document.getElementById('plan-return-multiplier-admin').value),
              power_output_per_second: parseFloat(document.getElementById('plan-power-admin').value),
              description: document.getElementById('plan-description-admin').value,
              is_active: document.getElementById('plan-active-admin').checked,
              created_at: planIdAdminInputEl.value ? currentWorkingDbData.mining_plans.find(p=>p.id === planIdAdminInputEl.value).created_at : new Date().toISOString(),
              updated_at: new Date().toISOString()
          };
          if (planIdAdminInputEl.value) { // Editing
              const index = currentWorkingDbData.mining_plans.findIndex(p => p.id === planData.id);
              currentWorkingDbData.mining_plans[index] = planData;
          } else { // Adding
              currentWorkingDbData.mining_plans.push(planData);
          }
          alert(`Plan ${planData.name} ${planIdAdminInputEl.value ? 'updated' : 'added'} (locally). Export DB to save.`);
          addEditPlanFormContainerEl.style.display = 'none';
          loadMiningPlansAdmin();
      });

      function populatePlanFormAdmin(plan) {
          planIdAdminInputEl.value = plan.id;
          document.getElementById('plan-name-admin').value = plan.name;
          document.getElementById('plan-price-admin').value = plan.price;
          document.getElementById('plan-duration-admin').value = plan.duration_days;
          document.getElementById('plan-return-multiplier-admin').value = plan.total_return_multiplier;
          document.getElementById('plan-power-admin').value = plan.power_output_per_second;
          document.getElementById('plan-description-admin').value = plan.description || '';
          document.getElementById('plan-active-admin').checked = plan.is_active;
          planFormTitleEl.textContent = 'Edit Plan';
          addEditPlanFormContainerEl.style.display = 'block';
          savePlanButtonEl.textContent = 'Update Plan (Locally)';
      }
      
      // Admin Settings Management
      function loadCurrentAdminSettingsAdmin() {
          settingPaymentPhoneInputEl.value = currentWorkingDbData.admin_settings.payment_phone_number || '';
          settingAdminPasswordInputEl.value = ''; // Don't show current password
      }
      adminSettingsFormEl.addEventListener('submit', (e) => {
          e.preventDefault();
          currentWorkingDbData.admin_settings.payment_phone_number = settingPaymentPhoneInputEl.value.trim();
          const newAdminPass = settingAdminPasswordInputEl.value.trim();
          if (newAdminPass) {
              currentWorkingDbData.admin_settings.admin_panel_password = newAdminPass;
              alert("Admin panel password updated for current session's data. Export DB and update database.js to make it permanent for next login.");
          }
          currentWorkingDbData._meta.last_manual_update = new Date().toISOString(); // Track change
          showAdminSettingsMessage("Settings updated (locally). Export DB to save.", false);
      });


      // Initial check for admin session
      if (sessionStorage.getItem('mmk_admin_logged_in') === 'true') {
          adminLoggedIn = true;
          adminLoginSectionEl.style.display = 'none';
          adminMainContentEl.style.display = 'flex';
          adminLogoutButtonEl.style.display = 'inline-block';
          exportDbButtonEl.style.display = 'inline-block';
          showAdminSection(localStorage.getItem('mmk_admin_last_section_static') || 'dashboard-summary');
      } else {
          adminLoginSectionEl.style.display = 'block';
          adminMainContentEl.style.display = 'none';
      }
      if (window.lucide) window.lucide.createIcons();
  </script>
</body>
</html>
