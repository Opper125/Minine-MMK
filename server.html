<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - MMK Mining</title>
  <script src="https://unpkg.com/lucide-static@latest/dist/lucide.min.js"></script>
  <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
      :root {
          --admin-primary: #007bff; /* Blue */
          --admin-secondary: #6c757d; /* Gray */
          --admin-success: #28a745; /* Green */
          --admin-danger: #dc3545; /* Red */
          --admin-warning: #ffc107; /* Yellow */
          --admin-info: #17a2b8; /* Teal */
          --admin-light: #f8f9fa; /* Light Gray */
          --admin-dark: #343a40; /* Dark Gray */
          --admin-bg: #f4f6f9; /* Background */
          --admin-text: #212529; /* Body text */
          --admin-surface: #ffffff; /* Card backgrounds */
          --admin-border: #dee2e6; /* Borders */
          --admin-font: 'Roboto', sans-serif;
      }
      body {
          font-family: var(--admin-font);
          margin: 0;
          background-color: var(--admin-bg);
          color: var(--admin-text);
          font-size: 15px;
          line-height: 1.5;
      }
      #admin-app header {
          background-color: var(--admin-dark);
          color: white;
          padding: 15px 25px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      #admin-app header h1 { margin: 0; font-size: 1.6em; font-weight: 500; }
      #admin-logout-button { background-color: var(--admin-danger); color:white; border:none; padding: 8px 15px; cursor:pointer; border-radius:4px; font-size:0.9em;}
      #admin-logout-button:hover { background-color: #c82333; }

      #admin-login-section {
          width: 100%;
          max-width: 380px;
          margin: 60px auto;
          padding: 30px;
          background-color: var(--admin-surface);
          border-radius: 6px;
          box-shadow: 0 0 15px rgba(0,0,0,0.1);
      }
      #admin-login-section h2 { text-align: center; margin-bottom: 25px; color: var(--admin-dark); font-weight:500; }
      .admin-form-group { margin-bottom: 18px; }
      .admin-form-group label { display:block; margin-bottom:6px; font-weight:500; }
      .admin-form-group input { width: 100%; padding: 10px 12px; border: 1px solid var(--admin-border); border-radius: 4px; box-sizing: border-box; font-size:1em;}
      .admin-form-group input:focus { border-color: var(--admin-primary); outline:none; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
      .admin-button-primary { width: 100%; padding: 10px 15px; background-color: var(--admin-primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size:1.05em; font-weight:500;}
      .admin-button-primary:hover { background-color: #0056b3; }
      #admin-login-message { margin-top:15px; text-align:center; color: var(--admin-danger); }


      #admin-main-content { display: flex; min-height: calc(100vh - 67px); /* Header height */ }
      #admin-main-content nav {
          width: 230px;
          background-color: var(--admin-dark);
          padding: 20px 0;
          color: #adb5bd; /* Lighter text for dark sidebar */
      }
      #admin-main-content nav button {
          display: flex;
          align-items: center;
          gap: 10px;
          width: 100%;
          padding: 12px 20px;
          background-color: transparent;
          color: #adb5bd;
          border: none;
          text-align: left;
          cursor: pointer;
          font-size: 1em;
          transition: background-color 0.2s, color 0.2s;
      }
      #admin-main-content nav button i { width:18px; height:18px; }
      #admin-main-content nav button:hover, #admin-main-content nav button.active {
          background-color: var(--admin-primary);
          color: white;
      }

      .admin-content-section {
          flex-grow: 1;
          padding: 25px;
          background-color: var(--admin-bg);
      }
      .admin-content-section h2 {
          margin-top: 0;
          color: var(--admin-dark);
          border-bottom: 1px solid var(--admin-border);
          padding-bottom:15px;
          margin-bottom:25px;
          font-size: 1.8em;
          font-weight: 500;
      }
      .admin-card {
          background-color: var(--admin-surface);
          padding: 20px;
          border-radius: 5px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          margin-bottom: 25px;
      }
      .admin-card h3 { margin-top:0; font-size:1.2em; color: var(--admin-primary); }

      .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom:25px;}
      .stat-card {
          background-color: var(--admin-surface);
          padding: 20px;
          border-radius: 5px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          text-align: center;
      }
      .stat-card .stat-value { font-size: 2em; font-weight: bold; color: var(--admin-primary); display:block; margin-bottom:5px;}
      .stat-card .stat-label { font-size: 0.95em; color: var(--admin-secondary); }


      .admin-table-wrapper { overflow-x: auto; }
      table.admin-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 20px;
          background-color: var(--admin-surface);
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      .admin-table th, .admin-table td {
          border: 1px solid var(--admin-border);
          padding: 10px 12px;
          text-align: left;
          vertical-align: middle;
      }
      .admin-table th { background-color: var(--admin-light); font-weight: 500; }
      .admin-table td button, .admin-table a.admin-button {
          margin-right: 5px;
          padding: 6px 10px;
          cursor:pointer;
          border-radius:4px;
          border:1px solid transparent;
          font-size:0.85em;
          text-decoration: none;
          display:inline-flex; align-items:center; gap: 4px;
      }
      .admin-table td button i, .admin-table a.admin-button i { width:14px; height:14px;}
      .admin-button-success { background-color: var(--admin-success); color:white; border-color:var(--admin-success);}
      .admin-button-success:hover { background-color: #1e7e34;}
      .admin-button-danger { background-color: var(--admin-danger); color:white; border-color:var(--admin-danger);}
      .admin-button-danger:hover { background-color: #bd2130;}
      .admin-button-warning { background-color: var(--admin-warning); color:var(--admin-text); border-color:var(--admin-warning);}
      .admin-button-warning:hover { background-color: #e0a800;}
      .admin-button-info { background-color: var(--admin-info); color:white; border-color:var(--admin-info);}
      .admin-button-info:hover { background-color: #117a8b;}
      .admin-button-secondary { background-color: var(--admin-secondary); color:white; border-color:var(--admin-secondary);}
      .admin-button-secondary:hover { background-color: #545b62;}


      #add-edit-plan-form, #admin-settings-form {
          max-width: 700px;
      }
      #add-edit-plan-form .admin-form-group, #admin-settings-form .admin-form-group {
          margin-bottom: 15px;
      }
      #add-edit-plan-form textarea { min-height: 80px; }
      #add-edit-plan-form .form-actions button { margin-right:10px; }
      .admin-filter-bar { margin-bottom: 20px; display: flex; gap: 15px; align-items: center; }
      .admin-filter-bar input, .admin-filter-bar select {
          padding: 8px 10px;
          border: 1px solid var(--admin-border);
          border-radius: 4px;
          font-size: 0.95em;
      }
      .admin-filter-bar input { flex-grow: 1; max-width: 300px; }

      .status-badge {
          padding: 4px 8px;
          border-radius: 10px;
          font-size: 0.8em;
          font-weight: 500;
          color: white;
          display: inline-block;
      }
      .status-pending_payment, .status-pending_approval, .status-pending-payment, .status-pending-approval { background-color: var(--admin-warning); color: var(--admin-text); }
      .status-active, .status-approved { background-color: var(--admin-success); }
      .status-completed, .status-processing { background-color: var(--admin-info); }
      .status-rejected_payment, .status-rejected, .status-rejected-payment { background-color: var(--admin-danger); }
      .status-expired { background-color: var(--admin-secondary); }

      #mining-plans-list-admin .plan-item {
          background-color: var(--admin-light);
          padding: 15px;
          border: 1px solid var(--admin-border);
          border-radius: 4px;
          margin-bottom: 10px;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }
      #mining-plans-list-admin .plan-details { font-size: 0.95em; }
      #mining-plans-list-admin .plan-actions button { margin-left: 10px; }
  </style>
</head>
<body>
  <div id="admin-app">
      <header>
          <h1><i data-lucide="shield-check" style="vertical-align: middle; margin-right:10px;"></i>Admin Dashboard</h1>
          <button id="admin-logout-button" style="display:none;"><i data-lucide="log-out" style="width:16px; height:16px; vertical-align: middle; margin-right:5px;"></i>Logout</button>
      </header>

      <section id="admin-login-section">
          <h2>Admin Login</h2>
          <form id="admin-login-form">
              <div class="admin-form-group">
                  <label for="admin-email">Email</label>
                  <input type="email" id="admin-email" value="admin@example.com" required>
              </div>
              <div class="admin-form-group">
                  <label for="admin-password">Password</label>
                  <input type="password" id="admin-password" value="adminpassword" required>
              </div>
              <button type="submit" class="admin-button-primary">Login</button>
          </form>
          <p id="admin-login-message" style="display:none;"></p>
      </section>

      <main id="admin-main-content" style="display:none;">
          <nav>
              <button data-section="dashboard-summary" class="active"><i data-lucide="layout-dashboard"></i> Dashboard</button>
              <button data-section="manage-users"><i data-lucide="users"></i> Users</button>
              <button data-section="manage-purchases"><i data-lucide="shopping-bag"></i> Purchases</button>
              <button data-section="manage-withdrawals"><i data-lucide="arrow-down-left-from-circle"></i> Withdrawals</button>
              <button data-section="manage-plans"><i data-lucide="server"></i> Mining Plans</button>
              <button data-section="admin-settings"><i data-lucide="settings"></i> Settings</button>
          </nav>

          <div class="admin-content-section" id="dashboard-summary-section">
              <h2>Dashboard Summary</h2>
              <div class="stats-grid">
                  <div class="stat-card"><span id="total-users-stat" class="stat-value">0</span><span class="stat-label">Total Users</span></div>
                  <div class="stat-card"><span id="active-plans-stat" class="stat-value">0</span><span class="stat-label">Active User Plans</span></div>
                  <div class="stat-card"><span id="pending-purchases-stat" class="stat-value">0</span><span class="stat-label">Pending Purchases</span></div>
                  <div class="stat-card"><span id="pending-withdrawals-stat" class="stat-value">0</span><span class="stat-label">Pending Withdrawals</span></div>
              </div>
          </div>

          <div class="admin-content-section" id="manage-users-section" style="display:none;">
              <h2>Manage Users</h2>
              <div class="admin-filter-bar">
                  <input type="text" id="search-user-input" placeholder="Search by name or email...">
              </div>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="users-table">
                      <thead><tr><th>Name</th><th>Email</th><th>Balance (MMK)</th><th>Is Admin?</th><th>Joined</th><th>Actions</th></tr></thead>
                      <tbody><!-- User data here --></tbody>
                  </table>
              </div>
          </div>

          <div class="admin-content-section" id="manage-purchases-section" style="display:none;">
              <h2>Manage Purchase Orders</h2>
               <div class="admin-filter-bar">
                  <select id="filter-purchase-status">
                      <option value="">All Statuses</option>
                      <option value="pending_payment">Pending Payment</option>
                      <option value="active">Active</option>
                      <option value="rejected_payment">Rejected</option>
                      <option value="completed">Completed</option>
                      <option value="expired">Expired</option>
                  </select>
              </div>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="purchases-table">
                      <thead><tr><th>User Email</th><th>Plan Name</th><th>Price</th><th>Receipt</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                      <tbody><!-- Purchase data here --></tbody>
                  </table>
              </div>
          </div>

          <div class="admin-content-section" id="manage-withdrawals-section" style="display:none;">
              <h2>Manage Withdrawal Requests</h2>
              <div class="admin-filter-bar">
                   <select id="filter-withdrawal-status">
                      <option value="">All Statuses</option>
                      <option value="pending_approval">Pending Approval</option>
                      <option value="approved">Approved</option>
                      <option value="processing">Processing</option>
                      <option value="completed">Completed</option>
                      <option value="rejected">Rejected</option>
                  </select>
              </div>
              <div class="admin-table-wrapper">
                  <table class="admin-table" id="withdrawals-table">
                      <thead><tr><th>User Email</th><th>Amount</th><th>Method</th><th>Phone</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead>
                      <tbody><!-- Withdrawal data here --></tbody>
                  </table>
              </div>
          </div>

          <div class="admin-content-section" id="manage-plans-section" style="display:none;">
              <h2>Manage Mining Plans</h2>
              <button id="add-new-plan-button" class="admin-button-primary" style="margin-bottom:20px; width:auto;"><i data-lucide="plus-circle"></i> Add New Plan</button>
              
              <div id="add-edit-plan-form-container" class="admin-card" style="display:none;">
                  <h3 id="plan-form-title">Add New Plan</h3>
                  <form id="add-edit-plan-form">
                      <input type="hidden" id="plan-id-admin">
                      <div class="admin-form-group"><label for="plan-name-admin">Name:</label><input type="text" id="plan-name-admin" required></div>
                      <div class="admin-form-group"><label for="plan-price-admin">Price (MMK):</label><input type="number" step="1000" id="plan-price-admin" required></div>
                      <div class="admin-form-group"><label for="plan-duration-admin">Duration (Days):</label><input type="number" id="plan-duration-admin" required></div>
                      <div class="admin-form-group"><label for="plan-return-multiplier-admin">Total Return Multiplier (e.g., 1.8 for 180%):</label><input type="number" step="0.01" id="plan-return-multiplier-admin" required></div>
                      <div class="admin-form-group"><label for="plan-power-admin">Power (MMK/sec):</label><input type="number" step="0.00001" id="plan-power-admin" required></div>
                      <div class="admin-form-group"><label for="plan-description-admin">Description:</label><textarea id="plan-description-admin"></textarea></div>
                      <div class="admin-form-group" style="display:flex; align-items:center;"><input type="checkbox" id="plan-active-admin" checked style="width:auto; margin-right:10px;"><label for="plan-active-admin" style="margin-bottom:0;">Active</label></div>
                      <div class="form-actions">
                          <button type="submit" id="save-plan-button" class="admin-button-success">Save Plan</button>
                          <button type="button" id="cancel-plan-button" class="admin-button-secondary">Cancel</button>
                      </div>
                  </form>
              </div>
              <div id="mining-plans-list-admin" class="admin-card">
                  <h3>Existing Plans</h3>
                  <!-- Admin list of plans with edit/delete -->
              </div>
          </div>
          
          <div class="admin-content-section" id="admin-settings-section" style="display:none;">
              <h2>Admin Settings</h2>
              <div class="admin-card">
                  <form id="admin-settings-form">
                      <div class="admin-form-group">
                          <label for="setting-payment-phone">Payment Phone Number (for KPay/Wave):</label>
                          <input type="text" id="setting-payment-phone" name="payment_phone_number">
                      </div>
                      <button type="submit" class="admin-button-primary" style="width:auto;">Save Settings</button>
                  </form>
                  <p id="admin-settings-message" style="display:none; margin-top:15px;"></p>
              </div>
          </div>
      </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
      // --- Supabase Client Initialization (Admin) ---
      const SUPABASE_URL_ADMIN = 'https://ggwwsuhnhnksphryhhjo.supabase.co';
      const SUPABASE_ANON_KEY_ADMIN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdnd3dzdWhuaG5rc3BocnloaGpvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA2MzM3ODQsImV4cCI6MjA2NjIwOTc4NH0.nZRj7cnC9jSo6CnilIlgz9193D-Vjf094H5XzPJBUxY';
      
      let supabaseAdmin; // Will be initialized after DOM content loaded

      // --- Admin State ---
      let currentAdminAuthUser = null; // Stores Supabase auth user object

      // --- DOM Elements (Admin) ---
      // (These will be assigned in DOMContentLoaded)
      let adminLoginSectionEl, adminLoginFormEl, adminLoginMessageEl, adminMainContentEl, adminLogoutButtonEl;
      let adminNavButtonsEl, adminContentSectionsEl;
      let totalUsersStatEl, activePlansStatEl, pendingPurchasesStatEl, pendingWithdrawalsStatEl;
      let usersTableBodyEl, searchUserInputEl;
      let purchasesTableBodyEl, filterPurchaseStatusEl;
      let withdrawalsTableBodyEl, filterWithdrawalStatusEl;
      let addNewPlanButtonEl, addEditPlanFormContainerEl, planFormTitleEl, addEditPlanFormEl, miningPlansListAdminEl, planIdAdminInputEl, savePlanButtonEl, cancelPlanButtonEl;
      let adminSettingsFormEl, settingPaymentPhoneInputEl, adminSettingsMessageEl;


      function assignAdminDOMElements() {
          adminLoginSectionEl = document.getElementById('admin-login-section');
          adminLoginFormEl = document.getElementById('admin-login-form');
          adminLoginMessageEl = document.getElementById('admin-login-message');
          adminMainContentEl = document.getElementById('admin-main-content');
          adminLogoutButtonEl = document.getElementById('admin-logout-button');

          adminNavButtonsEl = document.querySelectorAll('#admin-main-content nav button');
          adminContentSectionsEl = document.querySelectorAll('#admin-main-content .admin-content-section');

          totalUsersStatEl = document.getElementById('total-users-stat');
          activePlansStatEl = document.getElementById('active-plans-stat');
          pendingPurchasesStatEl = document.getElementById('pending-purchases-stat');
          pendingWithdrawalsStatEl = document.getElementById('pending-withdrawals-stat');

          usersTableBodyEl = document.querySelector('#users-table tbody');
          searchUserInputEl = document.getElementById('search-user-input');

          purchasesTableBodyEl = document.querySelector('#purchases-table tbody');
          filterPurchaseStatusEl = document.getElementById('filter-purchase-status');

          withdrawalsTableBodyEl = document.querySelector('#withdrawals-table tbody');
          filterWithdrawalStatusEl = document.getElementById('filter-withdrawal-status');
          
          addNewPlanButtonEl = document.getElementById('add-new-plan-button');
          addEditPlanFormContainerEl = document.getElementById('add-edit-plan-form-container');
          planFormTitleEl = document.getElementById('plan-form-title');
          addEditPlanFormEl = document.getElementById('add-edit-plan-form');
          miningPlansListAdminEl = document.getElementById('mining-plans-list-admin');
          planIdAdminInputEl = document.getElementById('plan-id-admin');
          savePlanButtonEl = document.getElementById('save-plan-button');
          cancelPlanButtonEl = document.getElementById('cancel-plan-button');

          adminSettingsFormEl = document.getElementById('admin-settings-form');
          settingPaymentPhoneInputEl = document.getElementById('setting-payment-phone');
          adminSettingsMessageEl = document.getElementById('admin-settings-message');
      }


      // --- Admin Utility Functions ---
      function showAdminLoginMessage(message, isError = true) {
          if (!adminLoginMessageEl) return;
          adminLoginMessageEl.textContent = message;
          adminLoginMessageEl.style.color = isError ? 'var(--admin-danger)' : 'var(--admin-success)';
          adminLoginMessageEl.style.display = 'block';
      }
      
      function showAdminSettingsMessage(message, isError = true) {
          if (!adminSettingsMessageEl) return;
          adminSettingsMessageEl.textContent = message;
          adminSettingsMessageEl.style.color = isError ? 'var(--admin-danger)' : 'var(--admin-success)';
          adminSettingsMessageEl.style.display = 'block';
          setTimeout(() => { if (adminSettingsMessageEl) adminSettingsMessageEl.style.display = 'none'; }, 3000);
      }

      function showAdminSection(sectionId) {
          if (!adminContentSectionsEl || !adminNavButtonsEl) return;
          adminContentSectionsEl.forEach(section => section.style.display = 'none');
          adminNavButtonsEl.forEach(btn => btn.classList.remove('active'));

          const targetSection = document.getElementById(sectionId + '-section');
          const targetButton = document.querySelector(`#admin-main-content nav button[data-section="${sectionId}"]`);

          if (targetSection) targetSection.style.display = 'block';
          if (targetButton) targetButton.classList.add('active');

          // Load data for the section
          if (sectionId === 'dashboard-summary') loadDashboardSummaryAdmin();
          if (sectionId === 'manage-users') loadUsersAdmin();
          if (sectionId === 'manage-purchases') loadPurchasesAdmin();
          if (sectionId === 'manage-withdrawals') loadWithdrawalsAdmin();
          if (sectionId === 'manage-plans') loadMiningPlansAdmin();
          if (sectionId === 'admin-settings') loadCurrentAdminSettingsAdmin();
          
          if (window.lucide) window.lucide.createIcons();
      }
      
      const formatDateAdmin = (dateString) => {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
      };

      // --- Admin Authentication (Using Supabase Auth) ---
      async function handleAdminLogin(e) {
          e.preventDefault();
          const email = document.getElementById('admin-email').value;
          const password = document.getElementById('admin-password').value;
          showAdminLoginMessage("Logging in...", false);

          try {
              const { data, error } = await supabaseAdmin.auth.signInWithPassword({ email, password });
              if (error) throw error;

              // Check if the logged-in user is actually an admin in our public.users table
              const { data: adminUserData, error: adminCheckError } = await supabaseAdmin
                  .from('users')
                  .select('is_admin')
                  .eq('id', data.user.id)
                  .single();

              if (adminCheckError) throw adminCheckError;

              if (!adminUserData || !adminUserData.is_admin) {
                  await supabaseAdmin.auth.signOut(); // Log them out if not an admin
                  showAdminLoginMessage("Access denied. Not an authorized admin account.");
                  return;
              }
              
              currentAdminAuthUser = data.user;
              adminLoginSectionEl.style.display = 'none';
              adminMainContentEl.style.display = 'flex';
              adminLogoutButtonEl.style.display = 'block';
              showAdminSection('dashboard-summary'); 
          } catch (error) {
              console.error("Admin login error:", error);
              showAdminLoginMessage(error.message || "Invalid admin credentials.");
          }
      }

      async function handleAdminLogout() {
          try {
              const { error } = await supabaseAdmin.auth.signOut();
              if (error) throw error;
          } catch (error) {
              console.error("Admin logout error:", error);
          } finally {
              currentAdminAuthUser = null;
              adminMainContentEl.style.display = 'none';
              adminLogoutButtonEl.style.display = 'none';
              adminLoginSectionEl.style.display = 'block';
              if (adminLoginMessageEl) adminLoginMessageEl.style.display = 'none';
          }
      }

      async function checkAdminSession() {
          const { data: { session }, error } = await supabaseAdmin.auth.getSession();
          if (error) {
              console.error("Error getting admin session:", error);
              return false;
          }
          if (session && session.user) {
               // Verify this user is an admin in our users table
              const { data: adminUserData, error: adminCheckError } = await supabaseAdmin
                  .from('users')
                  .select('is_admin')
                  .eq('id', session.user.id)
                  .single();

              if (adminCheckError || !adminUserData || !adminUserData.is_admin) {
                  await supabaseAdmin.auth.signOut().catch(console.error); // Sign out if not a valid admin
                  adminMainContentEl.style.display = 'none';
                  adminLoginSectionEl.style.display = 'block';
                  return false;
              }

              currentAdminAuthUser = session.user;
              adminLoginSectionEl.style.display = 'none';
              adminMainContentEl.style.display = 'flex';
              adminLogoutButtonEl.style.display = 'block';
              showAdminSection(localStorage.getItem('mmk_admin_last_section') || 'dashboard-summary');
              return true;
          }
          adminMainContentEl.style.display = 'none';
          adminLoginSectionEl.style.display = 'block';
          return false;
      }

      // --- Admin Navigation ---
      function setupAdminNavigation() {
          if (!adminNavButtonsEl) return;
          adminNavButtonsEl.forEach(button => {
              button.addEventListener('click', () => {
                  const sectionId = button.dataset.section;
                  localStorage.setItem('mmk_admin_last_section', sectionId);
                  showAdminSection(sectionId);
              });
          });
      }

      // --- Admin Data Loading Functions ---
      async function loadDashboardSummaryAdmin() {
          if (!totalUsersStatEl) return; // Ensure elements are ready
          try {
              const { count: userCount, error: userError } = await supabaseAdmin.from('users').select('*', { count: 'exact', head: true });
              if (userError) console.error("Error fetching user count:", userError);
              totalUsersStatEl.textContent = userCount || 0;

              const { count: activePlansCount, error: planError } = await supabaseAdmin.from('user_purchased_plans').select('*', { count: 'exact', head: true }).eq('status', 'active');
              if (planError) console.error("Error fetching active plans count:", planError);
              activePlansStatEl.textContent = activePlansCount || 0;
              
              const { count: purchaseCount, error: purchaseError } = await supabaseAdmin.from('user_purchased_plans').select('*', { count: 'exact', head: true }).eq('status', 'pending_payment');
              if (purchaseError) console.error("Error fetching pending purchases count:", purchaseError);
              pendingPurchasesStatEl.textContent = purchaseCount || 0;

              const { count: withdrawalCount, error: withdrawalError } = await supabaseAdmin.from('withdrawal_requests').select('*', { count: 'exact', head: true }).eq('status', 'pending_approval');
              if (withdrawalError) console.error("Error fetching pending withdrawals count:", withdrawalError);
              pendingWithdrawalsStatEl.textContent = withdrawalCount || 0;

          } catch (error) {
              console.error("Error loading dashboard summary:", error);
              alert("Failed to load dashboard summary.");
          }
      }

      async function loadUsersAdmin(searchTerm = '') {
          if (!usersTableBodyEl) return;
          usersTableBodyEl.innerHTML = '<tr><td colspan="6">Loading users...</td></tr>';
          try {
              let query = supabaseAdmin.from('users').select('id, name, email, balance, is_admin, created_at').order('created_at', { ascending: false });
              if (searchTerm) {
                  query = query.or(`name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);
              }
              const { data: users, error } = await query;
              if (error) throw error;

              usersTableBodyEl.innerHTML = '';
              if (users.length === 0) {
                  usersTableBodyEl.innerHTML = '<tr><td colspan="6">No users found.</td></tr>';
                  return;
              }
              users.forEach(user => {
                  const row = usersTableBodyEl.insertRow();
                  row.innerHTML = `
                      <td>${user.name}</td>
                      <td>${user.email}</td>
                      <td>${parseFloat(user.balance).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                      <td>${user.is_admin ? '<span class="status-badge status-active">Yes</span>' : 'No'}</td>
                      <td>${formatDateAdmin(user.created_at)}</td>
                      <td>
                          <button class="admin-button-info view-user-details-btn" data-user-id="${user.id}"><i data-lucide="eye"></i> Details</button>
                          ${!user.is_admin && currentAdminAuthUser.id !== user.id ? `<button class="admin-button-warning make-admin-btn" data-user-id="${user.id}"><i data-lucide="user-check"></i> Make Admin</button>`: ''}
                          ${user.is_admin && currentAdminAuthUser.id !== user.id ? `<button class="admin-button-danger remove-admin-btn" data-user-id="${user.id}"><i data-lucide="user-x"></i> Remove Admin</button>`: ''}
                      </td>
                  `;
              });
              if (window.lucide) window.lucide.createIcons();
          } catch (error) {
              console.error("Error loading users for admin:", error);
              usersTableBodyEl.innerHTML = '<tr><td colspan="6">Error loading users.</td></tr>';
          }
      }
      

      async function loadPurchasesAdmin() {
          if (!purchasesTableBodyEl || !filterPurchaseStatusEl) return;
          purchasesTableBodyEl.innerHTML = '<tr><td colspan="7">Loading purchases...</td></tr>';
          const statusFilter = filterPurchaseStatusEl.value;
          try {
              let query = supabaseAdmin
                  .from('user_purchased_plans')
                  .select(`id, purchase_price, status, created_at, payment_receipt_url, admin_notes, user_id, users (email), mining_plans (name, duration_days)`)
                  .order('created_at', { ascending: false });
              
              if (statusFilter) {
                  query = query.eq('status', statusFilter);
              }

              const { data: purchases, error } = await query;
              if (error) throw error;

              purchasesTableBodyEl.innerHTML = '';
              if (purchases.length === 0) {
                  purchasesTableBodyEl.innerHTML = '<tr><td colspan="7">No purchases found for the selected filter.</td></tr>';
                  return;
              }
              purchases.forEach(purchase => {
                  const row = purchasesTableBodyEl.insertRow();
                  const planName = purchase.mining_plans ? purchase.mining_plans.name : 'N/A';
                  const planDuration = purchase.mining_plans ? purchase.mining_plans.duration_days : 0;
                  row.innerHTML = `
                      <td>${purchase.users ? purchase.users.email : 'N/A'}</td>
                      <td>${planName}</td>
                      <td>${parseFloat(purchase.purchase_price).toLocaleString()} MMK</td>
                      <td>${purchase.payment_receipt_url ? `<a href="${purchase.payment_receipt_url}" target="_blank" rel="noopener noreferrer" class="admin-button admin-button-info"><i data-lucide="image"></i> View</a>` : 'No Receipt'}</td>
                      <td><span class="status-badge status-${purchase.status.replace('_','-')}">${purchase.status.replace('_',' ')}</span></td>
                      <td>${formatDateAdmin(purchase.created_at)}</td>
                      <td>
                          ${purchase.status === 'pending_payment' ? `
                              <button class="admin-button-success approve-purchase-btn" data-id="${purchase.id}" data-user-id="${purchase.user_id}" data-plan-duration="${planDuration}" data-purchase-price="${purchase.purchase_price}"><i data-lucide="check-circle"></i> Approve</button>
                              <button class="admin-button-danger reject-purchase-btn" data-id="${purchase.id}"><i data-lucide="x-circle"></i> Reject</button>
                          ` : (purchase.status === 'active' || purchase.status === 'completed' || purchase.status === 'expired') ? 'Processed' : 'N/A'}
                      </td>
                  `;
              });
              if (window.lucide) window.lucide.createIcons();
          } catch (error) {
              console.error("Error loading purchases for admin:", error);
              purchasesTableBodyEl.innerHTML = '<tr><td colspan="7">Error loading purchases.</td></tr>';
          }
      }
      

      async function loadWithdrawalsAdmin() {
          if (!withdrawalsTableBodyEl || !filterWithdrawalStatusEl) return;
          withdrawalsTableBodyEl.innerHTML = '<tr><td colspan="7">Loading withdrawals...</td></tr>';
          const statusFilter = filterWithdrawalStatusEl.value;
          try {
              let query = supabaseAdmin
                  .from('withdrawal_requests')
                  .select(`id, amount, payment_method, recipient_phone, status, requested_at, user_id, users (email)`)
                  .order('requested_at', { ascending: false });

              if (statusFilter) {
                  query = query.eq('status', statusFilter);
              }
              const { data: withdrawals, error } = await query;

              if (error) throw error;
              withdrawalsTableBodyEl.innerHTML = '';
              if (withdrawals.length === 0) {
                  withdrawalsTableBodyEl.innerHTML = '<tr><td colspan="7">No withdrawal requests found for the selected filter.</td></tr>';
                  return;
              }
              withdrawals.forEach(withdrawal => {
                  const row = withdrawalsTableBodyEl.insertRow();
                  row.innerHTML = `
                      <td>${withdrawal.users ? withdrawal.users.email : 'N/A'}</td>
                      <td>${parseFloat(withdrawal.amount).toLocaleString()} MMK</td>
                      <td>${withdrawal.payment_method}</td>
                      <td>${withdrawal.recipient_phone}</td>
                      <td><span class="status-badge status-${withdrawal.status.replace('_','-')}">${withdrawal.status.replace('_',' ')}</span></td>
                      <td>${formatDateAdmin(withdrawal.requested_at)}</td>
                      <td>
                          ${withdrawal.status === 'pending_approval' ? `
                              <button class="admin-button-success approve-withdrawal-btn" data-id="${withdrawal.id}" data-user-id="${withdrawal.user_id}" data-amount="${withdrawal.amount}"><i data-lucide="check-circle"></i> Approve</button>
                              <button class="admin-button-danger reject-withdrawal-btn" data-id="${withdrawal.id}"><i data-lucide="x-circle"></i> Reject</button>
                          ` : 'Processed'}
                      </td>
                  `;
              });
              if (window.lucide) window.lucide.createIcons();
          } catch (error) {
              console.error("Error loading withdrawals for admin:", error);
              withdrawalsTableBodyEl.innerHTML = '<tr><td colspan="7">Error loading withdrawals.</td></tr>';
          }
      }
      

      // --- Admin Action Handlers ---
      async function handleAdminTableActions(e) {
          const targetButton = e.target.closest('button');
          if (!targetButton) return;

          const purchaseId = targetButton.dataset.id;
          const userId = targetButton.dataset.userId; // Used for various actions
          const planDuration = parseInt(targetButton.dataset.planDuration);
          const purchasePrice = parseFloat(targetButton.dataset.purchasePrice);
          const withdrawalAmount = parseFloat(targetButton.dataset.amount);

          if (targetButton.classList.contains('approve-purchase-btn')) {
              if (!confirm("Are you sure you want to approve this purchase? This will activate the plan for the user.")) return;
              try {
                  const startDate = new Date();
                  const endDate = new Date(startDate);
                  endDate.setDate(startDate.getDate() + planDuration);

                  const { error } = await supabaseAdmin
                      .from('user_purchased_plans')
                      .update({ status: 'active', start_date: startDate.toISOString(), end_date: endDate.toISOString(), admin_notes: 'Approved by admin.' })
                      .eq('id', purchaseId);
                  if (error) throw error;
                  
                  alert("Purchase approved and activated.");
                  loadPurchasesAdmin();
                  loadDashboardSummaryAdmin();
              } catch (err) {
                  console.error("Error approving purchase:", err);
                  alert("Failed to approve purchase: " + err.message);
              }
          } else if (targetButton.classList.contains('reject-purchase-btn')) {
              const reason = prompt("Enter reason for rejection (optional):");
              if (reason === null) return; 
              if (!confirm("Are you sure you want to reject this purchase?")) return;
              try {
                  const { error } = await supabaseAdmin
                      .from('user_purchased_plans')
                      .update({ status: 'rejected_payment', admin_notes: `Rejected by admin. Reason: ${reason || 'Not specified'}` })
                      .eq('id', purchaseId);
                  if (error) throw error;
                  alert("Purchase rejected.");
                  loadPurchasesAdmin();
                  loadDashboardSummaryAdmin();
              } catch (err) {
                  console.error("Error rejecting purchase:", err);
                  alert("Failed to reject purchase: " + err.message);
              }
          } else if (targetButton.classList.contains('approve-withdrawal-btn')) {
               if (!confirm(`Approve withdrawal of ${withdrawalAmount.toLocaleString()} MMK for user ${userId}? This will deduct from their balance.`)) return;
              try {
                  const { data: userData, error: userFetchError } = await supabaseAdmin
                      .from('users').select('balance').eq('id', userId).single();
                  if (userFetchError || !userData) throw userFetchError || new Error("User not found.");

                  if (parseFloat(userData.balance) < withdrawalAmount) {
                      alert("User has insufficient balance. Rejecting withdrawal.");
                      await supabaseAdmin.from('withdrawal_requests').update({ status: 'rejected', admin_notes: 'Insufficient funds at time of admin approval.' }).eq('id', purchaseId);
                      loadWithdrawalsAdmin();
                      return;
                  }

                  const { error: balanceUpdateError } = await supabaseAdmin
                      .from('users').update({ balance: parseFloat(userData.balance) - withdrawalAmount }).eq('id', userId);
                  if (balanceUpdateError) throw balanceUpdateError;

                  const { error: withdrawalUpdateError } = await supabaseAdmin
                      .from('withdrawal_requests').update({ status: 'approved', processed_at: new Date().toISOString(), admin_notes: 'Approved by admin.' }).eq('id', purchaseId);
                  if (withdrawalUpdateError) throw withdrawalUpdateError;
                  
                  await supabaseAdmin.from('transactions').insert({
                      user_id: userId,
                      type: 'withdrawal_debit',
                      amount: -withdrawalAmount, // Negative for debit
                      description: `Withdrawal approved for ${withdrawalAmount.toLocaleString()} MMK.`,
                      related_withdrawal_id: purchaseId
                  });

                  alert("Withdrawal approved and user balance updated.");
                  loadWithdrawalsAdmin();
                  loadUsersAdmin(); 
                  loadDashboardSummaryAdmin();
              } catch (err) {
                  console.error("Error approving withdrawal:", err);
                  alert("Failed to approve withdrawal: " + err.message);
              }
          } else if (targetButton.classList.contains('reject-withdrawal-btn')) {
              const reason = prompt("Enter reason for rejection (optional):");
              if (reason === null) return;
              if (!confirm("Are you sure you want to reject this withdrawal?")) return;
              try {
                  const { error } = await supabaseAdmin
                      .from('withdrawal_requests').update({ status: 'rejected', processed_at: new Date().toISOString(), admin_notes: `Rejected by admin. Reason: ${reason || 'Not specified'}` }).eq('id', purchaseId);
                  if (error) throw error;
                  alert("Withdrawal rejected.");
                  loadWithdrawalsAdmin();
                  loadDashboardSummaryAdmin();
              } catch (err) {
                  console.error("Error rejecting withdrawal:", err);
                  alert("Failed to reject withdrawal: " + err.message);
              }
          } else if (targetButton.classList.contains('make-admin-btn')) {
              if (!confirm(`Are you sure you want to make user ID ${userId} an admin?`)) return;
              try {
                  const { error } = await supabaseAdmin.from('users').update({ is_admin: true }).eq('id', userId);
                  if (error) throw error;
                  alert('User promoted to admin.');
                  loadUsersAdmin(searchUserInputEl.value.trim());
              } catch (err) {
                  alert('Error making user admin: ' + err.message);
              }
          } else if (targetButton.classList.contains('remove-admin-btn')) {
              if (!confirm(`Are you sure you want to remove admin rights from user ID ${userId}?`)) return;
              try {
                  const { error } = await supabaseAdmin.from('users').update({ is_admin: false }).eq('id', userId);
                  if (error) throw error;
                  alert('User admin rights removed.');
                  loadUsersAdmin(searchUserInputEl.value.trim());
              } catch (err) {
                  alert('Error removing admin rights: ' + err.message);
              }
          }
      }

      // --- Manage Mining Plans (Admin) ---
      async function loadMiningPlansAdmin() {
          if (!miningPlansListAdminEl) return;
          miningPlansListAdminEl.innerHTML = '<p>Loading plans...</p>';
          try {
              const { data: plans, error } = await supabaseAdmin.from('mining_plans').select('*').order('created_at', { ascending: false });
              if (error) throw error;

              miningPlansListAdminEl.innerHTML = '<h3>Existing Plans</h3>'; // Reset header
              if (plans.length === 0) {
                  miningPlansListAdminEl.innerHTML += '<p>No mining plans created yet.</p>';
                  return;
              }
              plans.forEach(plan => {
                  const planItem = document.createElement('div');
                  planItem.className = 'plan-item';
                  planItem.innerHTML = `
                      <div class="plan-details">
                          <strong>${plan.name}</strong> (Price: ${plan.price} MMK, Duration: ${plan.duration_days} days, Active: ${plan.is_active})
                      </div>
                      <div class="plan-actions">
                          <button class="admin-button-warning edit-plan-btn" data-plan='${JSON.stringify(plan)}'><i data-lucide="edit-3"></i> Edit</button>
                          <button class="admin-button-danger delete-plan-btn" data-plan-id="${plan.id}"><i data-lucide="trash-2"></i> Delete</button>
                      </div>
                  `;
                  miningPlansListAdminEl.appendChild(planItem);
              });
              if (window.lucide) window.lucide.createIcons();

              miningPlansListAdminEl.querySelectorAll('.edit-plan-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                      const planData = JSON.parse(btn.dataset.plan);
                      populatePlanFormAdmin(planData);
                  });
              });
              miningPlansListAdminEl.querySelectorAll('.delete-plan-btn').forEach(btn => {
                  btn.addEventListener('click', async () => {
                      const planIdToDelete = btn.dataset.planId;
                      if (confirm(`Are you sure you want to delete plan ID: ${planIdToDelete}? This cannot be undone and might affect reporting if purchases are linked.`)) {
                          try {
                              const { error: deleteError } = await supabaseAdmin.from('mining_plans').delete().eq('id', planIdToDelete);
                              if (deleteError) throw deleteError;
                              alert('Plan deleted successfully.');
                              loadMiningPlansAdmin();
                          } catch (err) {
                              alert('Error deleting plan: ' + err.message + '\n(Ensure no active user purchases are linked, or handle cascades in DB schema if needed.)');
                          }
                      }
                  });
              });

          } catch (error) {
              console.error("Error loading mining plans for admin:", error);
              miningPlansListAdminEl.innerHTML = '<p>Error loading plans.</p>';
          }
      }

      function setupPlanFormListeners() {
          if (addNewPlanButtonEl) {
              addNewPlanButtonEl.addEventListener('click', () => {
                  if (addEditPlanFormEl) addEditPlanFormEl.reset();
                  if (planIdAdminInputEl) planIdAdminInputEl.value = '';
                  if (planFormTitleEl) planFormTitleEl.textContent = 'Add New Plan';
                  if (addEditPlanFormContainerEl) addEditPlanFormContainerEl.style.display = 'block';
                  if (savePlanButtonEl) savePlanButtonEl.textContent = 'Create Plan';
              });
          }
          if (cancelPlanButtonEl) {
              cancelPlanButtonEl.addEventListener('click', () => {
                  if (addEditPlanFormContainerEl) addEditPlanFormContainerEl.style.display = 'none';
                  if (addEditPlanFormEl) addEditPlanFormEl.reset();
              });
          }
          if (addEditPlanFormEl) {
              addEditPlanFormEl.addEventListener('submit', handleSavePlanForm);
          }
      }
      

      function populatePlanFormAdmin(plan) {
          if (!planIdAdminInputEl) return;
          planIdAdminInputEl.value = plan.id;
          document.getElementById('plan-name-admin').value = plan.name;
          document.getElementById('plan-price-admin').value = plan.price;
          document.getElementById('plan-duration-admin').value = plan.duration_days;
          document.getElementById('plan-return-multiplier-admin').value = plan.total_return_multiplier;
          document.getElementById('plan-power-admin').value = plan.power_output_per_second;
          document.getElementById('plan-description-admin').value = plan.description || '';
          document.getElementById('plan-active-admin').checked = plan.is_active;
          planFormTitleEl.textContent = 'Edit Plan';
          addEditPlanFormContainerEl.style.display = 'block';
          savePlanButtonEl.textContent = 'Update Plan';
      }

      async function handleSavePlanForm(e) {
          e.preventDefault();
          const planData = {
              name: document.getElementById('plan-name-admin').value,
              price: parseFloat(document.getElementById('plan-price-admin').value),
              duration_days: parseInt(document.getElementById('plan-duration-admin').value),
              total_return_multiplier: parseFloat(document.getElementById('plan-return-multiplier-admin').value),
              power_output_per_second: parseFloat(document.getElementById('plan-power-admin').value),
              description: document.getElementById('plan-description-admin').value,
              is_active: document.getElementById('plan-active-admin').checked,
              // updated_at will be set by trigger
          };

          const planId = planIdAdminInputEl.value;
          try {
              let result;
              if (planId) { // Editing existing plan
                  result = await supabaseAdmin.from('mining_plans').update(planData).eq('id', planId).select();
              } else { // Creating new plan
                  result = await supabaseAdmin.from('mining_plans').insert(planData).select();
              }
              
              if (result.error) throw result.error;

              alert(`Plan ${planId ? 'updated' : 'created'} successfully!`);
              addEditPlanFormContainerEl.style.display = 'none';
              addEditPlanFormEl.reset();
              loadMiningPlansAdmin(); // Refresh the list
          } catch (error) {
              console.error("Error saving plan:", error);
              alert("Failed to save plan: " + error.message + (error.details ? `\nDetails: ${error.details}` : ''));
          }
      }

      // Admin Settings
      async function loadCurrentAdminSettingsAdmin() {
          if (!settingPaymentPhoneInputEl) return;
          try {
              const { data, error } = await supabaseAdmin.from('admin_settings').select('value').eq('key', 'payment_phone_number').maybeSingle();
              if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows found, ok
              settingPaymentPhoneInputEl.value = data ? data.value || '' : '';
          } catch (error) {
              console.error("Error loading admin settings:", error);
              showAdminSettingsMessage("Failed to load admin settings.", true);
          }
      }

      async function handleAdminSettingsSave(e) {
          e.preventDefault();
          if (!settingPaymentPhoneInputEl) return;
          const newPhoneNumber = settingPaymentPhoneInputEl.value.trim();
          try {
              const { error } = await supabaseAdmin.from('admin_settings').upsert(
                  { key: 'payment_phone_number', value: newPhoneNumber /* updated_at by trigger */ }, 
                  { onConflict: 'key' }
              );
              if (error) throw error;
              showAdminSettingsMessage("Admin settings saved successfully!", false);
          } catch (error) {
              console.error("Error saving admin settings:", error);
              showAdminSettingsMessage("Failed to save admin settings: " + error.message, true);
          }
      }
      
      function setupAdminEventListeners() {
          if (adminLoginFormEl) adminLoginFormEl.addEventListener('submit', handleAdminLogin);
          if (adminLogoutButtonEl) adminLogoutButtonEl.addEventListener('click', handleAdminLogout);
          if (searchUserInputEl) searchUserInputEl.addEventListener('input', (e) => loadUsersAdmin(e.target.value.trim()));
          if (filterPurchaseStatusEl) filterPurchaseStatusEl.addEventListener('change', loadPurchasesAdmin);
          if (filterWithdrawalStatusEl) filterWithdrawalStatusEl.addEventListener('change', loadWithdrawalsAdmin);
          if (adminSettingsFormEl) adminSettingsFormEl.addEventListener('submit', handleAdminSettingsSave);
          
          // Event delegation for table actions
          document.addEventListener('click', handleAdminTableActions);
          
          setupPlanFormListeners();
          setupAdminNavigation();
      }

      // --- Initial Admin Load ---
      document.addEventListener('DOMContentLoaded', async () => {
          if (typeof window.supabase === 'undefined') {
              console.error("CRITICAL: Supabase library not loaded. Admin panel cannot function.");
              alert("Supabase library failed to load. Admin panel cannot function.");
              return;
          }
          supabaseAdmin = window.supabase.createClient(SUPABASE_URL_ADMIN, SUPABASE_ANON_KEY_ADMIN);
          
          assignAdminDOMElements(); // Assign DOM elements after DOM is ready
          setupAdminEventListeners(); // Setup event listeners

          await checkAdminSession();
          if (window.lucide) window.lucide.createIcons();
      });
  </script>
</body>
</html>
