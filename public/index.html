<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mining App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #f9fafb;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Custom scrollbar for menu */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Mining Animation */
        .mining-circle {
            position: relative;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: conic-gradient(from 0deg, #84cc16, #22c55e, #10b981, #06b6d4, #3b82f6, #8b5cf6, #d946ef, #ec4899, #f43f5e, #84cc16);
            animation: spin 10s linear infinite;
        }
        .mining-circle-inner {
            position: absolute;
            width: 180px;
            height: 180px;
            background-color: #1f2937;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .mining-circle-outer {
            position: absolute;
            width: 220px;
            height: 220px;
            border-radius: 50%;
            border: 2px dashed #4b5563;
            animation: spin-reverse 15s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes spin-reverse {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }
        .paused-animation {
            animation-play-state: paused;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #22c55e; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toast-icon"></span>
        <span id="toast-message"></span>
    </div>

    <!-- Auth Section -->
    <div id="auth-section" class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-lg">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="text-2xl font-bold text-center mb-6">Login</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label for="login-username" class="block mb-2 text-sm font-medium">Username</label>
                        <input type="text" id="login-username" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block mb-2 text-sm font-medium">Password</label>
                        <input type="password" id="login-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Login</button>
                </form>
                <p class="text-center text-sm mt-4">Don't have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-500 hover:underline">Sign Up</a></p>
            </div>
            <!-- Sign Up Form -->
            <div id="signup-form" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-6">Sign Up</h2>
                <form onsubmit="handleSignUp(event)">
                    <div class="mb-4">
                        <label for="signup-name" class="block mb-2 text-sm font-medium">Name</label>
                        <input type="text" id="signup-name" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-username" class="block mb-2 text-sm font-medium">Username</label>
                        <input type="text" id="signup-username" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5" required>
                    </div>
                    <div class="mb-4">
                        <label for="signup-password" class="block mb-2 text-sm font-medium">Password</label>
                        <input type="password" id="signup-password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5" minlength="6" required>
                    </div>
                    <div class="mb-6">
                        <label for="signup-pin" class="block mb-2 text-sm font-medium">Withdraw PIN (6 digits)</label>
                        <input type="password" id="signup-pin" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5" pattern="\d{6}" title="PIN must be 6 digits" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">Sign Up</button>
                </form>
                <p class="text-center text-sm mt-4">Already have an account? <a href="#" onclick="toggleAuthForms()" class="text-blue-500 hover:underline">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App Section -->
    <div id="app-section" class="hidden flex-grow flex flex-col overflow-hidden">
        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow overflow-y-auto p-4 pb-24">
            <!-- Each page content will be injected here -->
            <div id="page-mining" class="page-content"></div>
            <div id="page-history" class="page-content hidden"></div>
            <div id="page-buy-plan" class="page-content hidden"></div>
            <div id="page-tasks" class="page-content hidden"></div>
            <div id="page-profile" class="page-content hidden"></div>
            <div id="page-global-chat" class="page-content hidden"></div>
            <div id="page-support-admin" class="page-content hidden"></div>
            <div id="page-news" class="page-content hidden"></div>
            <div id="page-feed" class="page-content hidden"></div>
            <div id="page-social-video" class="page-content hidden"></div>
            <div id="page-about" class="page-content hidden"></div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 shadow-lg">
            <div id="menu-container" class="flex overflow-x-auto no-scrollbar p-2 space-x-2">
                <!-- Menu items will be injected by JS -->
            </div>
        </nav>
    </div>

    <script>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://vuecdeskfiiblejwqxfz.supabase.co'; // <-- Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1ZWNkZXNrZmlpYmxlandxeGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzc1MjksImV4cCI6MjA2ODg1MzUyOX0.CPqX0xQHNp-UzAf0t5rXSP6LQeQdffqTTx9LWJLFQ9c'; // <-- Replace with your Supabase Anon Key
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let userProfile = null;
        let activePlan = null;
        let miningInterval = null;

        // --- UI ELEMENTS ---
        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const mainContent = document.getElementById('main-content');
        const menuContainer = document.getElementById('menu-container');

        // --- MENU ITEMS ---
        const menuItems = [
            { id: 'mining', label: 'Mining', icon: 'pickaxe' },
            { id: 'history', label: 'History', icon: 'history' },
            { id: 'buy-plan', label: 'Buy Plan', icon: 'shopping-cart' },
            { id: 'tasks', label: 'Tasks', icon: 'check-square' },
            { id: 'profile', label: 'Profile', icon: 'user' },
            { id: 'global-chat', label: 'Global Chat', icon: 'globe' },
            { id: 'support-admin', label: 'Support', icon: 'message-square' },
            { id: 'news', label: 'News', icon: 'newspaper' },
            { id: 'feed', label: 'Feed', icon: 'layout-grid' },
            { id: 'social-video', label: 'Social Video', icon: 'youtube' },
            { id: 'about', label: 'About', icon: 'info' },
        ];

        // --- TOAST NOTIFICATION ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            toastMessage.textContent = message;
            toast.className = 'toast show';
            
            if (type === 'success') {
                toast.classList.add('toast-success');
                toastIcon.innerHTML = `<i data-lucide="check-circle"></i>`;
            } else if (type === 'error') {
                toast.classList.add('toast-error');
                toastIcon.innerHTML = `<i data-lucide="x-circle"></i>`;
            } else {
                toast.classList.add('toast-info');
                toastIcon.innerHTML = `<i data-lucide="info"></i>`;
            }
            lucide.createIcons();

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- AUTH FUNCTIONS ---
        function toggleAuthForms() {
            loginForm.classList.toggle('hidden');
            signupForm.classList.toggle('hidden');
        }

        async function handleSignUp(event) {
            event.preventDefault();
            const name = document.getElementById('signup-name').value;
            const username = document.getElementById('signup-username').value;
            const password = document.getElementById('signup-password').value;
            const pin = document.getElementById('signup-pin').value;

            const { data, error } = await supabase.auth.signUp({
                email: `${username}@yourapp.com`, // Using username as email prefix
                password: password,
                options: {
                    data: {
                        full_name: name,
                        username: username,
                        withdraw_pin: pin
                    }
                }
            });

            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast('Sign up successful! Please login.', 'success');
                toggleAuthForms();
                event.target.reset();
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            const { data, error } = await supabase.auth.signInWithPassword({
                email: `${username}@yourapp.com`,
                password: password,
            });

            if (error) {
                showToast(error.message, 'error');
            } else {
                showToast('Login successful!', 'success');
                currentUser = data.user;
                await initializeApp();
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            userProfile = null;
            authSection.style.display = 'flex';
            appSection.style.display = 'none';
            if(miningInterval) clearInterval(miningInterval);
        }

        // --- APP INITIALIZATION ---
        async function checkUserSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await initializeApp();
            } else {
                authSection.style.display = 'flex';
                appSection.style.display = 'none';
            }
        }

        async function initializeApp() {
            const { data, error } = await supabase
                .from('profiles')
                .select(`*, levels(*)`)
                .eq('id', currentUser.id)
                .single();

            if (error) {
                showToast('Error fetching profile.', 'error');
                handleLogout();
                return;
            }
            
            userProfile = data;

            if (userProfile.is_banned) {
                showToast('Your account has been banned.', 'error');
                mainContent.innerHTML = `
                    <div class="text-center p-8">
                        <h1 class="text-3xl font-bold text-red-500">Account Banned</h1>
                        <p class="mt-4">Please contact support for more information.</p>
                        <button onclick="handleLogout()" class="mt-8 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                    </div>
                `;
                authSection.style.display = 'none';
                appSection.style.display = 'flex';
                menuContainer.innerHTML = ''; // Clear menu
                return;
            }

            authSection.style.display = 'none';
            appSection.style.display = 'flex';
            
            renderMenu();
            navigateTo('mining');
            startRealtimeListeners();
        }

        // --- UI RENDERING ---
        function renderMenu() {
            menuContainer.innerHTML = menuItems.map(item => `
                <button onclick="navigateTo('${item.id}')" id="menu-btn-${item.id}" class="flex-1 flex flex-col items-center justify-center p-2 rounded-lg text-gray-400 hover:bg-gray-700 hover:text-white transition-colors">
                    <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                    <span class="text-xs mt-1">${item.label}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');

            document.querySelectorAll('[id^="menu-btn-"]').forEach(btn => btn.classList.remove('text-white', 'bg-gray-700'));
            document.getElementById(`menu-btn-${pageId}`).classList.add('text-white', 'bg-gray-700');

            // Load content for the page
            switch (pageId) {
                case 'mining': loadMiningPage(); break;
                case 'buy-plan': loadBuyPlanPage(); break;
                // Add other page loaders here
                case 'profile': loadProfilePage(); break;
            }
        }

        // --- PAGE LOADERS ---
        async function loadMiningPage() {
            const page = document.getElementById('page-mining');
            page.innerHTML = `
                <div class="flex flex-col items-center justify-center text-center h-full">
                    <div class="relative mb-8">
                        <div id="mining-circle-outer" class="mining-circle-outer"></div>
                        <div id="mining-circle" class="mining-circle">
                            <div class="mining-circle-inner">
                                <span class="text-3xl font-bold" id="mined-balance">0.0000 MMK</span>
                                <span class="text-sm text-gray-400" id="mining-rate">0.00000000 MMK/sec</span>
                            </div>
                        </div>
                    </div>
                    <div id="plan-status" class="text-lg">No active plan.</div>
                    <div id="plan-timer" class="text-2xl font-mono text-gray-300 mt-4"></div>
                    <div class="mt-8 w-full max-w-md">
                        <h3 class="text-xl font-semibold mb-4">Live Withdrawals</h3>
                        <div id="live-withdrawals" class="space-y-2 h-48 overflow-y-auto bg-gray-800 p-2 rounded-lg">
                           <!-- Live withdrawals will be shown here -->
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
            await checkActivePlan();
        }
        
        async function loadProfilePage() {
            const page = document.getElementById('page-profile');
            page.innerHTML = `
                <div class="p-4">
                    <div class="bg-gray-800 rounded-lg p-6 text-center">
                        <img src="/placeholder.svg?height=96&width=96" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-blue-500">
                        <h2 class="text-2xl font-bold">${userProfile.full_name}</h2>
                        <p class="text-gray-400">@${userProfile.username}</p>
                        <div class="flex items-center justify-center mt-2">
                            <span class="font-semibold">${userProfile.levels.level_name}</span>
                            <img src="${userProfile.levels.icon_url}" class="w-6 h-6 ml-2">
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-gray-400 text-sm">Main Balance</h3>
                            <p class="text-2xl font-bold">${parseFloat(userProfile.balance).toFixed(4)} MMK</p>
                        </div>
                        <div class="bg-gray-800 rounded-lg p-4">
                            <h3 class="text-gray-400 text-sm">Total Mined</h3>
                            <p class="text-2xl font-bold" id="total-mined-balance">0.00 MMK</p>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button onclick="openWithdrawModal()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Withdraw</button>
                    </div>
                     <div class="mt-6">
                        <button onclick="handleLogout()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg">Logout</button>
                    </div>
                </div>
            `;
        }

        async function loadBuyPlanPage() {
            const page = document.getElementById('page-buy-plan');
            page.innerHTML = `<div class="text-center">Loading plans...</div>`;

            const { data: plans, error } = await supabase.from('plans').select('*').order('price');
            if (error) {
                page.innerHTML = `<div class="text-red-500">Error loading plans.</div>`;
                return;
            }

            page.innerHTML = `
                <h1 class="text-2xl font-bold mb-6">Buy a Plan</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${plans.map(plan => `
                        <div class="bg-gray-800 rounded-lg p-6 flex flex-col">
                            <img src="${plan.image_url || '/placeholder.svg?height=150&width=250'}" class="rounded-md mb-4 h-32 object-cover">
                            <h2 class="text-xl font-bold">${plan.name}</h2>
                            <p class="text-gray-400 text-sm mt-1">Duration: ${plan.duration_days} days</p>
                            <div class="my-4 space-y-2 text-left">
                                <p><strong>Price:</strong> ${plan.price} MMK</p>
                                <p><strong>Total Return:</strong> ${plan.total_return} MMK</p>
                                <p><strong>Profit:</strong> ${plan.total_return - plan.price} MMK</p>
                                <p class="text-green-400"><strong>Rate:</strong> ${parseFloat(plan.mmk_per_second).toFixed(8)} MMK/sec</p>
                            </div>
                            <button onclick="openPurchaseModal(${plan.id})" class="mt-auto w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Buy Now</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // --- MINING LOGIC ---
        async function checkActivePlan() {
            const { data, error } = await supabase
                .from('user_plans')
                .select(`*, plans(*)`)
                .eq('user_id', currentUser.id)
                .eq('status', 'active')
                .single();

            const miningCircle = document.getElementById('mining-circle');
            const miningCircleOuter = document.getElementById('mining-circle-outer');
            const planStatus = document.getElementById('plan-status');
            const miningRate = document.getElementById('mining-rate');

            if (data) {
                activePlan = data;
                planStatus.textContent = `Active Plan: ${activePlan.plans.name}`;
                miningRate.textContent = `${parseFloat(activePlan.plans.mmk_per_second).toFixed(8)} MMK/sec`;
                miningCircle.classList.remove('paused-animation');
                miningCircleOuter.classList.remove('paused-animation');
                startMining();
            } else {
                planStatus.textContent = 'No active plan.';
                miningRate.textContent = '0.00000000 MMK/sec';
                if (miningCircle) miningCircle.classList.add('paused-animation');
                if (miningCircleOuter) miningCircleOuter.classList.add('paused-animation');
            }
        }

        function startMining() {
            if (miningInterval) clearInterval(miningInterval);
            
            const minedBalanceEl = document.getElementById('mined-balance');
            const planTimerEl = document.getElementById('plan-timer');

            miningInterval = setInterval(async () => {
                if (!activePlan) {
                    clearInterval(miningInterval);
                    return;
                }

                const now = new Date();
                const startTime = new Date(activePlan.start_time);
                const endTime = new Date(activePlan.end_time);

                if (now >= endTime) {
                    // Plan completed
                    clearInterval(miningInterval);
                    planTimerEl.textContent = "Plan Completed";
                    await supabase.from('user_plans').update({ status: 'completed' }).eq('id', activePlan.id);
                    activePlan = null;
                    await checkActivePlan();
                    return;
                }

                const elapsedSeconds = (now - startTime) / 1000;
                const totalMined = elapsedSeconds * activePlan.plans.mmk_per_second;
                
                minedBalanceEl.textContent = `${totalMined.toFixed(4)} MMK`;

                // Update timer
                const remainingMs = endTime - now;
                const remainingSeconds = Math.floor((remainingMs / 1000) % 60);
                const remainingMinutes = Math.floor((remainingMs / (1000 * 60)) % 60);
                const remainingHours = Math.floor((remainingMs / (1000 * 60 * 60)) % 24);
                const remainingDays = Math.floor(remainingMs / (1000 * 60 * 60 * 24));
                planTimerEl.textContent = `${remainingDays}d ${remainingHours}h ${remainingMinutes}m ${remainingSeconds}s`;

            }, 1000);
        }
        
        // This function should be called periodically to sync balance with the server
        async function syncBalance() {
            // This is a complex operation. For a static site, the most reliable way is to have a serverless function.
            // As a simplified client-side approach, we can calculate and update.
            // In a real app, a Supabase Edge Function would run periodically to update balances.
            if (!activePlan) return;
            
            const now = new Date();
            const startTime = new Date(activePlan.start_time);
            const elapsedSeconds = (now - startTime) / 1000;
            const minedAmount = elapsedSeconds * activePlan.plans.mmk_per_second;
            
            // This is where we would update the user's main balance.
            // For security, this should be a call to a trusted Edge Function.
            // const { error } = await supabase.rpc('update_mined_balance', { amount_to_add: minedAmount });
        }


        // --- REALTIME LISTENERS ---
        function startRealtimeListeners() {
            // Listen for profile changes (e.g., balance updates, ban status)
            supabase.channel(`public:profiles:id=eq.${currentUser.id}`)
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'profiles' }, payload => {
                    console.log('Profile updated:', payload.new);
                    userProfile = { ...userProfile, ...payload.new };
                    if (userProfile.is_banned) {
                        handleLogout();
                        showToast('Your account has been banned by an administrator.', 'error');
                    }
                    // Re-render parts of the UI if needed
                    if(document.getElementById(`page-profile`).style.display !== 'none') {
                        loadProfilePage();
                    }
                })
                .subscribe();
            
            // Listen for plan status changes
            supabase.channel(`public:user_plans:user_id=eq.${currentUser.id}`)
                .on('postgres_changes', { event: '*', schema: 'public', table: 'user_plans' }, payload => {
                    showToast('Your plan status has been updated!', 'info');
                    checkActivePlan(); // Re-check active plan on any change
                })
                .subscribe();
        }

        // --- ONLOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            checkUserSession();
        });

    </script>
</body>
</html>
