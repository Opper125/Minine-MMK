<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MMK Mining</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a1a;
            --bg-secondary: #1a1a3a;
            --bg-tertiary: #2a2a5a;
            --accent-primary: #f0b90b;
            --accent-secondary: #4c5fdc;
            --text-primary: #f5f5f5;
            --text-secondary: #a9a9a9;
            --success: #2ebd85;
            --error: #f6465d;
            --warning: #ffc107;
            --info: #17a2b8;

            --gradient-gold: linear-gradient(90deg, #f0b90b, #ffdd00);
            --gradient-blue: linear-gradient(90deg, #4c5fdc, #7a8aff);
            --gradient-green: linear-gradient(90deg, #2ebd85, #5cb85c);
            --gradient-red: linear-gradient(90deg, #f6465d, #dc3545);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            /* Disable text selection/copying */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .container {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px;
            padding-bottom: 80px;
            overflow-y: auto;
            background-color: var(--bg-primary);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            display: none;
            flex-shrink: 0;
        }
        .page.active {
            transform: translateX(0);
            display: block;
        }
        .page::-webkit-scrollbar { width: 8px; }
        .page::-webkit-scrollbar-track { background: var(--bg-primary); }
        .page::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 10px; border: 2px solid var(--bg-primary); }

        #page-auth {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            padding-bottom: 20px;
            background: var(--bg-primary) url('https://vuecdeskfiiblejwqxfz.supabase.co/storage/v1/object/public/news_images/auth_bg.jpg') no-repeat center center/cover;
            position: relative;
            overflow: hidden;
        }
        #page-auth::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
            z-index: 1;
        }
        .auth-form {
            width: 100%;
            max-width: 380px;
            background: rgba(26,26,58,0.8);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 2;
            animation: fadeInScale 0.6s ease-out;
        }
        .auth-form h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--accent-primary);
            font-size: 28px;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(240,185,11,0.5);
        }
        .input-group {
            position: relative;
            margin-bottom: 20px;
        }
        .input-group input {
            width: 100%;
            padding: 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: var(--accent-secondary);
            box-shadow: 0 0 0 3px rgba(76,95,220,0.3);
        }
        .auth-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(76,95,220,0.4);
        }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,95,220,0.5); }
        .auth-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(76,95,220,0.3); }
        .auth-btn:disabled {
            background: #3a3a6a;
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: none;
        }
        .toggle-auth {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        .toggle-auth span {
            color: var(--accent-primary);
            cursor: pointer;
            font-weight: 600;
            transition: color 0.3s;
        }
        .toggle-auth span:hover { color: #ffdd00; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--bg-secondary);
            padding: 10px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            z-index: 100;
        }
        .bottom-nav::-webkit-scrollbar { display: none; }
        .nav-menu {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 0 10px;
            min-width: fit-content;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            padding: 5px 15px;
            cursor: pointer;
            transition: color 0.3s, transform 0.3s, background-color 0.3s;
            flex-shrink: 0;
            border-radius: 10px;
            min-width: 80px;
        }
        .nav-item.active {
            color: var(--accent-primary);
            transform: translateY(-5px);
            background-color: rgba(240,185,11,0.1);
        }
        .nav-item i {
            font-size: 24px;
            margin-bottom: 4px;
        }
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        .overlay-content {
            text-align: center;
            animation: fadeInScale 0.5s ease-out;
        }
        #lottie-animation { width: 150px; height: 150px; margin: 0 auto; }
        .overlay-message {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
        .toast-message {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(-10px);
        }
        .toast-message.success { background: var(--gradient-green); }
        .toast-message.error { background: var(--gradient-red); }
        .toast-message.info { background: var(--gradient-blue); }
        .toast-message.warning { background: var(--gradient-gold); }

        .card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--bg-tertiary);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .card-title { font-size: 20px; font-weight: 600; color: var(--accent-primary); }
        .card-description { font-size: 14px; color: var(--text-secondary); margin-top: 5px; }
        .card-content { font-size: 14px; color: var(--text-primary); }

        #page-mining .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding-top: 20px;
        }
        .mining-circle-container {
            position: relative;
            width: 280px;
            height: 280px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
        }
        .mining-circle {
            position: absolute;
            border-radius: 50%;
            border: 3px solid;
        }
        .outer-circle {
            width: 100%;
            height: 100%;
            border-color: transparent var(--accent-secondary) transparent var(--accent-secondary);
            animation: spin 10s linear infinite;
        }
        .inner-circle {
            width: 80%;
            height: 80%;
            border-color: var(--accent-primary) transparent var(--accent-primary) transparent;
            animation: spin-reverse 8s linear infinite;
        }
        .mining-info {
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: pulse 2s infinite alternate;
        }
        .mining-info h3 {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        .mining-info p {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-primary);
            text-shadow: 0 0 10px rgba(240,185,11,0.5);
        }
        .countdown-timer {
            margin-top: 30px;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideInUp 0.6s ease-out;
        }
        .timer-segment { text-align: center; }
        .timer-segment .value { font-size: 24px; font-weight: 600; color: var(--accent-secondary); }
        .timer-segment .label { font-size: 12px; color: var(--text-secondary); }
        .live-feed-card {
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.6s ease-out;
        }
        .live-feed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .live-feed-item:last-child { border-bottom: none; }
        .live-feed-item .amount { font-weight: 600; color: var(--success); }
        .live-feed-item .username { font-weight: 500; color: var(--accent-primary); }
        .live-feed-item .status { font-size: 12px; color: var(--text-secondary); }
        .live-feed-item .method { font-size: 12px; color: var(--info); }
        .top-withdrawal-card {
            width: 100%;
            max-width: 400px;
            margin-top: 20px;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: fadeIn 0.6s ease-out;
        }
        .top-withdrawal-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .top-withdrawal-item:last-child { border-bottom: none; }
        .top-withdrawal-item .rank { font-size: 20px; font-weight: 700; color: var(--accent-primary); }
        .top-withdrawal-item .username { font-weight: 600; color: var(--text-primary); }
        .top-withdrawal-item .amount { font-weight: 700; color: var(--success); }

        #page-history .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .history-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            animation: slideInRight 0.4s ease-out;
        }
        .history-item .status-badge {
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }
        .status-badge.pending { background: var(--warning); }
        .status-badge.active, .status-badge.approved { background: var(--success); }
        .status-badge.completed { background: var(--info); }
        .status-badge.rejected { background: var(--error); }

        #page-buy-plan .plan-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .plan-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            animation: fadeIn 0.5s ease-out;
        }
        .plan-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .plan-card .plan-icon { width: 60px; height: 60px; margin: 0 auto 15px; }
        .plan-card h3 { font-size: 24px; color: var(--accent-primary); margin-bottom: 10px; }
        .plan-card .cost { font-size: 20px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; }
        .plan-card .details p { font-size: 14px; color: var(--text-secondary); margin-bottom: 5px; }
        .plan-card .buy-btn {
            width: 100%;
            padding: 12px;
            background: var(--gradient-gold);
            border: none;
            border-radius: 10px;
            color: var(--bg-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(240,185,11,0.4);
        }
        .plan-card .buy-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(240,185,11,0.5); }
        .plan-card .buy-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(240,185,11,0.3); }
        .plan-card .buy-btn:disabled { background: #3a3a6a; cursor: not-allowed; opacity: 0.7; box-shadow: none; }

        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }
        .dialog-overlay.visible { opacity: 1; pointer-events: all; }
        .dialog-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 450px;
            animation: fadeInScale 0.4s ease-out;
            color: var(--text-primary);
        }
        .dialog-header { margin-bottom: 20px; text-align: center; }
        .dialog-title { font-size: 24px; font-weight: 600; color: var(--accent-primary); }
        .dialog-body { margin-bottom: 20px; }
        .dialog-body p { margin-bottom: 10px; }
        .dialog-body strong { color: var(--accent-primary); }
        .dialog-body .payment-info {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .dialog-body input[type="file"] {
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            color: var(--text-primary);
        }
        .dialog-body input[type="file"]::file-selector-button {
            background: var(--accent-secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }
        .dialog-footer { text-align: right; }
        .dialog-footer button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
        }
        .dialog-footer .submit-btn {
            background: var(--gradient-green);
            color: var(--bg-primary);
            box-shadow: 0 5px 15px rgba(46,189,133,0.4);
        }
        .dialog-footer .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(46,189,133,0.5); }
        .dialog-footer .submit-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(46,189,133,0.3); }
        .dialog-footer .submit-btn:disabled { background: #3a3a6a; cursor: not-allowed; opacity: 0.7; box-shadow: none; }

        #page-tasks .task-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .task-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        .task-card .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .task-card .task-title { font-size: 18px; font-weight: 600; color: var(--accent-primary); }
        .task-card .task-reward { font-size: 16px; font-weight: 700; color: var(--success); display: flex; align-items: center; gap: 5px; }
        .task-card .task-description { font-size: 14px; color: var(--text-secondary); margin-bottom: 15px; }
        .task-card .task-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-card .task-link {
            color: var(--accent-secondary);
            text-decoration: none;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }
        .task-card .task-link:hover { color: #7a8aff; }
        .task-card .claim-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: var(--gradient-blue);
            color: white;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(76,95,220,0.4);
        }
        .task-card .claim-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(76,95,220,0.5); }
        .task-card .claim-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(76,95,220,0.3); }
        .task-card .claim-btn:disabled { background: #3a3a6a; cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        .task-card .claimed-badge {
            background: var(--success);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        #page-profile .profile-header {
            text-align: center;
            margin-bottom: 30px;
        }
        #page-profile .profile-avatar-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid var(--accent-primary);
            box-shadow: 0 0 20px rgba(240,185,11,0.3);
        }
        #page-profile .profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #page-profile .upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: var(--accent-secondary);
            color: white;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        #page-profile .upload-btn:hover { transform: scale(1.1); }
        #page-profile .profile-name { font-size: 24px; font-weight: 700; color: var(--text-primary); }
        #page-profile .profile-username { font-size: 16px; color: var(--text-secondary); }
        #page-profile .level-display {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #page-profile .level-display .level-icon { width: 40px; height: 40px; margin-bottom: 10px; }
        #page-profile .level-display .level-name { font-size: 18px; font-weight: 600; color: var(--accent-primary); }
        #page-profile .level-display .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        #page-profile .level-display .progress-fill {
            height: 100%;
            background: var(--gradient-gold);
            border-radius: 5px;
            transition: width 0.5s ease-out;
        }
        #page-profile .level-display .progress-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        #page-profile .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        #page-profile .stat-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        #page-profile .stat-item .label { font-size: 12px; color: var(--text-secondary); }
        #page-profile .stat-item .value { font-size: 18px; font-weight: 600; color: var(--text-primary); }
        #page-profile .withdraw-form {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-top: 20px;
        }
        #page-profile .withdraw-form h3 { font-size: 20px; font-weight: 600; color: var(--accent-primary); margin-bottom: 15px; }
        #page-profile .withdraw-form input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 15px;
        }
        #page-profile .withdraw-form .withdraw-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-green);
            border: none;
            border-radius: 10px;
            color: var(--bg-primary);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(46,189,133,0.4);
        }
        #page-profile .withdraw-form .withdraw-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(46,189,133,0.5); }
        #page-profile .withdraw-form .withdraw-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(46,189,133,0.3); }
        #page-profile .withdraw-form .withdraw-btn:disabled { background: #3a3a6a; cursor: not-allowed; opacity: 0.7; box-shadow: none; }
        #page-profile .logout-btn {
            width: 100%;
            padding: 15px;
            background: var(--gradient-red);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(246,70,93,0.4);
        }
        #page-profile .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(246,70,93,0.5); }
        #page-profile .logout-btn:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(246,70,93,0.3); }

        #page-global-chat .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100% - 60px);
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #page-global-chat .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
        }
        #page-global-chat .message-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
            animation: slideInLeft 0.3s ease-out;
        }
        #page-global-chat .message-item.admin {
            justify-content: flex-end;
            animation: slideInRight 0.3s ease-out;
        }
        #page-global-chat .message-item.admin .message-bubble {
            background: var(--accent-secondary);
            color: white;
        }
        #page-global-chat .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
            flex-shrink: 0;
        }
        #page-global-chat .message-content {
            display: flex;
            flex-direction: column;
        }
        #page-global-chat .message-sender {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 14px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #page-global-chat .message-sender .level-badge {
            background: var(--accent-secondary);
            color: white;
            padding: 2px 6px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 500;
        }
        #page-global-chat .message-bubble {
            background: var(--bg-tertiary);
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        #page-global-chat .chat-input-form {
            display: flex;
            gap: 10px;
        }
        #page-global-chat .chat-input-form input {
            flex-grow: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }
        #page-global-chat .chat-input-form button {
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #page-global-chat .chat-input-form button:hover { transform: translateY(-2px); }

        #page-support-admin .support-chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100% - 60px);
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #page-support-admin .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 15px;
        }
        #page-support-admin .message-item {
            display: flex;
            margin-bottom: 15px;
        }
        #page-support-admin .message-item.user-message {
            justify-content: flex-end;
        }
        #page-support-admin .message-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 15px;
            word-wrap: break-word;
        }
        #page-support-admin .message-bubble.user-message {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }
        #page-support-admin .message-bubble.admin-message {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        #page-support-admin .chat-input-form {
            display: flex;
            gap: 10px;
        }
        #page-support-admin .chat-input-form input {
            flex-grow: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }
        #page-support-admin .chat-input-form button {
            background: var(--gradient-blue);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #page-support-admin .chat-input-form button:hover { transform: translateY(-2px); }

        #page-news .news-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .news-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        .news-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        .news-card .news-content {
            padding: 20px;
        }
        .news-card .news-title { font-size: 20px; font-weight: 600; color: var(--accent-primary); margin-bottom: 10px; }
        .news-card .news-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; }
        .news-card .news-text { font-size: 15px; color: var(--text-primary); line-height: 1.5; }
        .news-card .news-text a { color: var(--accent-secondary); text-decoration: underline; }

        #page-feed .post-form {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        #page-feed .post-form textarea {
            width: 100%;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            color: var(--text-primary);
            padding: 10px;
            min-height: 80px;
            margin-bottom: 10px;
            font-size: 16px;
        }
        #page-feed .post-form input[type="file"] {
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 10px;
            padding: 10px;
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        #page-feed .post-form input[type="file"]::file-selector-button {
            background: var(--accent-secondary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
        }
        #page-feed .post-form .upload-progress {
            font-size: 12px;
            color: var(--info);
            margin-bottom: 10px;
        }
        #page-feed .post-form button {
            width: 100%;
            padding: 12px;
            background: var(--gradient-blue);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #page-feed .post-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .post-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        .post-card .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .post-card .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
        }
        .post-card .post-username { font-weight: 600; color: var(--accent-primary); }
        .post-card .post-time { font-size: 12px; color: var(--text-secondary); }
        .post-card .post-content { font-size: 15px; color: var(--text-primary); line-height: 1.5; margin-bottom: 15px; }
        .post-card video {
            width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
            background: black;
        }
        .post-card .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-card .like-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            transition: color 0.3s;
        }
        .post-card .like-btn.liked { color: var(--error); }
        .post-card .like-btn:hover { color: var(--accent-primary); }
        .post-card .delete-btn {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            font-size: 14px;
            transition: color 0.3s;
        }
        .post-card .delete-btn:hover { color: #dc3545; }

        #page-social-video .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        .video-card {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            animation: fadeIn 0.5s ease-out;
        }
        .video-card .video-title {
            padding: 15px;
            font-size: 18px;
            font-weight: 600;
            color: var(--accent-primary);
        }
        .video-card .video-embed {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
        }
        .video-card .video-embed iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        #page-about .about-info-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .about-info-item {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: slideInRight 0.4s ease-out;
        }
        .about-info-item .icon { font-size: 24px; color: var(--accent-primary); }
        .about-info-item .text { font-size: 16px; color: var(--text-primary); }
        .about-info-item .text a { color: var(--accent-secondary); text-decoration: underline; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes spin-reverse { 100% { transform: rotate(-360deg); } }
        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 20px rgba(240,185,11,0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(240,185,11,0.6); }
            100% { transform: scale(1); box-shadow: 0 0 20px rgba(240,185,11,0.3); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        .shimmer-effect {
            background: linear-gradient(to right, var(--bg-secondary) 0%, var(--bg-tertiary) 20%, var(--bg-secondary) 40%, var(--bg-secondary) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        .banned-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            text-align: center;
            color: var(--error);
            font-size: 24px;
            font-weight: 700;
            animation: fadeIn 0.5s ease-out;
        }
        .banned-overlay .banned-message {
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(246,70,93,0.5);
        }
        .banned-overlay .logout-btn {
            background: var(--gradient-red);
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 5px 15px rgba(246,70,93,0.4);
        }
        .banned-overlay .logout-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(246,70,93,0.5); }
    </style>
</head>
<body>
    <div class="container">
        <div id="page-auth" class="page active">
            <div id="login-form" class="auth-form">
                <h2>Login</h2>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group">
                        <input type="email" id="login-email" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="login-password" placeholder="Password" required>
                    </div>
                    <button type="submit" class="auth-btn" id="login-btn">Login</button>
                </form>
                <p class="toggle-auth">Don't have an account? <span onclick="toggleAuthForm()">Sign Up</span></p>
            </div>
            <div id="signup-form" class="auth-form" style="display: none;">
                <h2>Sign Up</h2>
                <form onsubmit="handleSignUp(event)">
                    <div class="input-group">
                        <input type="text" id="signup-name" placeholder="Name" required>
                    </div>
                    <div class="input-group">
                        <input type="text" id="signup-username" placeholder="Username" required>
                    </div>
                    <div class="input-group">
                        <input type="email" id="signup-email" placeholder="Email" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="signup-password" placeholder="Password" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="signup-pin" placeholder="6-Digit Withdraw PIN" required maxlength="6" pattern="\d{6}">
                    </div>
                    <button type="submit" class="auth-btn" id="signup-btn">Create Account</button>
                </form>
                <p class="toggle-auth">Already have an account? <span onclick="toggleAuthForm()">Login</span></p>
            </div>
        </div>

        <div id="app-content" style="display: none; flex-grow: 1; display: flex; flex-direction: column;">
            <div id="page-mining" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Your Mining Dashboard</h1>
                <div class="content" style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <div class="card" style="width: 100%; max-width: 400px; text-align: center; margin-bottom: 20px;">
                        <div class="card-header">
                            <h2 class="card-title">Your Mining Stats</h2>
                        </div>
                        <div class="card-content" style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <p style="font-size: 14px; color: var(--text-secondary);">Lifetime Earnings</p>
                                <p id="lifetime-earnings" style="font-size: 28px; font-weight: 700; color: var(--success);">0.000000 MMK</p>
                            </div>
                            <div>
                                <p style="font-size: 14px; color: var(--text-secondary);">Ready to Collect</p>
                                <p id="mining-balance" style="font-size: 24px; font-weight: 700; color: var(--accent-secondary);">0.000000 MMK</p>
                            </div>
                            <button class="auth-btn" id="collect-mining-btn" style="background: var(--gradient-green); box-shadow: 0 5px 15px rgba(46,189,133,0.4);">Collect All Mining Balance</button>
                        </div>
                    </div>

                    <div class="mining-circle-container">
                        <div class="outer-circle mining-circle"></div>
                        <div class="inner-circle mining-circle"></div>
                        <div class="mining-info">
                            <h3>Current Rate</h3>
                            <p id="mining-rate">0.000000</p>
                            <p style="font-size: 12px; color: var(--accent-secondary);">MMK/sec</p>
                        </div>
                    </div>
                    <div class="countdown-timer" style="margin-top: 30px;">
                        <div class="timer-segment"><span id="days" class="value">00</span><span class="label">Days</span></div>
                        <div class="timer-segment"><span id="hours" class="value">00</span><span class="label">Hours</span></div>
                        <div class="timer-segment"><span id="minutes" class="value">00</span><span class="label">Mins</span></div>
                        <div class="timer-segment"><span id="seconds" class="value">00</span><span class="label">Secs</span></div>
                    </div>
                    <div class="live-feed-card">
                        <h2 class="card-title" style="text-align: center; margin-bottom: 15px;">Live Withdrawals</h2>
                        <div id="live-withdrawal-feed" style="max-height: 200px; overflow-y: auto;">
                        </div>
                    </div>
                    <div class="top-withdrawal-card">
                        <h2 class="card-title" style="text-align: center; margin-bottom: 15px;">Top Withdrawals</h2>
                        <div id="top-withdrawal-feed">
                        </div>
                    </div>
                </div>
            </div>
            <div id="page-history" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Transaction History</h1>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Purchase History</h2></div>
                    <div class="card-content history-list" id="purchase-history-list">
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Withdrawal History</h2></div>
                    <div class="card-content history-list" id="withdrawal-history-list">
                    </div>
                </div>
            </div>
            <div id="page-buy-plan" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Buy Mining Power</h1>
                <div class="plan-grid" id="mining-plans-grid">
                </div>
            </div>
            <div id="page-tasks" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Earn Free Rewards</h1>
                <div class="task-list" id="tasks-list">
                </div>
            </div>
            <div id="page-profile" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Your Profile</h1>
                <div class="card">
                    <div class="profile-header">
                        <div class="profile-avatar-container">
                            <img id="profile-avatar" src="/placeholder.svg" alt="Profile Avatar" class="profile-avatar">
                            <label for="avatar-upload" class="upload-btn"><i data-feather="upload"></i></label>
                            <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                        </div>
                        <h2 class="profile-name" id="profile-name"></h2>
                        <p class="profile-username" id="profile-username"></p>
                    </div>
                    <div class="level-display">
                        <img id="level-icon" src="/placeholder.svg" alt="Level Icon" class="level-icon">
                        <p class="level-name" id="level-name"></p>
                        <p class="progress-text" id="level-progress-text"></p>
                        <div class="progress-bar"><div class="progress-fill" id="level-progress-fill"></div></div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item"><p class="label">Main Balance</p><p class="value" id="main-balance">0.00 MMK</p></div>
                        <div class="stat-item"><p class="label">Total Purchases</p><p class="value" id="total-purchases">0.00 MMK</p></div>
                        <div class="stat-item"><p class="label">Total Withdrawals</p><p class="value" id="total-withdrawals">0.00 MMK</p></div>
                        <div class="stat-item"><p class="label">Lifetime Mining</p><p class="value" id="lifetime-mining">0.00 MMK</p></div>
                    </div>
                    <div class="withdraw-form">
                        <h3>Withdraw Funds</h3>
                        <input type="number" id="withdraw-amount" placeholder="Amount (Min 100,000 MMK)" required min="100000">
                        <input type="text" id="withdraw-method" placeholder="Payment Method (e.g., KBZPay)" required>
                        <input type="text" id="withdraw-phone" placeholder="Receiver Phone Number" required>
                        <input type="text" id="withdraw-account-name" placeholder="Account Name" required>
                        <input type="password" id="withdraw-pin" placeholder="6-Digit Withdraw PIN" required maxlength="6" pattern="\d{6}">
                        <button class="withdraw-btn" id="submit-withdraw-btn">Submit Withdrawal</button>
                    </div>
                    <button class="logout-btn" onclick="handleLogout()">Logout</button>
                </div>
            </div>
            <div id="page-global-chat" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Global Chat</h1>
                <div class="chat-container">
                    <div class="messages" id="global-chat-messages">
                    </div>
                    <form class="chat-input-form" onsubmit="sendGlobalMessage(event)">
                        <input type="text" id="global-chat-input" placeholder="Type your message..." required>
                        <button type="submit"><i data-feather="send"></i></button>
                    </form>
                </div>
            </div>
            <div id="page-support-admin" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Support Chat</h1>
                <div class="support-chat-container">
                    <div class="messages" id="support-messages">
                    </div>
                    <form class="chat-input-form" onsubmit="sendSupportMessage(event)">
                        <input type="text" id="support-chat-input" placeholder="Type your message..." required>
                        <button type="submit"><i data-feather="send"></i></button>
                    </form>
                </div>
            </div>
            <div id="page-news" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Latest News & Updates</h1>
                <div class="news-list" id="news-list">
                </div>
            </div>
            <div id="page-feed" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Social Feed</h1>
                <div class="post-form">
                    <textarea id="post-content" placeholder="What's on your mind?" rows="3"></textarea>
                    <input type="file" id="post-video-upload" accept="video/mp4" onchange="handleVideoSelect(event)">
                    <p id="upload-progress" class="upload-progress" style="display: none;">Uploading: 0%</p>
                    <button onclick="createPost()">Post</button>
                </div>
                <div class="post-list" id="feed-posts">
                </div>
            </div>
            <div id="page-social-video" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">Social & Videos</h1>
                <div class="video-grid" id="social-videos-grid">
                </div>
            </div>
            <div id="page-about" class="page">
                <h1 class="page-title" style="text-align: center; font-size: 28px; font-weight: 700; color: var(--accent-primary); margin-bottom: 20px; text-shadow: 0 0 10px rgba(240,185,11,0.5);">About Us & Contact</h1>
                <div class="about-info-list" id="about-info-list">
                </div>
            </div>

            <nav class="bottom-nav">
                <div class="nav-menu" id="bottom-nav-menu">
                </div>
            </nav>
        </div>

        <div id="overlay" class="overlay">
            <div class="overlay-content">
                <div id="lottie-animation"></div>
                <p id="overlay-message"></p>
            </div>
        </div>

        <div id="toast" class="toast-message">
            <span id="toast-icon"></span>
            <span id="toast-text"></span>
        </div>

        <div id="banned-overlay" class="banned-overlay" style="display: none;">
            <i data-feather="slash" style="width: 80px; height: 80px; margin-bottom: 20px;"></i>
            <p class="banned-message">Your account has been banned.</p>
            <p class="banned-message" style="font-size: 18px; font-weight: 500;">Please contact support for more information.</p>
            <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm"
        import feather from "https://cdn.jsdelivr.net/npm/feather-icons@4.29.1/dist/feather.min.js/+esm"
        import lottie from "https://cdn.jsdelivr.net/npm/lottie-web@5.9.6/build/player/lottie.min.js/+esm"

        const SUPABASE_URL = "https://slfmlndfcouckcqaztup.supabase.co"
        const SUPABASE_ANON_KEY =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZm1sbmRmY291Y2tjcWF6dHVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjU3NDksImV4cCI6MjA2OTQwMTc0OX0.ELZdUytnVYTG2RYjfyzL5mD_trcG7EsaBbgOuJLoAB4"

        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const app = {
            user: null,
            currentPage: "auth",
            session: null,
            lottieAnimation: null,
            miningInterval: null,
            taskVisitTimers: {},
            globalChatChannel: null,
            supportChatChannel: null,
            currentSupportThreadId: null,
            isBanned: false,
            lastMiningUpdate: Date.now(),
            realtimeChannels: [],
        }

        document.addEventListener("DOMContentLoaded", () => {
            feather.replace()
            app.lottieAnimation = lottie.loadAnimation({
                container: document.getElementById("lottie-animation"),
                renderer: "svg",
                loop: false,
                autoplay: false,
                path: "https://assets1.lottiefiles.com/packages/lf20_xwmj0hsk.json",
            })

            setupGlobalRealtimeListeners()
            checkSession()
            setupNavMenu()
        })

        async function checkSession() {
            const { data, error } = await db.auth.getSession()
            if (error) {
                console.error("Error getting session:", error)
                showAuthPage()
                return
            }
            if (data.session) {
                app.session = data.session
                app.user = data.session.user
                await fetchUserProfile()
                if (app.isBanned) {
                    showBannedOverlay()
                } else {
                    showAppContent()
                    navigateTo("mining")
                    subscribeToUserSpecificRealtimeChannels(app.user.id)
                }
            } else {
                showAuthPage()
            }
        }

        async function fetchUserProfile() {
            if (!app.user) return
            const { data, error } = await db.from("users").select("*").eq("id", app.user.id).single()
            if (error) {
                console.error("Error fetching user profile:", error)
                return
            }
            app.user = { ...app.user, ...data }
            app.isBanned = data.is_banned
        }

        function toggleAuthForm() {
            const loginForm = document.getElementById("login-form")
            const signupForm = document.getElementById("signup-form")
            if (loginForm.style.display === "none") {
                loginForm.style.display = "block"
                signupForm.style.display = "none"
            } else {
                loginForm.style.display = "none"
                signupForm.style.display = "block"
            }
        }

        async function handleSignUp(event) {
            event.preventDefault()
            const name = document.getElementById("signup-name").value
            const username = document.getElementById("signup-username").value
            const email = document.getElementById("signup-email").value
            const password = document.getElementById("signup-password").value
            const pin = document.getElementById("signup-pin").value

            if (pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                showToast("error", "PIN must be 6 digits.")
                return
            }

            showLoading("Creating Account...")

            const { data: authData, error: authError } = await db.auth.signUp({
                email: email,
                password: password,
                options: {
                    data: {
                        name: name,
                        username: username,
                    },
                },
            })

            if (authError) {
                hideOverlay()
                showToast("error", `Sign Up Error: ${authError.message}`)
                return
            }

            if (!authData.user) {
                hideOverlay()
                showToast("error", "Could not create user. Please try again.")
                return
            }

            // Insert user profile into public.users table
            const { error: profileError } = await db
                .from("users")
                .insert({ id: authData.user.id, name: name, username: username, email: email, withdraw_pin: pin })

            if (profileError) {
                hideOverlay()
                showToast("error", `Profile Creation Error: ${profileError.message}`)
                return
            }

            showSuccess("Account Created! Please login.", () => {
                toggleAuthForm()
                document.getElementById("login-email").value = email
                document.getElementById("login-password").value = password
            })
        }

        async function handleLogin(event) {
            event.preventDefault()
            const email = document.getElementById("login-email").value
            const password = document.getElementById("login-password").value

            showLoading("Logging In...")

            const { data, error } = await db.auth.signInWithPassword({
                email: email,
                password: password,
            })

            if (error) {
                hideOverlay()
                showToast("error", `Login Error: ${error.message}`)
                return
            }

            app.session = data.session
            app.user = data.user
            await fetchUserProfile() // Fetch full user profile including is_banned status

            if (app.isBanned) {
                hideOverlay()
                showBannedOverlay()
                return
            }

            showSuccess("Login Successful!", () => {
                showAppContent()
                navigateTo("mining")
                subscribeToUserSpecificRealtimeChannels(app.user.id)
            })
        }

        async function handleLogout() {
            showLoading("Logging out...")
            const { error } = await db.auth.signOut()
            if (error) {
                console.error("Logout Error:", error)
                showToast("error", "Failed to logout.")
            } else {
                app.user = null
                app.session = null
                app.isBanned = false
                clearInterval(app.miningInterval)
                unsubscribeFromRealtimeChannels()
                hideBannedOverlay()
                showAuthPage()
                showToast("success", "Logged out successfully!")
            }
            hideOverlay()
        }

        function showBannedOverlay() {
            document.getElementById("banned-overlay").style.display = "flex"
            document.getElementById("app-content").style.display = "none"
            document.getElementById("page-auth").style.display = "none"
            clearInterval(app.miningInterval)
        }

        function hideBannedOverlay() {
            document.getElementById("banned-overlay").style.display = "none"
        }

        function showAuthPage() {
            document.getElementById("page-auth").style.display = "flex"
            document.getElementById("app-content").style.display = "none"
            hideBannedOverlay()
        }

        function showAppContent() {
            document.getElementById("page-auth").style.display = "none"
            document.getElementById("app-content").style.display = "flex"
            hideBannedOverlay()
        }

        function setupNavMenu() {
            const menuContainer = document.getElementById("bottom-nav-menu")
            const menuItems = [
                { id: "mining", icon: "activity", label: "Mining" },
                { id: "history", icon: "clock", label: "History" },
                { id: "buy-plan", icon: "shopping-cart", label: "Buy Plan" },
                { id: "tasks", icon: "check-square", label: "Tasks" },
                { id: "profile", icon: "user", label: "Profile" },
                { id: "global-chat", icon: "message-square", label: "Global Chat" },
                { id: "support-admin", icon: "shield", label: "Support" },
                { id: "news", icon: "book-open", label: "News" },
                { id: "feed", icon: "layout", label: "Feed" },
                { id: "social-video", icon: "youtube", label: "Social" },
                { id: "about", icon: "info", label: "About" },
            ]

            menuContainer.innerHTML = menuItems
                .map(
                    (item) => `
                        <div class="nav-item" id="nav-${item.id}" onclick="navigateTo('${item.id}')">
                            <i data-feather="${item.icon}"></i>
                            <span>${item.label}</span>
                        </div>
                    `,
                )
                .join("")
            feather.replace()
        }

        function navigateTo(pageId) {
            if (app.isBanned) {
                showBannedOverlay()
                return
            }

            document.querySelectorAll(".page").forEach((p) => p.classList.remove("active"))
            document.querySelectorAll(".nav-item").forEach((n) => n.classList.remove("active"))

            const targetPage = document.getElementById(`page-${pageId}`)
            const targetNav = document.getElementById(`nav-${pageId}`)
            if (targetPage) targetPage.classList.add("active")
            if (targetNav) targetNav.classList.add("active")

            app.currentPage = pageId

            loadPageContent(pageId)
        }

        async function loadPageContent(pageId) {
            showLoading("Loading...")
            try {
                switch (pageId) {
                    case "mining":
                        await renderMiningPage()
                        break
                    case "history":
                        await renderHistoryPage()
                        break
                    case "buy-plan":
                        await renderBuyPlanPage()
                        break
                    case "tasks":
                        await renderTasksPage()
                        break
                    case "profile":
                        await renderProfilePage()
                        break
                    case "global-chat":
                        await renderGlobalChatPage()
                        break
                    case "support-admin":
                        await renderSupportPage()
                        break
                    case "news":
                        await renderNewsPage()
                        break
                    case "feed":
                        await renderFeedPage()
                        break
                    case "social-video":
                        await renderSocialVideoPage()
                        break
                    case "about":
                        await renderAboutPage()
                        break
                    default:
                        console.log(`Page ${pageId} not implemented yet.`)
                }
            } catch (error) {
                console.error(`Error loading ${pageId} page:`, error)
                showToast("error", `Failed to load ${pageId} page.`)
            } finally {
                hideOverlay()
            }
        }

        function showLoading(message) {
            const overlay = document.getElementById("overlay")
            const msgEl = document.getElementById("overlay-message")
            msgEl.textContent = message
            overlay.classList.add("visible")
            app.lottieAnimation.stop()
        }

        function showSuccess(message, callback) {
            const overlay = document.getElementById("overlay")
            const msgEl = document.getElementById("overlay-message")
            msgEl.textContent = message
            overlay.classList.add("visible")

            app.lottieAnimation.play()

            setTimeout(() => {
                hideOverlay()
                if (callback) callback()
            }, 2000)
        }

        function hideOverlay() {
            document.getElementById("overlay").classList.remove("visible")
        }

        function showToast(type, message) {
            const toastEl = document.getElementById("toast")
            const toastIcon = document.getElementById("toast-icon")
            const toastText = document.getElementById("toast-text")

            toastEl.className = "toast-message show " + type
            toastText.textContent = message

            let iconName = ""
            if (type === "success") iconName = "check-circle"
            else if (type === "error") iconName = "x-circle"
            else if (type === "info") iconName = "info"
            else if (type === "warning") iconName = "alert-triangle"
            toastIcon.innerHTML = `<i data-feather="${iconName}"></i>`
            feather.replace()

            setTimeout(() => {
                toastEl.classList.remove("show")
            }, 3000)
        }

        async function renderMiningPage() {
            if (!app.user) return
            await fetchMiningData()
            clearInterval(app.miningInterval)
            app.miningInterval = setInterval(fetchMiningData, 5000)
            await renderLiveWithdrawalFeed()
            await renderTopWithdrawalFeed()
        }

        async function fetchMiningData() {
            if (!app.user || app.isBanned) return

            const { data: userData, error: userError } = await db.from("users").select("*").eq("id", app.user.id).single()
            if (userError) {
                console.error("Error fetching user mining data:", userError)
                return
            }
            app.user = { ...app.user, ...userData }

            const { data: miningRate, error: rateError } = await db.rpc("get_total_mining_rate", { p_user_id: app.user.id })
            if (rateError) {
                console.error("Error fetching mining rate:", rateError)
                return
            }

            document.getElementById("lifetime-earnings").textContent = `${(app.user.lifetime_earnings || 0).toFixed(6)} MMK`
            document.getElementById("mining-balance").textContent = `${(app.user.mining_balance || 0).toFixed(6)} MMK`
            document.getElementById("mining-rate").textContent = (miningRate || 0).toFixed(8)

            const { data: activePlans } = await db
                .from("user_purchases")
                .select("expires_at")
                .eq("user_id", app.user.id)
                .eq("status", "active")
                .order("expires_at", { ascending: true })
                .limit(1)
            const soonestExpiry = activePlans && activePlans.length > 0 ? activePlans[0].expires_at : null
            updateCountdownTimer(soonestExpiry)
        }

        function updateCountdownTimer(expiryTimestamp) {
            const daysEl = document.getElementById("days")
            const hoursEl = document.getElementById("hours")
            const minutesEl = document.getElementById("minutes")
            const secondsEl = document.getElementById("seconds")

            if (!expiryTimestamp) {
                daysEl.textContent = "00"
                hoursEl.textContent = "00"
                minutesEl.textContent = "00"
                secondsEl.textContent = "00"
                minutesEl.textContent = "00"
                secondsEl.textContent = "00"
                return
            }

            const countdown = new Date(expiryTimestamp).getTime()
            const now = new Date().getTime()
            const distance = countdown - now

            if (distance < 0) {
                daysEl.textContent = "00"
                hoursEl.textContent = "00"
                minutesEl.textContent = "00"
                secondsEl.textContent = "00"
                return
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24))
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))
            const seconds = Math.floor((distance % (1000 * 60)) / 1000)

            daysEl.textContent = String(days).padStart(2, "0")
            hoursEl.textContent = String(hours).padStart(2, "0")
            minutesEl.textContent = String(minutes).padStart(2, "0")
            secondsEl.textContent = String(seconds).padStart(2, "0")
        }

        document.getElementById("collect-mining-btn").addEventListener("click", async () => {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }
            if (app.user.mining_balance <= 0.000001) {
                showToast("warning", "Your mining balance is too low to collect.")
                return
            }

            document.getElementById("collect-mining-btn").disabled = true
            showLoading("Collecting...")

            const { data: transferredAmount, error } = await db.rpc("transfer_mining_to_main", { p_user_id: app.user.id })

            if (error) {
                showToast("error", `Transfer Failed: ${error.message}`)
            } else if (transferredAmount && transferredAmount > 0) {
                showToast("success", `${transferredAmount.toFixed(6)} MMK moved to main balance!`)
                await fetchMiningData()
            } else {
                showToast("info", "No balance was transferred.")
            }
            document.getElementById("collect-mining-btn").disabled = false
            hideOverlay()
        })

        async function renderLiveWithdrawalFeed() {
            const feedEl = document.getElementById("live-withdrawal-feed")
            feedEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("withdrawals")
                .select("*, user:users(username)")
                .order("created_at", { ascending: false })
                .limit(5)
            if (error) {
                console.error("Error fetching live withdrawals:", error)
                feedEl.innerHTML = '<p style="text-align: center; color: var(--error);">Failed to load live feed.</p>'
                return
            }

            if (data.length === 0) {
                feedEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No recent withdrawals.</p>'
                return
            }

            feedEl.innerHTML = data
                .map(
                    (w) => `
                        <div class="live-feed-item">
                            <div>
                                <span class="username">${w.user.username}</span> withdrew <span class="amount">${w.amount.toLocaleString()} MMK</span>
                            </div>
                            <div>
                                <span class="status">${w.status}</span> via <span class="method">${w.payment_method}</span>
                            </div>
                        </div>
                    `,
                )
                .join("")
        }

        async function renderTopWithdrawalFeed() {
            const feedEl = document.getElementById("top-withdrawal-feed")
            feedEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("users")
                .select("username, total_withdrawal_amount")
                .order("total_withdrawal_amount", { ascending: false })
                .limit(5)
            if (error) {
                console.error("Error fetching top withdrawals:", error)
                feedEl.innerHTML = '<p style="text-align: center; color: var(--error);">Failed to load top withdrawals.</p>'
                return
            }

            if (data.length === 0) {
                feedEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No top withdrawals yet.</p>'
                return
            }

            feedEl.innerHTML = data
                .map(
                    (u, index) => `
                        <div class="top-withdrawal-item">
                            <span class="rank">#${index + 1}</span>
                            <span class="username">${u.username}</span>
                            <span class="amount">${u.total_withdrawal_amount.toLocaleString()} MMK</span>
                        </div>
                    `,
                )
                .join("")
        }

        async function renderHistoryPage() {
            if (!app.user) return
            await fetchPurchaseHistory()
            await fetchWithdrawalHistory()
        }

        async function fetchPurchaseHistory() {
            const listEl = document.getElementById("purchase-history-list")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("user_purchases")
                .select("*, mining_plans(name)")
                .eq("user_id", app.user.id)
                .order("purchased_at", { ascending: false })
            if (error) {
                console.error("Error fetching purchase history:", error)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading purchase history: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary);">No purchase history found.</p>'
                return
            }

            listEl.innerHTML = data
                .map(
                    (p) => `
                        <div class="history-item">
                            <div>
                                <p>${p.mining_plans?.name || "Task Reward"}: ${p.cost.toLocaleString()} MMK</p>
                                <p style="font-size: 12px; color: var(--text-secondary);">${new Date(p.purchased_at).toLocaleString()}</p>
                            </div>
                            <span class="status-badge ${p.status}">${p.status}</span>
                        </div>
                    `,
                )
                .join("")
        }

        async function fetchWithdrawalHistory() {
            const listEl = document.getElementById("withdrawal-history-list")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("withdrawals")
                .select("*")
                .eq("user_id", app.user.id)
                .order("created_at", { ascending: false })
            if (error) {
                console.error("Error fetching withdrawal history:", error)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading withdrawal history: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                listEl.innerHTML = '<p style="color: var(--text-secondary);">No withdrawal history found.</p>'
                return
            }

            listEl.innerHTML = data
                .map(
                    (w) => `
                        <div class="history-item">
                            <div>
                                <p>Withdrawal: ${w.amount.toLocaleString()} MMK</p>
                                <p style="font-size: 12px; color: var(--text-secondary);">${new Date(w.created_at).toLocaleString()}</p>
                                ${w.rejection_reason ? `<p style="font-size: 12px; color: var(--error);">Reason: ${w.rejection_reason}</p>` : ""}
                            </div>
                            <span class="status-badge ${w.status}">${w.status}</span>
                        </div>
                    `,
                )
                .join("")
        }

        async function renderBuyPlanPage() {
            const gridEl = document.getElementById("mining-plans-grid")
            gridEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db.from("mining_plans").select("*").order("cost")
            if (error) {
                console.error("Error fetching mining plans:", error)
                gridEl.innerHTML = `<p style="color: var(--error);">Error loading plans: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                gridEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No mining plans available yet.</p>'
                return
            }

            gridEl.innerHTML = data
                .map(
                    (plan) => `
                        <div class="plan-card">
                            <img src="${plan.icon_url || "/placeholder.svg"}" alt="${plan.name} Icon" class="plan-icon">
                            <h3>${plan.name}</h3>
                            <p class="cost">${plan.cost.toLocaleString()} MMK</p>
                            <div class="details">
                                <p>Duration: ${plan.duration_days} days</p>
                                <p>Total Return: ${plan.total_return.toLocaleString()} MMK</p>
                                <p style="font-size: 12px; color: var(--text-secondary);">Power: ${plan.power_per_second.toFixed(8)} MMK/sec</p>
                            </div>
                            <button class="buy-btn" onclick="openPurchaseDialog(${plan.id})">Buy Now</button>
                        </div>
                    `,
                )
                .join("")
        }

        let selectedPlan = null
        let purchaseDialog = null

        async function openPurchaseDialog(planId) {
            const { data: plan, error } = await db.from("mining_plans").select("*").eq("id", planId).single()
            if (error || !plan) {
                showToast("error", "Failed to load plan details.")
                console.error("Error fetching plan for dialog:", error)
                return
            }
            selectedPlan = plan

            const dialogHtml = `
                        <div class="dialog-overlay visible" id="purchase-dialog-overlay">
                            <div class="dialog-content">
                                <div class="dialog-header">
                                    <h3 class="dialog-title">Confirm Purchase: ${selectedPlan.name}</h3>
                                </div>
                                <div class="dialog-body">
                                    <div class="payment-info">
                                        <p>Please transfer <strong>${selectedPlan.cost.toLocaleString()} MMK</strong> to:</p>
                                        <p>Method: <strong>${selectedPlan.payment_method}</strong></p>
                                        <p>Phone: <strong>${selectedPlan.payment_phone}</strong></p>
                                    </div>
                                    <p>After payment, upload your transaction receipt below.</p>
                                    <input type="file" id="receipt-upload-input" accept="image/*" required>
                                </div>
                                <div class="dialog-footer">
                                    <button class="submit-btn" id="submit-purchase-btn">Submit for Approval</button>
                                </div>
                            </div>
                        </div>
                    `
            document.body.insertAdjacentHTML("beforeend", dialogHtml)
            purchaseDialog = document.getElementById("purchase-dialog-overlay")

            document.getElementById("submit-purchase-btn").addEventListener("click", handlePurchaseSubmission)
            purchaseDialog.addEventListener("click", (e) => {
                if (e.target === purchaseDialog) closePurchaseDialog()
            })
        }

        function closePurchaseDialog() {
            if (purchaseDialog) {
                purchaseDialog.classList.remove("visible")
                purchaseDialog.remove()
                purchaseDialog = null
                selectedPlan = null
            }
        }

        async function handlePurchaseSubmission() {
            if (!app.user || !selectedPlan) return

            const receiptInput = document.getElementById("receipt-upload-input")
            const receiptFile = receiptInput.files[0]

            if (!receiptFile) {
                showToast("warning", "Please select a receipt image.")
                return
            }

            document.getElementById("submit-purchase-btn").disabled = true
            showLoading("Submitting purchase...")

            const filePath = `${app.user.id}/receipts/${Date.now()}-${receiptFile.name}`
            const { error: uploadError } = await db.storage.from("receipts").upload(filePath, receiptFile)

            if (uploadError) {
                showToast("error", `Upload Failed: ${uploadError.message}`)
                document.getElementById("submit-purchase-btn").disabled = false
                hideOverlay()
                return
            }

            const { data: publicUrlData } = db.storage.from("receipts").getPublicUrl(filePath)
            const receiptUrl = publicUrlData.publicUrl

            const { error: insertError } = await db.from("user_purchases").insert({
                user_id: app.user.id,
                plan_id: selectedPlan.id,
                cost: selectedPlan.cost,
                power_per_second: selectedPlan.power_per_second,
                status: "pending",
                receipt_url: receiptUrl,
            })

            if (insertError) {
                showToast("error", `Purchase Failed: ${insertError.message}`)
            } else {
                showToast("info", "Your purchase is submitted for approval. Check your history.")
                closePurchaseDialog()
                await fetchPurchaseHistory()
            }
            document.getElementById("submit-purchase-btn").disabled = false
            hideOverlay()
        }

        async function renderTasksPage() {
            const listEl = document.getElementById("tasks-list")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data: tasks, error: tasksError } = await db.from("tasks").select("*")
            if (tasksError) {
                console.error("Error fetching tasks:", tasksError)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading tasks: ${tasksError.message}</p>`
                return
            }

            const { data: userTasks, error: userTasksError } = await db
                .from("user_tasks")
                .select("task_id")
                .eq("user_id", app.user.id)
            if (userTasksError) {
                console.error("Error fetching user tasks:", userTasksError)
            }
            const completedTaskIds = new Set(userTasks ? userTasks.map((ut) => ut.task_id) : [])

            const { data: userProfile } = await db.from("users").select("total_purchase_volume").eq("id", app.user.id).single()
            const totalPurchaseVolume = userProfile ? userProfile.total_purchase_volume : 0

            if (tasks.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No tasks available yet.</p>'
                return
            }

            listEl.innerHTML = tasks
                .map((task) => {
                    const isCompleted = completedTaskIds.has(task.id)
                    const isVerifying = app.taskVisitTimers[task.id] && app.taskVisitTimers[task.id].status === "verifying"
                    const isVerified = app.taskVisitTimers[task.id] && app.taskVisitTimers[task.id].status === "verified"

                    let claimButtonHtml = ""
                    let taskDescription = ""
                    let rewardText = ""
                    let canClaim = !isCompleted

                    if (task.reward_type === "cash") {
                        rewardText = `${task.cash_reward.toLocaleString()} MMK`
                        taskDescription = `Complete this task to earn ${rewardText}.`
                    } else if (task.reward_type === "mining_power") {
                        rewardText = `${task.mining_power_reward.toFixed(8)} MMK/sec`
                        taskDescription = `Gain ${rewardText} for ${task.mining_duration_hours} hours.`
                    } else if (task.reward_type === "purchase_goal") {
                        rewardText = `${task.goal_reward_amount.toLocaleString()} MMK`
                        taskDescription = `Reach ${task.purchase_goal_amount.toLocaleString()} MMK in total purchases to earn ${rewardText}. Your current volume: ${totalPurchaseVolume.toLocaleString()} MMK.`
                        if (totalPurchaseVolume < task.purchase_goal_amount) {
                            canClaim = false
                        }
                    }

                    if (isCompleted) {
                        claimButtonHtml = `<span class="claimed-badge"><i data-feather="check-circle"></i> Claimed</span>`
                    } else if (task.link && !isVerified) {
                        claimButtonHtml = `<button class="claim-btn" onclick="handleTaskLinkVisit(${task.id}, '${task.link}')" ${isVerifying ? "disabled" : ""}>
                                ${isVerifying ? `<i data-feather="loader" class="spin-animation"></i> Verifying...` : `<i data-feather="external-link"></i> Visit Link to Enable`}
                            </button>`
                        canClaim = false
                    } else {
                        claimButtonHtml = `<button class="claim-btn" onclick="handleClaimTask(${task.id})" ${!canClaim ? "disabled" : ""}>
                                <i data-feather="gift"></i> Claim Reward
                            </button>`
                    }

                    return `
                            <div class="task-card">
                                <div class="task-header">
                                    <h3 class="task-title">${task.title}</h3>
                                    <span class="task-reward">${rewardText}</span>
                                </div>
                                <p class="task-description">${taskDescription}</p>
                                <div class="task-actions">
                                    ${
                                        task.link
                                            ? `<a href="${task.link}" target="_blank" class="task-link" onclick="event.stopPropagation(); handleTaskLinkVisit(${task.id}, '${task.link}')">
                                        View Task <i data-feather="external-link"></i>
                                    </a>`
                                            : "<span></span>"
                                    }
                                    ${claimButtonHtml}
                                </div>
                            </div>
                        `
                })
                .join("")
            feather.replace()
        }

        function handleTaskLinkVisit(taskId, link) {
            if (app.taskVisitTimers[taskId] && app.taskVisitTimers[taskId].status === "verifying") {
                showToast("info", "Already verifying this task. Please wait.")
                return
            }

            showToast("info", "Visiting link... Please wait 5 seconds.")
            app.taskVisitTimers[taskId] = { status: "verifying", timer: null }
            renderTasksPage()

            app.taskVisitTimers[taskId].timer = setTimeout(() => {
                app.taskVisitTimers[taskId].status = "verified"
                showToast("success", "Link verified! You can now claim the reward.")
                renderTasksPage()
            }, 5000)
        }

        async function handleClaimTask(taskId) {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }

            const task = (await db.from("tasks").select("*").eq("id", taskId).single()).data
            if (task.link && (!app.taskVisitTimers[taskId] || app.taskVisitTimers[taskId].status !== "verified")) {
                showToast("warning", "Please visit the task link first and wait for verification.")
                return
            }

            showLoading("Claiming reward...")
            const { data, error } = await db.rpc("claim_task", { p_user_id: app.user.id, p_task_id: taskId })

            if (error || (data && data.startsWith("Error"))) {
                showToast("error", error?.message || data)
            } else {
                showToast("success", data)
                delete app.taskVisitTimers[taskId]
                await renderTasksPage()
                await fetchMiningData()
                await renderProfilePage()
            }
            hideOverlay()
        }

        async function renderProfilePage() {
            if (!app.user) return

            const { data: userData, error: userError } = await db.from("users").select("*").eq("id", app.user.id).single()
            if (userError) {
                console.error("Error fetching profile:", userError)
                showToast("error", "Failed to load profile.")
                return
            }
            app.user = { ...app.user, ...userData }

            document.getElementById("profile-avatar").src =
                app.user.profile_image_url || "https://i.pravatar.cc/150?u=" + app.user.id
            document.getElementById("profile-name").textContent = app.user.name
            document.getElementById("profile-username").textContent = `@${app.user.username}`

            document.getElementById("main-balance").textContent = `${(app.user.balance || 0).toFixed(2)} MMK`
            document.getElementById("total-purchases").textContent = `${(app.user.total_purchase_volume || 0).toFixed(2)} MMK`
            document.getElementById("total-withdrawals").textContent = `${(app.user.total_withdrawal_amount || 0).toFixed(2)} MMK`
            document.getElementById("lifetime-mining").textContent = `${(app.user.lifetime_earnings || 0).toFixed(2)} MMK`

            const { data: levels, error: levelsError } = await db.from("levels").select("*").order("level_number")
            if (levelsError) {
                console.error("Error fetching levels:", levelsError)
                return
            }

            const currentLevel = levels.find((l) => l.level_number === app.user.current_level_number)
            const nextLevel = levels.find((l) => l.level_number === app.user.current_level_number + 1)

            document.getElementById("level-icon").src = currentLevel?.icon_url || "/placeholder.svg"
            document.getElementById("level-name").textContent = currentLevel?.name || "N/A"

            let progressText = ""
            let progressWidth = 0
            if (nextLevel) {
                const currentVolume = app.user.total_purchase_volume || 0
                const requiredVolume = nextLevel.required_volume
                progressText = `Next Level (${nextLevel.name}): ${currentVolume.toLocaleString()} / ${requiredVolume.toLocaleString()} MMK`
                progressWidth = (currentVolume / requiredVolume) * 100
                if (progressWidth > 100) progressWidth = 100
            } else {
                progressText = "Max Level Reached!"
                progressWidth = 100
            }
            document.getElementById("level-progress-text").textContent = progressText
            document.getElementById("level-progress-fill").style.width = `${progressWidth}%`

            document.getElementById("submit-withdraw-btn").onclick = handleSubmitWithdrawal
            document.getElementById("avatar-upload").onchange = handleProfileImageUpload
        }

        async function handleProfileImageUpload(event) {
            if (!event.target.files || event.target.files.length === 0 || !app.user) return
            const file = event.target.files[0]
            const filePath = `${app.user.id}/avatars/${Date.now()}-${file.name}`

            showLoading("Uploading avatar...")
            const { error: uploadError } = await db.storage.from("profile_avatars").upload(filePath, file, { upsert: true })
            if (uploadError) {
                showToast("error", `Upload Failed: ${uploadError.message}`)
                hideOverlay()
                return
            }

            const { data: urlData } = db.storage.from("profile_avatars").getPublicUrl(filePath)
            const publicUrl = urlData.publicUrl

            const { error: updateUserError } = await db
                .from("users")
                .update({ profile_image_url: publicUrl })
                .eq("id", app.user.id)

            if (updateUserError) {
                showToast("error", `Update Failed: ${updateUserError.message}`)
            } else {
                app.user.profile_image_url = publicUrl
                document.getElementById("profile-avatar").src = publicUrl
                showToast("success", "Profile picture updated.")
            }
            hideOverlay()
        }

        async function handleSubmitWithdrawal() {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }

            const amount = Number.parseFloat(document.getElementById("withdraw-amount").value)
            const method = document.getElementById("withdraw-method").value
            const phone = document.getElementById("withdraw-phone").value
            const accountName = document.getElementById("withdraw-account-name").value
            const pin = document.getElementById("withdraw-pin").value

            if (isNaN(amount) || amount < 100000) {
                showToast("warning", "Minimum withdrawal amount is 100,000 MMK.")
                return
            }
            if (app.user.balance < amount) {
                showToast("error", "Insufficient balance.")
                return
            }
            if (!method || !phone || !accountName || !pin) {
                showToast("warning", "Please fill all withdrawal details.")
                return
            }
            if (pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                showToast("error", "Withdraw PIN must be 6 digits.")
                return
            }

            showLoading("Submitting withdrawal request...")
            document.getElementById("submit-withdraw-btn").disabled = true

            const { data, error } = await db.rpc("request_withdrawal", {
                p_user_id: app.user.id,
                p_amount: amount,
                p_payment_method: method,
                p_phone_number: phone,
                p_account_name: accountName,
                p_withdraw_pin: pin,
            })

            if (error || (data && data.startsWith("Error"))) {
                showToast("error", error?.message || data)
            } else {
                showToast("info", data)
                document.getElementById("withdraw-amount").value = ""
                document.getElementById("withdraw-method").value = ""
                document.getElementById("withdraw-phone").value = ""
                document.getElementById("withdraw-account-name").value = ""
                document.getElementById("withdraw-pin").value = ""
                await renderProfilePage()
                await fetchWithdrawalHistory()
            }
            document.getElementById("submit-withdraw-btn").disabled = false
            hideOverlay()
        }

        async function renderGlobalChatPage() {
            if (!app.user) return
            await fetchGlobalMessages()
            setupGlobalChatRealtime()
        }

        async function fetchGlobalMessages() {
            const chatMessagesEl = document.getElementById("global-chat-messages")
            chatMessagesEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("global_chat_messages")
                .select("*, user:users(username, profile_image_url, current_level_number), level:levels(name)")
                .order("created_at", { ascending: true })
                .limit(100)
            if (error) {
                console.error("Error fetching global chat messages:", error)
                chatMessagesEl.innerHTML = `<p style="color: var(--error);">Error loading chat: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                chatMessagesEl.innerHTML =
                    '<p style="text-align: center; color: var(--text-secondary);">No messages yet. Be the first to say hi!</p>'
                return
            }

            chatMessagesEl.innerHTML = data
                .map(
                    (msg) => `
                        <div class="message-item ${msg.is_admin ? "admin" : ""}">
                            <img src="${msg.user?.profile_image_url || "https://i.pravatar.cc/150?u=" + msg.user?.id}" alt="Avatar" class="message-avatar">
                            <div class="message-content">
                                <p class="message-sender">
                                    ${msg.user?.username || "Unknown User"}
                                    ${msg.is_admin ? '<span style="color: #FFD700; font-weight: bold;">(Admin)</span>' : `<span class="level-badge">Lv.${msg.user?.current_level_number || 0}</span>`}
                                </p>
                                <div class="message-bubble">${msg.content}</div>
                            </div>
                        </div>
                    `,
                )
                .join("")
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight
        }

        function setupGlobalChatRealtime() {
            if (app.globalChatChannel) {
                db.removeChannel(app.globalChatChannel)
            }
            app.globalChatChannel = db
                .channel("global_chat_room")
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "global_chat_messages" }, async (payload) => {
                    const { data: newMessage, error } = await db
                        .from("global_chat_messages")
                        .select("*, user:users(username, profile_image_url, current_level_number), level:levels(name)")
                        .eq("id", payload.new.id)
                        .single()
                    if (error) {
                        console.error("Error fetching new global message:", error)
                        return
                    }
                    const chatMessagesEl = document.getElementById("global-chat-messages")
                    chatMessagesEl.insertAdjacentHTML(
                        "beforeend",
                        `
                                <div class="message-item ${newMessage.is_admin ? "admin" : ""}">
                                    <img src="${newMessage.user?.profile_image_url || "https://i.pravatar.cc/150?u=" + newMessage.user?.id}" alt="Avatar" class="message-avatar">
                                    <div class="message-content">
                                        <p class="message-sender">
                                            ${newMessage.user?.username || "Unknown User"}
                                            ${newMessage.is_admin ? '<span style="color: #FFD700; font-weight: bold;">(Admin)</span>' : `<span class="level-badge">Lv.${newMessage.user?.current_level_number || 0}</span>`}
                                        </p>
                                        <div class="message-bubble">${newMessage.content}</div>
                                    </div>
                                </div>
                            `,
                    )
                    chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight
                })
                .subscribe()
        }

        async function sendGlobalMessage(event) {
            event.preventDefault()
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }
            const inputEl = document.getElementById("global-chat-input")
            const content = inputEl.value.trim()
            if (!content) return

            inputEl.value = ""

            const { error } = await db
                .from("global_chat_messages")
                .insert({ user_id: app.user.id, content: content, is_admin: false })
            if (error) {
                console.error("Error sending global message:", error)
                showToast("error", "Failed to send message.")
            }
        }

        async function renderSupportPage() {
            if (!app.user) return
            await fetchSupportMessages()
            setupSupportChatRealtime()
        }

        async function fetchSupportMessages() {
            const chatMessagesEl = document.getElementById("support-messages")
            chatMessagesEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data: threadData, error: threadError } = await db
                .from("support_messages")
                .select("id")
                .eq("user_id", app.user.id)
                .limit(1)
            let threadId = threadData && threadData.length > 0 ? threadData[0].id : null

            if (!threadId) {
                const { data: newThread, error: createError } = await db
                    .from("support_messages")
                    .insert({ user_id: app.user.id, content: "Support chat started.", sent_by_admin: false })
                    .select("id")
                    .single()
                if (createError) {
                    console.error("Error creating support thread:", createError)
                    chatMessagesEl.innerHTML = `<p style="color: var(--error);">Error starting support chat.</p>`
                    return
                }
                threadId = newThread.id
            }
            app.currentSupportThreadId = threadId

            const { data, error } = await db
                .from("support_messages")
                .select("*")
                .eq("user_id", app.user.id)
                .order("created_at", { ascending: true })
            if (error) {
                console.error("Error fetching support messages:", error)
                chatMessagesEl.innerHTML = `<p style="color: var(--error);">Error loading chat: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                chatMessagesEl.innerHTML =
                    '<p style="text-align: center; color: var(--text-secondary);">Start a conversation with support!</p>'
                return
            }

            chatMessagesEl.innerHTML = data
                .map(
                    (msg) => `
                        <div class="message-item ${msg.sent_by_admin ? "admin-message" : "user-message"}">
                            <div class="message-bubble ${msg.sent_by_admin ? "admin-message" : "user-message"}">${msg.content}</div>
                        </div>
                    `,
                )
                .join("")
            chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight
        }

        function setupSupportChatRealtime() {
            if (app.supportChatChannel) {
                db.removeChannel(app.supportChatChannel)
            }
            app.supportChatChannel = db
                .channel(`support_chat_${app.user.id}`)
                .on(
                    "postgres_changes",
                    { event: "INSERT", schema: "public", table: "support_messages", filter: `user_id=eq.${app.user.id}` },
                    (payload) => {
                        const chatMessagesEl = document.getElementById("support-messages")
                        chatMessagesEl.insertAdjacentHTML(
                            "beforeend",
                            `
                                <div class="message-item ${payload.new.sent_by_admin ? "admin-message" : "user-message"}">
                                    <div class="message-bubble ${payload.new.sent_by_admin ? "admin-message" : "user-message"}">${payload.new.content}</div>
                                </div>
                            `,
                        )
                        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight
                    },
                )
                .subscribe()
        }

        async function sendSupportMessage(event) {
            event.preventDefault()
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }
            const inputEl = document.getElementById("support-chat-input")
            const content = inputEl.value.trim()
            if (!content) return

            inputEl.value = ""

            const { error } = await db
                .from("support_messages")
                .insert({ user_id: app.user.id, content: content, sent_by_admin: false })
            if (error) {
                console.error("Error sending support message:", error)
                showToast("error", "Failed to send message.")
            }
        }

        async function renderNewsPage() {
            const listEl = document.getElementById("news-list")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db.from("news").select("*").order("created_at", { ascending: false })
            if (error) {
                console.error("Error fetching news:", error)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading news: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                listEl.innerHTML =
                    '<p style="text-align: center; color: var(--text-secondary);">No news articles have been posted yet.</p>'
                return
            }

            listEl.innerHTML = data
                .map((article) => {
                    const timeAgo = formatTimeAgo(new Date(article.created_at))
                    const contentWithLinks = article.content.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>')
                    return `
                            <div class="news-card">
                                ${article.image_url ? `<img src="${article.image_url}" alt="${article.title}">` : ""}
                                <div class="news-content">
                                    <h3 class="news-title">${article.title}</h3>
                                    <p class="news-meta">${timeAgo}</p>
                                    <p class="news-text">${contentWithLinks}</p>
                                </div>
                            </div>
                        `
                })
                .join("")
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000)
            let interval = seconds / 31536000
            if (interval > 1) return Math.floor(interval) + "y ago"
            interval = seconds / 2592000
            if (interval > 1) return Math.floor(interval) + "mo ago"
            interval = seconds / 86400
            if (interval > 1) return Math.floor(interval) + "d ago"
            interval = seconds / 3600
            if (interval > 1) return Math.floor(interval) + "h ago"
            interval = seconds / 60
            if (interval > 1) return Math.floor(interval) + "m ago"
            return Math.floor(seconds) + "s ago"
        }

        async function renderFeedPage() {
            const listEl = document.getElementById("feed-posts")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db
                .from("posts")
                .select("*, user:users(username, profile_image_url), likes(user_id)")
                .order("created_at", { ascending: false })
            if (error) {
                console.error("Error fetching posts:", error)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading feed: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                listEl.innerHTML =
                    '<p style="text-align: center; color: var(--text-secondary);">No posts yet. Be the first to share something!</p>'
                return
            }

            listEl.innerHTML = data
                .map((post) => {
                    const timeAgo = formatTimeAgo(new Date(post.created_at))
                    const likedByCurrentUser = post.likes.some((like) => like.user_id === app.user?.id)
                    return `
                            <div class="post-card" id="post-${post.id}">
                                <div class="post-header">
                                    <img src="${post.user?.profile_image_url || "https://i.pravatar.cc/150?u=" + post.user?.id}" alt="Avatar" class="post-avatar">
                                    <div>
                                        <p class="post-username">${post.user?.username || "Unknown User"}</p>
                                        <p class="post-time">${timeAgo}</p>
                                    </div>
                                </div>
                                ${post.content ? `<p class="post-content">${post.content}</p>` : ""}
                                ${post.video_url ? `<video controls src="${post.video_url}"></video>` : ""}
                                <div class="post-actions">
                                    <button class="like-btn ${likedByCurrentUser ? "liked" : ""}" onclick="toggleLike(${post.id}, ${likedByCurrentUser})">
                                        <i data-feather="heart"></i> <span id="likes-count-${post.id}">${post.likes.length}</span>
                                    </button>
                                    ${app.user && post.user_id === app.user.id ? `<button class="delete-btn" onclick="deletePost(${post.id})"><i data-feather="trash-2"></i> Delete</button>` : ""}
                                </div>
                            </div>
                        `
                })
                .join("")
            feather.replace()
        }

        let selectedVideoFile = null
        function handleVideoSelect(event) {
            selectedVideoFile = event.target.files[0]
            if (selectedVideoFile) {
                if (selectedVideoFile.size > 10 * 1024 * 1024) {
                    showToast("error", "Video file too large (max 10MB).")
                    selectedVideoFile = null
                    event.target.value = ""
                    return
                }
                const video = document.createElement("video")
                video.preload = "metadata"
                video.onloadedmetadata = () => {
                    window.URL.revokeObjectURL(video.src)
                    if (video.duration > 60) {
                        showToast("error", "Video too long (max 1 minute).")
                        selectedVideoFile = null
                        event.target.value = ""
                    }
                }
                video.src = URL.createObjectURL(selectedVideoFile)
            }
        }

        async function createPost() {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login or your account is banned.")
                return
            }

            const content = document.getElementById("post-content").value.trim()
            if (!content && !selectedVideoFile) {
                showToast("warning", "Please enter content or select a video.")
                return
            }

            showLoading("Posting...")
            document.getElementById("post-content").value = ""
            document.getElementById("post-video-upload").value = ""

            let videoUrl = null
            if (selectedVideoFile) {
                const uploadProgressEl = document.getElementById("upload-progress")
                uploadProgressEl.style.display = "block"

                const filePath = `${app.user.id}/posts/${Date.now()}-${selectedVideoFile.name}`
                const { data, error: uploadError } = await db.storage.from("post_videos").upload(filePath, selectedVideoFile, {
                    onUploadProgress: (event) => {
                        const percent = Math.round((event.loaded / event.total) * 100)
                        uploadProgressEl.textContent = `Uploading: ${percent}%`
                    },
                })

                if (uploadError) {
                    showToast("error", `Video upload failed: ${uploadError.message}`)
                    hideOverlay()
                    uploadProgressEl.style.display = "none"
                    return
                }
                const { data: publicUrlData } = db.storage.from("post_videos").getPublicUrl(filePath)
                videoUrl = publicUrlData.publicUrl
                uploadProgressEl.style.display = "none"
            }

            const { error: insertError } = await db.from("posts").insert({
                user_id: app.user.id,
                content: content,
                video_url: videoUrl,
            })

            if (insertError) {
                showToast("error", `Failed to create post: ${insertError.message}`)
            } else {
                showToast("success", "Post created successfully!")
                await renderFeedPage()
            }
            selectedVideoFile = null
            hideOverlay()
        }

        async function toggleLike(postId, isLiked) {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login to like posts.")
                return
            }

            const likesCountEl = document.getElementById(`likes-count-${postId}`)
            const likeBtnEl = document.querySelector(`#post-${postId} .like-btn`)

            if (isLiked) {
                const { error } = await db.from("likes").delete().eq("user_id", app.user.id).eq("post_id", postId)
                if (!error) {
                    likesCountEl.textContent = Number.parseInt(likesCountEl.textContent) - 1
                    likeBtnEl.classList.remove("liked")
                } else {
                    showToast("error", "Failed to unlike.")
                }
            } else {
                const { error } = await db.from("likes").insert({ user_id: app.user.id, post_id: postId })
                if (!error) {
                    likesCountEl.textContent = Number.parseInt(likesCountEl.textContent) + 1
                    likeBtnEl.classList.add("liked")
                } else {
                    showToast("error", "Failed to like.")
                }
            }
        }

        async function deletePost(postId) {
            if (!app.user || app.isBanned) {
                showToast("error", "Please login.")
                return
            }
            if (!confirm("Are you sure you want to delete this post?")) return

            showLoading("Deleting post...")
            const { error } = await db.from("posts").delete().eq("id", postId).eq("user_id", app.user.id)
            if (error) {
                showToast("error", `Failed to delete post: ${error.message}`)
            } else {
                showToast("success", "Post deleted.")
                await renderFeedPage()
            }
            hideOverlay()
        }

        async function renderSocialVideoPage() {
            const gridEl = document.getElementById("social-videos-grid")
            gridEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db.from("social_links").select("*").order("created_at", { ascending: false })
            if (error) {
                console.error("Error fetching social links:", error)
                gridEl.innerHTML = `<p style="color: var(--error);">Error loading social videos: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                gridEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No social videos posted yet.</p>'
                return
            }

            const listEl = document.getElementById("social-videos-grid")
            listEl.innerHTML = data
                .map((link) => {
                    let embedHtml = ""
                    if (link.video_url.includes("youtube.com") || link.video_url.includes("youtu.be")) {
                        const videoId = link.video_url.split("v=")[1] || link.video_url.split("/").pop()
                        embedHtml = `<iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`
                    } else if (link.video_url.includes("tiktok.com")) {
                        embedHtml = `<iframe src="${link.video_url.replace("/video/", "/embed/video/")}" frameborder="0" allowfullscreen scrolling="no" allow="encrypted-media;"></iframe>`
                    } else {
                        embedHtml = `<p style="text-align: center; color: var(--text-secondary);">Unsupported video platform. <a href="${link.video_url}" target="_blank" style="color: var(--accent-secondary);">Open link directly</a></p>`
                    }

                    return `
                            <div class="video-card">
                                <h3 class="video-title">${link.platform}: ${link.video_url.substring(0, 50)}...</h3>
                                <div class="video-embed">
                                    ${embedHtml}
                                </div>
                            </div>
                        `
                })
                .join("")
        }

        async function renderAboutPage() {
            const listEl = document.getElementById("about-info-list")
            listEl.innerHTML = '<div class="loading-spinner"></div>'

            const { data, error } = await db.from("about_info").select("*").order("created_at", { ascending: false })
            if (error) {
                console.error("Error fetching about info:", error)
                listEl.innerHTML = `<p style="color: var(--error);">Error loading about info: ${error.message}</p>`
                return
            }

            if (data.length === 0) {
                listEl.innerHTML =
                    '<p style="text-align: center; color: var(--text-secondary);">No about information available yet.</p>'
                return
            }

            listEl.innerHTML = data
                .map((item) => {
                    let icon = ""
                    const displayValue = item.social_link_or_value
                    let link = ""

                    if (item.social_name.toLowerCase().includes("telegram")) {
                        icon = "send"
                        link = item.social_link_or_value
                    } else if (item.social_name.toLowerCase().includes("phone")) {
                        icon = "phone"
                        link = `tel:${item.social_link_or_value}`
                    } else if (item.social_name.toLowerCase().includes("youtube")) {
                        icon = "youtube"
                        link = item.social_link_or_value
                    } else if (item.social_name.toLowerCase().includes("viber")) {
                        icon = "message-circle"
                        link = `viber://chat?number=${item.social_link_or_value}`
                    } else if (item.social_name.toLowerCase().includes("address")) {
                        icon = "map-pin"
                        link = `https://maps.google.com/?q=${encodeURIComponent(item.social_link_or_value)}`
                    } else {
                        icon = "link"
                        link = item.social_link_or_value
                    }

                    return `
                            <div class="about-info-item">
                                <i data-feather="${icon}" class="icon"></i>
                                <p class="text">
                                    ${item.social_name}:
                                    ${link ? `<a href="${link}" target="_blank" rel="noopener noreferrer">${displayValue}</a>` : displayValue}
                                </p>
                            </div>
                        `
                })
                .join("")
            feather.replace()
        }

        function setupGlobalRealtimeListeners() {
            db.channel("public:posts")
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "posts" }, (payload) => {
                    if (app.currentPage === "feed") {
                        renderFeedPage()
                    }
                })
                .subscribe()

            db.channel("public:likes")
                .on("postgres_changes", { event: "INSERT", schema: "public", table: "likes" }, (payload) => {
                    if (app.currentPage === "feed") {
                        const likesCountEl = document.getElementById(`likes-count-${payload.new.post_id}`)
                        if (likesCountEl) {
                            likesCountEl.textContent = Number.parseInt(likesCountEl.textContent) + 1
                        }
                    }
                })
                .on("postgres_changes", { event: "DELETE", schema: "public", table: "likes" }, (payload) => {
                    if (app.currentPage === "feed") {
                        const likesCountEl = document.getElementById(`likes-count-${payload.old.post_id}`)
                        if (likesCountEl) {
                            likesCountEl.textContent = Number.parseInt(likesCountEl.textContent) - 1
                        }
                    }
                })
                .subscribe()

            db.channel("public:news")
                .on("postgres_changes", { event: "*", schema: "public", table: "news" }, (payload) => {
                    if (app.currentPage === "news") {
                        renderNewsPage()
                    }
                })
                .subscribe()

            db.channel("public:about_info")
                .on("postgres_changes", { event: "*", schema: "public", table: "about_info" }, (payload) => {
                    if (app.currentPage === "about") {
                        renderAboutPage()
                    }
                })
                .subscribe()

            db.channel("public:social_links")
                .on("postgres_changes", { event: "*", schema: "public", table: "social_links" }, (payload) => {
                    if (app.currentPage === "social-video") {
                        renderSocialVideoPage()
                    }
                })
                .subscribe()

            db.channel("public:tasks")
                .on("postgres_changes", { event: "*", schema: "public", table: "tasks" }, (payload) => {
                    if (app.currentPage === "tasks") {
                        renderTasksPage()
                    }
                })
                .subscribe()
        }

        function subscribeToUserSpecificRealtimeChannels(userId) {
            unsubscribeFromRealtimeChannels()

            const userChannel = db
                .channel(`user_updates_${userId}`)
                .on(
                    "postgres_changes",
                    { event: "UPDATE", schema: "public", table: "users", filter: `id=eq.${userId}` },
                    (payload) => {
                        if (payload.new.is_banned !== app.isBanned) {
                            app.isBanned = payload.new.is_banned
                            if (app.isBanned) {
                                showBannedOverlay()
                            } else {
                                hideBannedOverlay()
                                loadPageContent(app.currentPage)
                            }
                        }
                        if (app.currentPage === "profile" || app.currentPage === "mining") {
                            fetchMiningData()
                            renderProfilePage()
                        }
                    },
                )
                .subscribe()
            app.realtimeChannels.push(userChannel)

            const purchasesChannel = db
                .channel(`user_purchases_updates_${userId}`)
                .on(
                    "postgres_changes",
                    { event: "UPDATE", schema: "public", table: "user_purchases", filter: `user_id=eq.${userId}` },
                    (payload) => {
                        if (app.currentPage === "history") {
                            fetchPurchaseHistory()
                        }
                        if (payload.new.status === "active" && app.currentPage === "mining") {
                            fetchMiningData()
                        }
                    },
                )
                .subscribe()
            app.realtimeChannels.push(purchasesChannel)

            const withdrawalsChannel = db
                .channel(`user_withdrawals_updates_${userId}`)
                .on(
                    "postgres_changes",
                    { event: "UPDATE", schema: "public", table: "withdrawals", filter: `user_id=eq.${userId}` },
                    (payload) => {
                        if (app.currentPage === "history") {
                            fetchWithdrawalHistory()
                        }
                        if (app.currentPage === "mining") {
                            renderLiveWithdrawalFeed()
                            renderTopWithdrawalFeed()
                        }
                        if (payload.new.status === "rejected" && payload.old.status === "pending") {
                            showToast(
                                "error",
                                `Withdrawal of ${payload.new.amount.toLocaleString()} MMK rejected. Reason: ${payload.new.rejection_reason || "N/A"}. Funds refunded.`,
                            )
                            renderProfilePage()
                        }
                    },
                )
                .subscribe()
            app.realtimeChannels.push(withdrawalsChannel)
        }

        function unsubscribeFromRealtimeChannels() {
            app.realtimeChannels.forEach((channel) => {
                db.removeChannel(channel)
            })
            app.realtimeChannels = []
        }
    </script>
</body>
</html>
