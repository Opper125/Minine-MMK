<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura Mine - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --admin-bg: #F3F4F6;
            --admin-sidebar-bg: #1F2937;
            --admin-card-bg: #FFFFFF;
            --admin-text-dark: #111827;
            --admin-text-light: #6B7280;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--admin-bg); }
        .sidebar { transition: width 0.3s; }
        .stat-card { transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="flex h-screen">

    <!-- Admin Auth Section -->
    <div id="admin-auth-section" class="w-full flex items-center justify-center bg-gray-100">
        <div class="w-full max-w-sm bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center mb-6 text-admin-text-dark">Admin Login</h2>
            <form id="admin-login-form">
                <div class="mb-4">
                    <label for="admin-email" class="block mb-2 text-sm font-medium text-admin-text-dark">Email</label>
                    <input type="email" id="admin-email" class="w-full bg-admin-card-bg border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6">
                    <label for="admin-password" class="block mb-2 text-sm font-medium text-admin-text-dark">Password</label>
                    <input type="password" id="admin-password" class="w-full bg-admin-card-bg border border-gray-300 rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="admin-panel-section" class="hidden flex w-full">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-admin-sidebar-bg text-white flex flex-col flex-shrink-0">
            <div class="p-4 text-2xl font-bold border-b border-gray-700">Aura Admin</div>
            <nav id="admin-menu" class="flex-grow p-4 space-y-1">
                <!-- Admin menu items injected here -->
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button id="admin-logout-btn" class="w-full flex items-center gap-2 p-2 rounded hover:bg-red-600">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="admin-main-content" class="flex-grow p-6 lg:p-8 overflow-y-auto">
            <!-- Admin page content injected here -->
        </main>
    </div>
    
    <!-- Admin Modals Container -->
    <div id="admin-modals-container"></div>

    <script>
        // --- SUPABASE & SETUP ---
        const SUPABASE_URL = 'https://vuecdeskfiiblejwqxfz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1ZWNkZXNrZmlpYmxlandxeGZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNzc1MjksImV4cCI6MjA2ODg1MzUyOX0.CPqX0xQHNp-UzAf0t5rXSP6LQeQdffqTTx9LWJLFQ9c';
        // IMPORTANT: For admin actions, you should use the service_role key.
        // This should NEVER be exposed on the client-side.
        // The correct way is to have all admin logic in Supabase Edge Functions.
        // For this demonstration, we will use the anon key and rely on RLS,
        // assuming the logged-in user has special permissions.
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const adminMenuItems = [
            { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
            { id: 'users', label: 'Users', icon: 'users' },
            { id: 'requests', label: 'Requests', icon: 'mail-check' },
            { id: 'plans', label: 'Manage Plans', icon: 'package' },
            { id: 'tasks', label: 'Manage Tasks', icon: 'clipboard-list' },
            { id: 'levels', label: 'Manage Levels', icon: 'award' },
            { id: 'news', label: 'Manage News', icon: 'newspaper' },
            { id: 'chats', label: 'Live Chats', icon: 'messages-square' },
            { id: 'about', label: 'Manage About', icon: 'info' },
            { id: 'social-videos', label: 'Manage Videos', icon: 'video' },
        ];

        // --- UI ELEMENTS ---
        const adminAuthSection = document.getElementById('admin-auth-section');
        const adminPanelSection = document.getElementById('admin-panel-section');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminMenu = document.getElementById('admin-menu');
        const adminMainContent = document.getElementById('admin-main-content');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');

        // --- ADMIN AUTH ---
        async function handleAdminLogin(event) {
            event.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            // IMPORTANT: In a real app, you should have a separate 'admin' role in your database.
            // This login is just for demonstration.
            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert(`Login failed: ${error.message}`);
            } else {
                // You should verify if the user is an admin here.
                // For now, we assume any login is an admin.
                initializeAppAdmin();
            }
        }

        async function handleAdminLogout() {
            await supabase.auth.signOut();
            adminAuthSection.style.display = 'flex';
            adminPanelSection.style.display = 'none';
        }

        async function checkAdminSession() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                // Again, verify admin role here.
                initializeAppAdmin();
            } else {
                adminAuthSection.style.display = 'flex';
                adminPanelSection.style.display = 'none';
            }
        }

        // --- ADMIN APP ---
        function initializeAppAdmin() {
            adminAuthSection.style.display = 'none';
            adminPanelSection.style.display = 'flex';
            renderAdminMenu();
            navigateToAdmin('dashboard');
        }

        function renderAdminMenu() {
            adminMenu.innerHTML = adminMenuItems.map(item => `
                <button onclick="navigateToAdmin('${item.id}')" id="admin-menu-btn-${item.id}" class="w-full flex items-center gap-3 p-2 rounded hover:bg-gray-700 transition-colors">
                    <i data-lucide="${item.icon}" class="w-5 h-5"></i>
                    <span>${item.label}</span>
                </button>
            `).join('');
            lucide.createIcons();
        }

        function navigateToAdmin(pageId) {
            document.querySelectorAll('[id^="admin-menu-btn-"]').forEach(btn => btn.classList.remove('bg-gray-900'));
            document.getElementById(`admin-menu-btn-${pageId}`).classList.add('bg-gray-900');

            // Load content for the admin page
            switch (pageId) {
                case 'dashboard': loadAdminDashboard(); break;
                case 'users': loadAdminUsers(); break;
                case 'requests': loadAdminRequests(); break;
                case 'plans': loadAdminPlans(); break;
                case 'tasks': loadAdminTasks(); break;
                case 'levels': loadAdminLevels(); break;
                case 'news': loadAdminNews(); break;
                case 'chats': loadAdminChats(); break;
                case 'about': loadAdminAbout(); break;
                case 'social-videos': loadAdminSocialVideos(); break;
            }
        }

        // --- ADMIN PAGE LOADERS ---
        async function loadAdminDashboard() {
            adminMainContent.innerHTML = `
                <h1 class="text-3xl font-bold text-admin-text-dark mb-6">Marketing Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stat cards injected here -->
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-admin-card-bg p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4">Revenue Over Time</h3>
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="bg-admin-card-bg p-6 rounded-lg shadow">
                        <h3 class="font-semibold mb-4">Plan Popularity</h3>
                        <canvas id="planPopularityChart"></canvas>
                    </div>
                </div>
            `;
            // Logic to fetch all marketing data and render charts using Chart.js
        }

        async function loadAdminUsers() {
            adminMainContent.innerHTML = `
                <h1 class="text-3xl font-bold text-admin-text-dark mb-6">User Management</h1>
                <div class="bg-admin-card-bg p-6 rounded-lg shadow overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="p-3">Username</th>
                                <th class="p-3">Balance</th>
                                <th class="p-3">Level</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="5" class="p-4 text-center">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            const { data: users, error } = await supabase.from('profiles').select('*, levels(level_name)');
            if (error) {
                document.getElementById('users-table-body').innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading users.</td></tr>`;
                return;
            }
            const tableBody = document.getElementById('users-table-body');
            tableBody.innerHTML = users.map(user => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-3">${user.username}</td>
                    <td class="p-3">${parseFloat(user.balance).toFixed(2)} MMK</td>
                    <td class="p-3">${user.levels.level_name}</td>
                    <td class="p-3">${user.is_banned ? '<span class="text-red-500 font-semibold">Banned</span>' : '<span class="text-green-500 font-semibold">Active</span>'}</td>
                    <td class="p-3 space-x-2">
                        <button onclick="toggleBanUser('${user.id}', ${user.is_banned})" class="p-2 rounded ${user.is_banned ? 'bg-green-500' : 'bg-yellow-500'} text-white"><i data-lucide="${user.is_banned ? 'check-circle' : 'ban'}" class="w-4 h-4"></i></button>
                        <button onclick="deleteUser('${user.id}')" class="p-2 rounded bg-red-500 text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }
        
        async function loadAdminRequests() {
            adminMainContent.innerHTML = `
                <h1 class="text-3xl font-bold text-admin-text-dark mb-6">Pending Requests</h1>
                <div class="bg-admin-card-bg p-6 rounded-lg shadow">
                    <h2 class="text-xl font-semibold mb-4">Plan Purchase Requests</h2>
                    <div id="plan-requests" class="space-y-4">Loading...</div>
                </div>
                <div class="bg-admin-card-bg p-6 rounded-lg shadow mt-8">
                    <h2 class="text-xl font-semibold mb-4">Withdrawal Requests</h2>
                    <div id="withdrawal-requests" class="space-y-4">Loading...</div>
                </div>
            `;
            
            // Load Plan Requests
            const { data: planReqs, error: planErr } = await supabase.from('user_plans').select('*, profiles(username), plans(name, price)').eq('status', 'pending');
            const planRequestsDiv = document.getElementById('plan-requests');
            if(planErr || planReqs.length === 0) {
                planRequestsDiv.innerHTML = `<p class="text-gray-500">${planErr ? 'Error loading requests.' : 'No pending plan requests.'}</p>`;
            } else {
                planRequestsDiv.innerHTML = planReqs.map(req => `
                    <div class="border p-4 rounded-md flex justify-between items-center">
                        <div>
                            <p><strong>User:</strong> ${req.profiles.username}</p>
                            <p><strong>Plan:</strong> ${req.plans.name} (${req.plans.price} MMK)</p>
                            <a href="${req.purchase_receipt_url}" target="_blank" class="text-blue-500 hover:underline">View Receipt</a>
                        </div>
                        <div class="space-x-2">
                            <button onclick="handlePlanRequest('${req.id}', true, ${req.plan_id})" class="bg-green-500 text-white px-4 py-2 rounded">Approve</button>
                            <button onclick="handlePlanRequest('${req.id}', false)" class="bg-red-500 text-white px-4 py-2 rounded">Reject</button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Load Withdrawal Requests
            // ... similar logic for withdrawals
        }
        
        async function handlePlanRequest(userPlanId, approve, planId = null) {
            if (approve) {
                const { data: planData, error: planError } = await supabase.from('plans').select('duration_days').eq('id', planId).single();
                if (planError) {
                    alert('Error fetching plan details.');
                    return;
                }
                const startTime = new Date();
                const endTime = new Date();
                endTime.setDate(startTime.getDate() + planData.duration_days);

                const { error } = await supabase.from('user_plans').update({ 
                    status: 'active',
                    start_time: startTime.toISOString(),
                    end_time: endTime.toISOString()
                }).eq('id', userPlanId);
                if (error) alert('Failed to approve plan.');
                else alert('Plan approved successfully.');
            } else {
                const { error } = await supabase.from('user_plans').update({ status: 'rejected' }).eq('id', userPlanId);
                if (error) alert('Failed to reject plan.');
                else alert('Plan rejected.');
            }
            loadAdminRequests(); // Refresh the list
        }
        
        async function toggleBanUser(userId, isCurrentlyBanned) {
            const newBanStatus = !isCurrentlyBanned;
            const { error } = await supabase.from('profiles').update({ is_banned: newBanStatus }).eq('id', userId);
            if (error) {
                alert(`Failed to ${newBanStatus ? 'ban' : 'unban'} user.`);
            } else {
                alert(`User ${newBanStatus ? 'banned' : 'unbanned'} successfully.`);
                loadAdminUsers();
            }
        }

        async function loadAdminPlans() {
            // ... (A view to see all plans, and a form to create/edit a plan, including image upload)
        }
        
        async function loadAdminTasks() {
            // ... (A view to see all tasks, and a form to create/edit tasks with all 3 types)
        }
        
        async function loadAdminLevels() {
            // ... (A view to see all levels, and a form to create/edit levels with icon upload and style selection)
        }

        async function loadAdminNews() {
            // ... (A view to see all news, and a form to create/edit news)
        }

        async function loadAdminChats() {
            // ... (A view to see all live chats)
        }

        async function loadAdminAbout() {
            // ... (A view to see and edit about information)
        }

        async function loadAdminSocialVideos() {
            // ... (A view to see and manage social videos)
        }

        // --- ONLOAD ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            adminLoginForm.addEventListener('submit', handleAdminLogin);
            adminLogoutBtn.addEventListener('click', handleAdminLogout);
            checkAdminSession();
        });
    </script>
</body>
</html>
