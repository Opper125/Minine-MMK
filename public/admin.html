<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #2c3e50;
        }
        .grid-cols-3 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        .card {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05);
        }
        .card h3 {
            color: #34495e;
            margin-bottom: 10px;
        }
        .card p {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            color: #555;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .status-pending { color: orange; font-weight: bold; }
        .status-approved { color: green; font-weight: bold; }
        .status-rejected { color: red; font-weight: bold; }
        .status-active { color: green; font-weight: bold; }
        .status-completed { color: gray; font-weight: bold; }
        .btn {
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .btn-approve {
            background-color: #28a745;
            color: white;
        }
        .btn-approve:hover {
            background-color: #218838;
        }
        .btn-reject {
            background-color: #dc3545;
            color: white;
        }
        .btn-reject:hover {
            background-color: #c82333;
        }
        .btn-ban {
            background-color: #ffc107;
            color: #333;
        }
        .btn-ban:hover {
            background-color: #e0a800;
        }
        .btn-unban {
            background-color: #17a2b8;
            color: white;
        }
        .btn-unban:hover {
            background-color: #138496;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group textarea {
            min-height: 80px;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%; /* Could be more or less, depending on screen size */
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <h1 class="text-3xl font-bold mb-6 text-center">MMK Mining Admin Dashboard</h1>

        <!-- Admin Login Section -->
        <div id="admin-login" class="mb-8 p-6 bg-blue-50 rounded-lg shadow-md">
            <h2 class="text-2xl font-semibold mb-4">Admin Login</h2>
            <div class="form-group">
                <label for="admin-username">Username:</label>
                <input type="text" id="admin-username" class="w-full p-2 border rounded">
            </div>
            <div class="form-group">
                <label for="admin-password">Password:</label>
                <input type="password" id="admin-password" class="w-full p-2 border rounded">
            </div>
            <button id="login-button" class="btn btn-primary w-full">Login</button>
            <p id="login-message" class="text-red-500 mt-2"></p>
        </div>

        <!-- Main Dashboard Content (hidden until logged in) -->
        <div id="dashboard-content" class="hidden">
            <h2 class="text-2xl font-semibold mb-4">Platform Analytics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="card">
                    <h3>Total Users</h3>
                    <p id="total-users">0</p>
                </div>
                <div class="card">
                    <h3>Active Plans</h3>
                    <p id="active-plans">0</p>
                </div>
                <div class="card">
                    <h3>Total Purchase Volume</h3>
                    <p id="total-purchase-volume">0 MMK</p>
                </div>
                <div class="card">
                    <h3>Total Lifetime Earnings</h3>
                    <p id="total-lifetime-earnings">0 MMK</p>
                </div>
                <div class="card">
                    <h3>Total Withdrawal Amount</h3>
                    <p id="total-withdrawal-amount">0 MMK</p>
                </div>
                <div class="card">
                    <h3>Completed Tasks</h3>
                    <p id="completed-tasks">0</p>
                </div>
            </div>

            <!-- Pending Purchases Section -->
            <h2 class="text-2xl font-semibold mb-4">Pending Purchases</h2>
            <table id="pending-purchases-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Plan ID</th>
                        <th>Cost</th>
                        <th>Status</th>
                        <th>Receipt URL</th>
                        <th>Purchased At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-pending-purchases" class="text-center text-gray-500 mt-4 hidden">No pending purchases.</p>

            <!-- Pending Withdrawals Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Pending Withdrawals</h2>
            <table id="pending-withdrawals-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Amount</th>
                        <th>Method</th>
                        <th>Phone</th>
                        <th>Account Name</th>
                        <th>Status</th>
                        <th>Requested At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-pending-withdrawals" class="text-center text-gray-500 mt-4 hidden">No pending withdrawals.</p>

            <!-- User Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">User Management</h2>
            <table id="users-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Name</th>
                        <th>Email</th> <!-- Added Email Column -->
                        <th>Balance</th>
                        <th>Mining Balance</th>
                        <th>Locked Balance</th>
                        <th>Level</th>
                        <th>Banned</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-users" class="text-center text-gray-500 mt-4 hidden">No users found.</p>

            <!-- News Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">News Management</h2>
            <button id="add-news-btn" class="btn btn-primary mb-4">Add New News</button>
            <table id="news-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Content</th>
                        <th>Image URL</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-news" class="text-center text-gray-500 mt-4 hidden">No news found.</p>

            <!-- About Info Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">About Info Management</h2>
            <button id="add-about-info-btn" class="btn btn-primary mb-4">Add New About Info</button>
            <table id="about-info-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Social Name</th>
                        <th>Link/Value</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-about-info" class="text-center text-gray-500 mt-4 hidden">No about info found.</p>

            <!-- Mining Plans Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Mining Plans Management</h2>
            <button id="add-plan-btn" class="btn btn-primary mb-4">Add New Mining Plan</button>
            <table id="mining-plans-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Cost</th>
                        <th>Total Return</th>
                        <th>Duration (Days)</th>
                        <th>Power/Sec</th>
                        <th>Payment Method</th>
                        <th>Phone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-mining-plans" class="text-center text-gray-500 mt-4 hidden">No mining plans found.</p>

            <!-- Tasks Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Tasks Management</h2>
            <button id="add-task-btn" class="btn btn-primary mb-4">Add New Task</button>
            <table id="tasks-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Link</th>
                        <th>Reward Type</th>
                        <th>Cash Reward</th>
                        <th>Mining Power Reward</th>
                        <th>Mining Duration (Hours)</th>
                        <th>Purchase Goal Amount</th>
                        <th>Goal Reward Amount</th>
                        <th>User Limit</th>
                        <th>Completions</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-tasks" class="text-center text-gray-500 mt-4 hidden">No tasks found.</p>

            <!-- Social Links Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Social Links Management</h2>
            <button id="add-social-link-btn" class="btn btn-primary mb-4">Add New Social Link</button>
            <table id="social-links-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Platform</th>
                        <th>Video URL</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-social-links" class="text-center text-gray-500 mt-4 hidden">No social links found.</p>

            <!-- Global Chat Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Global Chat Messages</h2>
            <table id="global-chat-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Is Admin</th>
                        <th>Content</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-global-chat" class="text-center text-gray-500 mt-4 hidden">No global chat messages.</p>

            <!-- Support Messages Management Section -->
            <h2 class="text-2xl font-semibold mt-8 mb-4">Support Messages</h2>
            <table id="support-messages-table" class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>User ID</th>
                        <th>Sent By Admin</th>
                        <th>Content</th>
                        <th>Read by User</th>
                        <th>Read by Admin</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
            <p id="no-support-messages" class="text-center text-gray-500 mt-4 hidden">No support messages.</p>

            <!-- Logout Button -->
            <button id="logout-button" class="btn btn-reject mt-8 w-full">Logout</button>
        </div>
    </div>

    <!-- Modals for Add/Edit -->
    <!-- News Modal -->
    <div id="news-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="news-modal-title" class="text-2xl font-semibold mb-4">Add News</h2>
            <form id="news-form">
                <input type="hidden" id="news-id">
                <div class="form-group">
                    <label for="news-title">Title:</label>
                    <input type="text" id="news-title" required>
                </div>
                <div class="form-group">
                    <label for="news-content">Content:</label>
                    <textarea id="news-content" required></textarea>
                </div>
                <div class="form-group">
                    <label for="news-image-url">Image URL:</label>
                    <input type="url" id="news-image-url">
                </div>
                <button type="submit" class="btn btn-primary">Save News</button>
            </form>
        </div>
    </div>

    <!-- About Info Modal -->
    <div id="about-info-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="about-info-modal-title" class="text-2xl font-semibold mb-4">Add About Info</h2>
            <form id="about-info-form">
                <input type="hidden" id="about-info-id">
                <div class="form-group">
                    <label for="about-social-name">Social Name:</label>
                    <input type="text" id="about-social-name" required>
                </div>
                <div class="form-group">
                    <label for="about-social-link-or-value">Link/Value:</label>
                    <input type="text" id="about-social-link-or-value" required>
                </div>
                <button type="submit" class="btn btn-primary">Save About Info</button>
            </form>
        </div>
    </div>

    <!-- Mining Plan Modal -->
    <div id="plan-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="plan-modal-title" class="text-2xl font-semibold mb-4">Add Mining Plan</h2>
            <form id="plan-form">
                <input type="hidden" id="plan-id">
                <div class="form-group">
                    <label for="plan-name">Name:</label>
                    <input type="text" id="plan-name" required>
                </div>
                <div class="form-group">
                    <label for="plan-cost">Cost:</label>
                    <input type="number" id="plan-cost" required>
                </div>
                <div class="form-group">
                    <label for="plan-total-return">Total Return:</label>
                    <input type="number" id="plan-total-return" required>
                </div>
                <div class="form-group">
                    <label for="plan-duration-days">Duration (Days):</label>
                    <input type="number" id="plan-duration-days" required>
                </div>
                <div class="form-group">
                    <label for="plan-payment-method">Payment Method:</label>
                    <input type="text" id="plan-payment-method" required>
                </div>
                <div class="form-group">
                    <label for="plan-payment-phone">Payment Phone:</label>
                    <input type="text" id="plan-payment-phone" required>
                </div>
                <div class="form-group">
                    <label for="plan-icon-url">Icon URL:</label>
                    <input type="url" id="plan-icon-url">
                </div>
                <div class="form-group">
                    <label for="plan-icon-style">Icon Style:</label>
                    <select id="plan-icon-style">
                        <option value="circle">Circle</option>
                        <option value="square">Square</option>
                        <option value="landscape">Landscape</option>
                        <option value="portrait">Portrait</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Save Plan</button>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="task-modal-title" class="text-2xl font-semibold mb-4">Add Task</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="task-title">Title:</label>
                    <input type="text" id="task-title" required>
                </div>
                <div class="form-group">
                    <label for="task-link">Link (Optional):</label>
                    <input type="url" id="task-link">
                </div>
                <div class="form-group">
                    <label for="task-reward-type">Reward Type:</label>
                    <select id="task-reward-type" required>
                        <option value="">Select Type</option>
                        <option value="cash">Cash</option>
                        <option value="mining_power">Mining Power</option>
                        <option value="purchase_goal">Purchase Goal</option>
                    </select>
                </div>
                <div class="form-group" id="cash-reward-group">
                    <label for="task-cash-reward">Cash Reward:</label>
                    <input type="number" id="task-cash-reward">
                </div>
                <div class="form-group" id="mining-power-reward-group">
                    <label for="task-mining-power-reward">Mining Power Reward:</label>
                    <input type="number" id="task-mining-power-reward">
                </div>
                <div class="form-group" id="mining-duration-hours-group">
                    <label for="task-mining-duration-hours">Mining Duration (Hours):</label>
                    <input type="number" id="task-mining-duration-hours">
                </div>
                <div class="form-group" id="purchase-goal-amount-group">
                    <label for="task-purchase-goal-amount">Purchase Goal Amount:</label>
                    <input type="number" id="task-purchase-goal-amount">
                </div>
                <div class="form-group" id="goal-reward-amount-group">
                    <label for="task-goal-reward-amount">Goal Reward Amount:</label>
                    <input type="number" id="task-goal-reward-amount">
                </div>
                <div class="form-group">
                    <label for="task-user-limit">User Limit (Optional):</label>
                    <input type="number" id="task-user-limit">
                </div>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </form>
        </div>
    </div>

    <!-- Social Link Modal -->
    <div id="social-link-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="social-link-modal-title" class="text-2xl font-semibold mb-4">Add Social Link</h2>
            <form id="social-link-form">
                <input type="hidden" id="social-link-id">
                <div class="form-group">
                    <label for="social-link-platform">Platform:</label>
                    <input type="text" id="social-link-platform" required>
                </div>
                <div class="form-group">
                    <label for="social-link-video-url">Video URL:</label>
                    <input type="url" id="social-link-video-url" required>
                </div>
                <button type="submit" class="btn btn-primary">Save Social Link</button>
            </form>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://slfmlndfcouckcqaztup.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZm1sbmRmY291Y2tjcWF6dHVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjU3NDksImV4cCI6MjA2OTQwMTc0OX0.ELZdUytnVYTG2RYjfyzL5mD_trcG7EsaBbgOuJLoAB4'; // Replace with your Supabase Anon Key
        const SUPABASE_SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsZm1sbmRmY291Y2tjcWF6dHVwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MzgyNTc0OSwiZXhwIjoyMDY5NDAxNzQ5fQ.F1Mo_LEMvI5Qk4s5QxfThsNTHCLcRxuMf53Pw9BEkRI'; // Replace with your Supabase Service Role Key

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const supabaseAdmin = Supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
            auth: {
                persistSession: false // Important for server-side/admin usage
            }
        });

        // Admin Credentials (for demonstration purposes - use environment variables or a more secure method in production)
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'adminpassword'; // Replace with a strong password

        // DOM Elements
        const adminLoginSection = document.getElementById('admin-login');
        const dashboardContent = document.getElementById('dashboard-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const loginMessage = document.getElementById('login-message');

        // Analytics
        const totalUsersEl = document.getElementById('total-users');
        const activePlansEl = document.getElementById('active-plans');
        const totalPurchaseVolumeEl = document.getElementById('total-purchase-volume');
        const totalLifetimeEarningsEl = document.getElementById('total-lifetime-earnings');
        const totalWithdrawalAmountEl = document.getElementById('total-withdrawal-amount');
        const completedTasksEl = document.getElementById('completed-tasks');

        // Tables
        const pendingPurchasesTableBody = document.querySelector('#pending-purchases-table tbody');
        const pendingWithdrawalsTableBody = document.querySelector('#pending-withdrawals-table tbody');
        const usersTableBody = document.querySelector('#users-table tbody');
        const newsTableBody = document.querySelector('#news-table tbody');
        const aboutInfoTableBody = document.querySelector('#about-info-table tbody');
        const miningPlansTableBody = document.querySelector('#mining-plans-table tbody');
        const tasksTableBody = document.querySelector('#tasks-table tbody');
        const socialLinksTableBody = document.querySelector('#social-links-table tbody');
        const globalChatTableBody = document.querySelector('#global-chat-table tbody');
        const supportMessagesTableBody = document.querySelector('#support-messages-table tbody');

        // No data messages
        const noPendingPurchases = document.getElementById('no-pending-purchases');
        const noPendingWithdrawals = document.getElementById('no-pending-withdrawals');
        const noUsers = document.getElementById('no-users');
        const noNews = document.getElementById('no-news');
        const noAboutInfo = document.getElementById('no-about-info');
        const noMiningPlans = document.getElementById('no-mining-plans');
        const noTasks = document.getElementById('no-tasks');
        const noSocialLinks = document.getElementById('no-social-links');
        const noGlobalChat = document.getElementById('no-global-chat');
        const noSupportMessages = document.getElementById('no-support-messages');

        // Modals and Forms
        const newsModal = document.getElementById('news-modal');
        const newsModalTitle = document.getElementById('news-modal-title');
        const newsForm = document.getElementById('news-form');
        const newsIdInput = document.getElementById('news-id');
        const newsTitleInput = document.getElementById('news-title');
        const newsContentInput = document.getElementById('news-content');
        const newsImageUrlInput = document.getElementById('news-image-url');
        const addNewsBtn = document.getElementById('add-news-btn');

        const aboutInfoModal = document.getElementById('about-info-modal');
        const aboutInfoModalTitle = document.getElementById('about-info-modal-title');
        const aboutInfoForm = document.getElementById('about-info-form');
        const aboutInfoIdInput = document.getElementById('about-info-id');
        const aboutSocialNameInput = document.getElementById('about-social-name');
        const aboutSocialLinkOrValueInput = document.getElementById('about-social-link-or-value');
        const addAboutInfoBtn = document.getElementById('add-about-info-btn');

        const planModal = document.getElementById('plan-modal');
        const planModalTitle = document.getElementById('plan-modal-title');
        const planForm = document.getElementById('plan-form');
        const planIdInput = document.getElementById('plan-id');
        const planNameInput = document.getElementById('plan-name');
        const planCostInput = document.getElementById('plan-cost');
        const planTotalReturnInput = document.getElementById('plan-total-return');
        const planDurationDaysInput = document.getElementById('plan-duration-days');
        const planPaymentMethodInput = document.getElementById('plan-payment-method');
        const planPaymentPhoneInput = document.getElementById('plan-payment-phone');
        const planIconUrlInput = document.getElementById('plan-icon-url');
        const planIconStyleSelect = document.getElementById('plan-icon-style');
        const addPlanBtn = document.getElementById('add-plan-btn');

        const taskModal = document.getElementById('task-modal');
        const taskModalTitle = document.getElementById('task-modal-title');
        const taskForm = document.getElementById('task-form');
        const taskIdInput = document.getElementById('task-id');
        const taskTitleInput = document.getElementById('task-title');
        const taskLinkInput = document.getElementById('task-link');
        const taskRewardTypeSelect = document.getElementById('task-reward-type');
        const taskCashRewardGroup = document.getElementById('cash-reward-group');
        const taskCashRewardInput = document.getElementById('task-cash-reward');
        const taskMiningPowerRewardGroup = document.getElementById('mining-power-reward-group');
        const taskMiningPowerRewardInput = document.getElementById('task-mining-power-reward');
        const taskMiningDurationHoursGroup = document.getElementById('mining-duration-hours-group');
        const taskMiningDurationHoursInput = document.getElementById('task-mining-duration-hours');
        const taskPurchaseGoalAmountGroup = document.getElementById('purchase-goal-amount-group');
        const taskPurchaseGoalAmountInput = document.getElementById('task-purchase-goal-amount');
        const taskGoalRewardAmountGroup = document.getElementById('goal-reward-amount-group');
        const taskGoalRewardAmountInput = document.getElementById('task-goal-reward-amount');
        const taskUserLimitInput = document.getElementById('task-user-limit');
        const addTaskBtn = document.getElementById('add-task-btn');

        const socialLinkModal = document.getElementById('social-link-modal');
        const socialLinkModalTitle = document.getElementById('social-link-modal-title');
        const socialLinkForm = document.getElementById('social-link-form');
        const socialLinkIdInput = document.getElementById('social-link-id');
        const socialLinkPlatformInput = document.getElementById('social-link-platform');
        const socialLinkVideoUrlInput = document.getElementById('social-link-video-url');
        const addSocialLinkBtn = document.getElementById('add-social-link-btn');

        // Helper to open/close modals
        function openModal(modal) {
            modal.style.display = 'block';
        }

        function closeModal(modal) {
            modal.style.display = 'none';
            // Reset form fields
            const form = modal.querySelector('form');
            if (form) form.reset();
            // Hide all task reward fields
            hideAllTaskRewardFields();
        }

        document.querySelectorAll('.close-button').forEach(button => {
            button.onclick = function() {
                closeModal(this.closest('.modal'));
            };
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                closeModal(event.target);
            }
        };

        // --- Authentication ---
        let isAdminAuthenticated = false;

        async function handleLogin() {
            const username = document.getElementById('admin-username').value;
            const password = document.getElementById('admin-password').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdminAuthenticated = true;
                localStorage.setItem('admin_authenticated', 'true');
                showDashboard();
            } else {
                loginMessage.textContent = 'Invalid username or password.';
            }
        }

        function handleLogout() {
            isAdminAuthenticated = false;
            localStorage.removeItem('admin_authenticated');
            showLogin();
        }

        function showDashboard() {
            adminLoginSection.classList.add('hidden');
            dashboardContent.classList.remove('hidden');
            loadAnalytics();
            loadPendingPurchases();
            loadPendingWithdrawals();
            loadUsers();
            loadNews();
            loadAboutInfo();
            loadMiningPlans();
            loadTasks();
            loadSocialLinks();
            loadGlobalChatMessages();
            loadSupportMessages();
        }

        function showLogin() {
            adminLoginSection.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            loginMessage.textContent = '';
            document.getElementById('admin-username').value = '';
            document.getElementById('admin-password').value = '';
        }

        // Check authentication status on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('admin_authenticated') === 'true') {
                isAdminAuthenticated = true;
                showDashboard();
            } else {
                showLogin();
            }
        });

        loginButton.addEventListener('click', handleLogin);
        logoutButton.addEventListener('click', handleLogout);

        // --- Data Loading Functions ---

        async function loadAnalytics() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin.rpc('get_platform_analytics');
            if (error) {
                console.error('Error loading analytics:', error);
                return;
            }
            if (data && data.length > 0) {
                const analytics = data[0];
                totalUsersEl.textContent = analytics.total_users;
                activePlansEl.textContent = analytics.active_plans;
                totalPurchaseVolumeEl.textContent = `${analytics.total_purchase_volume.toLocaleString()} MMK`;
                totalLifetimeEarningsEl.textContent = `${analytics.total_lifetime_earnings.toLocaleString()} MMK`;
                totalWithdrawalAmountEl.textContent = `${analytics.total_withdrawal_amount.toLocaleString()} MMK`;
                completedTasksEl.textContent = analytics.completed_tasks;
            }
        }

        async function loadPendingPurchases() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('user_purchases')
                .select('*')
                .eq('status', 'pending')
                .order('purchased_at', { ascending: false });

            if (error) {
                console.error('Error loading pending purchases:', error);
                return;
            }

            pendingPurchasesTableBody.innerHTML = '';
            if (data.length === 0) {
                noPendingPurchases.classList.remove('hidden');
            } else {
                noPendingPurchases.classList.add('hidden');
                data.forEach(purchase => {
                    const row = pendingPurchasesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${purchase.id}</td>
                        <td>${purchase.user_id}</td>
                        <td>${purchase.plan_id || 'N/A'}</td>
                        <td>${purchase.cost.toLocaleString()} MMK</td>
                        <td class="status-${purchase.status}">${purchase.status}</td>
                        <td><a href="${purchase.receipt_url}" target="_blank" class="text-blue-500 hover:underline">${purchase.receipt_url ? 'View Receipt' : 'N/A'}</a></td>
                        <td>${new Date(purchase.purchased_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-approve" onclick="approvePurchase(${purchase.id})">Approve</button>
                            <button class="btn btn-reject" onclick="rejectPurchase(${purchase.id})">Reject</button>
                        </td>
                    `;
                });
            }
        }

        async function loadPendingWithdrawals() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('withdrawals')
                .select('*')
                .eq('status', 'pending')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading pending withdrawals:', error);
                return;
            }

            pendingWithdrawalsTableBody.innerHTML = '';
            if (data.length === 0) {
                noPendingWithdrawals.classList.remove('hidden');
            } else {
                noPendingWithdrawals.classList.add('hidden');
                data.forEach(withdrawal => {
                    const row = pendingWithdrawalsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${withdrawal.id}</td>
                        <td>${withdrawal.user_id}</td>
                        <td>${withdrawal.amount.toLocaleString()} MMK</td>
                        <td>${withdrawal.payment_method}</td>
                        <td>${withdrawal.phone_number}</td>
                        <td>${withdrawal.account_name}</td>
                        <td class="status-${withdrawal.status}">${withdrawal.status}</td>
                        <td>${new Date(withdrawal.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-approve" onclick="approveWithdrawal(${withdrawal.id}, '${withdrawal.user_id}', ${withdrawal.amount})">Approve</button>
                            <button class="btn btn-reject" onclick="rejectWithdrawal(${withdrawal.id}, '${withdrawal.user_id}', ${withdrawal.amount})">Reject</button>
                        </td>
                    `;
                });
            }
        }

        async function loadUsers() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading users:', error);
                return;
            }

            usersTableBody.innerHTML = '';
            if (data.length === 0) {
                noUsers.classList.remove('hidden');
            } else {
                noUsers.classList.add('hidden');
                data.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td>${user.name}</td>
                        <td>${user.email || 'N/A'}</td> <!-- Display Email -->
                        <td>${user.balance.toLocaleString()} MMK</td>
                        <td>${user.mining_balance.toLocaleString()} MMK</td>
                        <td>${user.locked_balance.toLocaleString()} MMK</td>
                        <td>${user.current_level_number}</td>
                        <td>${user.is_banned ? 'Yes' : 'No'}</td>
                        <td>
                            ${user.is_banned ?
                                `<button class="btn btn-unban" onclick="unbanUser('${user.id}')">Unban</button>` :
                                `<button class="btn btn-ban" onclick="banUser('${user.id}')">Ban</button>`
                            }
                        </td>
                    `;
                });
            }
        }

        async function loadNews() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('news')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading news:', error);
                return;
            }

            newsTableBody.innerHTML = '';
            if (data.length === 0) {
                noNews.classList.remove('hidden');
            } else {
                noNews.classList.add('hidden');
                data.forEach(item => {
                    const row = newsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.title}</td>
                        <td>${item.content.substring(0, 50)}...</td>
                        <td><a href="${item.image_url}" target="_blank" class="text-blue-500 hover:underline">${item.image_url ? 'View Image' : 'N/A'}</a></td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editNews(${item.id})">Edit</button>
                            <button class="btn btn-reject" onclick="deleteNews(${item.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadAboutInfo() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('about_info')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading about info:', error);
                return;
            }

            aboutInfoTableBody.innerHTML = '';
            if (data.length === 0) {
                noAboutInfo.classList.remove('hidden');
            } else {
                noAboutInfo.classList.add('hidden');
                data.forEach(item => {
                    const row = aboutInfoTableBody.insertRow();
                    row.innerHTML = `
                        <td>${item.id}</td>
                        <td>${item.social_name}</td>
                        <td>${item.social_link_or_value}</td>
                        <td>${new Date(item.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editAboutInfo(${item.id})">Edit</button>
                            <button class="btn btn-reject" onclick="deleteAboutInfo(${item.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadMiningPlans() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('mining_plans')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading mining plans:', error);
                return;
            }

            miningPlansTableBody.innerHTML = '';
            if (data.length === 0) {
                noMiningPlans.classList.remove('hidden');
            } else {
                noMiningPlans.classList.add('hidden');
                data.forEach(plan => {
                    const row = miningPlansTableBody.insertRow();
                    row.innerHTML = `
                        <td>${plan.id}</td>
                        <td>${plan.name}</td>
                        <td>${plan.cost.toLocaleString()} MMK</td>
                        <td>${plan.total_return.toLocaleString()} MMK</td>
                        <td>${plan.duration_days}</td>
                        <td>${plan.power_per_second.toFixed(6)}</td>
                        <td>${plan.payment_method}</td>
                        <td>${plan.payment_phone}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editMiningPlan(${plan.id})">Edit</button>
                            <button class="btn btn-reject" onclick="deleteMiningPlan(${plan.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadTasks() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('tasks')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading tasks:', error);
                return;
            }

            tasksTableBody.innerHTML = '';
            if (data.length === 0) {
                noTasks.classList.remove('hidden');
            } else {
                noTasks.classList.add('hidden');
                data.forEach(task => {
                    const row = tasksTableBody.insertRow();
                    row.innerHTML = `
                        <td>${task.id}</td>
                        <td>${task.title}</td>
                        <td><a href="${task.link}" target="_blank" class="text-blue-500 hover:underline">${task.link ? 'View Link' : 'N/A'}</a></td>
                        <td>${task.reward_type}</td>
                        <td>${task.cash_reward ? task.cash_reward.toLocaleString() + ' MMK' : 'N/A'}</td>
                        <td>${task.mining_power_reward ? task.mining_power_reward.toLocaleString() : 'N/A'}</td>
                        <td>${task.mining_duration_hours || 'N/A'}</td>
                        <td>${task.purchase_goal_amount ? task.purchase_goal_amount.toLocaleString() + ' MMK' : 'N/A'}</td>
                        <td>${task.goal_reward_amount ? task.goal_reward_amount.toLocaleString() + ' MMK' : 'N/A'}</td>
                        <td>${task.user_limit || 'Unlimited'}</td>
                        <td>${task.completions}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editTask(${task.id})">Edit</button>
                            <button class="btn btn-reject" onclick="deleteTask(${task.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadSocialLinks() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('social_links')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading social links:', error);
                return;
            }

            socialLinksTableBody.innerHTML = '';
            if (data.length === 0) {
                noSocialLinks.classList.remove('hidden');
            } else {
                noSocialLinks.classList.add('hidden');
                data.forEach(link => {
                    const row = socialLinksTableBody.insertRow();
                    row.innerHTML = `
                        <td>${link.id}</td>
                        <td>${link.platform}</td>
                        <td><a href="${link.video_url}" target="_blank" class="text-blue-500 hover:underline">${link.video_url}</a></td>
                        <td>${new Date(link.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editSocialLink(${link.id})">Edit</button>
                            <button class="btn btn-reject" onclick="deleteSocialLink(${link.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadGlobalChatMessages() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('global_chat_messages')
                .select('*, users(username)') // Fetch username from users table
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading global chat messages:', error);
                return;
            }

            globalChatTableBody.innerHTML = '';
            if (data.length === 0) {
                noGlobalChat.classList.remove('hidden');
            } else {
                noGlobalChat.classList.add('hidden');
                data.forEach(message => {
                    const row = globalChatTableBody.insertRow();
                    row.innerHTML = `
                        <td>${message.id}</td>
                        <td>${message.users ? message.users.username : 'Deleted User'} (${message.user_id})</td>
                        <td>${message.is_admin ? 'Yes' : 'No'}</td>
                        <td>${message.content}</td>
                        <td>${new Date(message.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-reject" onclick="deleteGlobalChatMessage(${message.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }

        async function loadSupportMessages() {
            if (!isAdminAuthenticated) return;
            const { data, error } = await supabaseAdmin
                .from('support_messages')
                .select('*, users(username)') // Fetch username from users table
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading support messages:', error);
                return;
                }

            supportMessagesTableBody.innerHTML = '';
            if (data.length === 0) {
                noSupportMessages.classList.remove('hidden');
            } else {
                noSupportMessages.classList.add('hidden');
                data.forEach(message => {
                    const row = supportMessagesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${message.id}</td>
                        <td>${message.users ? message.users.username : 'Deleted User'} (${message.user_id})</td>
                        <td>${message.sent_by_admin ? 'Yes' : 'No'}</td>
                        <td>${message.content}</td>
                        <td>${message.is_read_by_user ? 'Yes' : 'No'}</td>
                        <td>${message.is_read_by_admin ? 'Yes' : 'No'}</td>
                        <td>${new Date(message.created_at).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-primary" onclick="replyToSupportMessage('${message.user_id}')">Reply</button>
                            <button class="btn btn-reject" onclick="deleteSupportMessage(${message.id})">Delete</button>
                        </td>
                    `;
                });
            }
        }


        // --- Action Functions ---

        async function approvePurchase(id) {
            if (!confirm('Are you sure you want to approve this purchase?')) return;
            const { error } = await supabaseAdmin
                .from('user_purchases')
                .update({ status: 'active' })
                .eq('id', id);

            if (error) {
                console.error('Error approving purchase:', error);
                alert('Failed to approve purchase.');
            } else {
                alert('Purchase approved successfully!');
                loadPendingPurchases();
                loadAnalytics(); // Analytics might change due to purchase volume update
                loadUsers(); // User level might change
            }
        }

        async function rejectPurchase(id) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return; // User cancelled

            if (!confirm('Are you sure you want to reject this purchase?')) return;
            const { error } = await supabaseAdmin
                .from('user_purchases')
                .update({ status: 'rejected', rejection_reason: reason })
                .eq('id', id);

            if (error) {
                console.error('Error rejecting purchase:', error);
                alert('Failed to reject purchase.');
            } else {
                alert('Purchase rejected successfully!');
                loadPendingPurchases();
            }
        }

        async function approveWithdrawal(id, userId, amount) {
            if (!confirm('Are you sure you want to approve this withdrawal?')) return;

            // Update withdrawal status
            const { error: withdrawalError } = await supabaseAdmin
                .from('withdrawals')
                .update({ status: 'approved' })
                .eq('id', id);

            if (withdrawalError) {
                console.error('Error approving withdrawal:', withdrawalError);
                alert('Failed to approve withdrawal.');
                return;
            }

            // Update user's locked_balance and total_withdrawal_amount
            const { error: userError } = await supabaseAdmin
                .from('users')
                .update({
                    locked_balance: supabaseAdmin.raw('locked_balance - ?', amount),
                    total_withdrawal_amount: supabaseAdmin.raw('total_withdrawal_amount + ?', amount)
                })
                .eq('id', userId);

            if (userError) {
                console.error('Error updating user balance after approval:', userError);
                alert('Withdrawal approved, but failed to update user balance. Manual correction needed.');
            } else {
                alert('Withdrawal approved successfully!');
            }
            loadPendingWithdrawals();
            loadAnalytics();
            loadUsers();
        }

        async function rejectWithdrawal(id, userId, amount) {
            const reason = prompt('Enter rejection reason (optional):');
            if (reason === null) return; // User cancelled

            if (!confirm('Are you sure you want to reject this withdrawal?')) return;

            // Update withdrawal status
            const { error: withdrawalError } = await supabaseAdmin
                .from('withdrawals')
                .update({ status: 'rejected', rejection_reason: reason })
                .eq('id', id);

            if (withdrawalError) {
                console.error('Error rejecting withdrawal:', withdrawalError);
                alert('Failed to reject withdrawal.');
                return;
            }

            // Return locked balance to main balance
            const { error: userError } = await supabaseAdmin
                .from('users')
                .update({
                    balance: supabaseAdmin.raw('balance + ?', amount),
                    locked_balance: supabaseAdmin.raw('locked_balance - ?', amount)
                })
                .eq('id', userId);

            if (userError) {
                console.error('Error returning balance after rejection:', userError);
                alert('Withdrawal rejected, but failed to return balance to user. Manual correction needed.');
            } else {
                alert('Withdrawal rejected successfully and balance returned!');
            }
            loadPendingWithdrawals();
            loadAnalytics();
            loadUsers();
        }

        async function banUser(userId) {
            if (!confirm('Are you sure you want to ban this user?')) return;
            const { error } = await supabaseAdmin
                .from('users')
                .update({ is_banned: true, banned_at: new Date().toISOString() })
                .eq('id', userId);

            if (error) {
                console.error('Error banning user:', error);
                alert('Failed to ban user.');
            } else {
                alert('User banned successfully!');
                loadUsers();
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user?')) return;
            const { error } = await supabaseAdmin
                .from('users')
                .update({ is_banned: false, banned_at: null })
                .eq('id', userId);

            if (error) {
                console.error('Error unbanning user:', error);
                alert('Failed to unban user.');
            } else {
                alert('User unbanned successfully!');
                loadUsers();
            }
        }

        // --- News CRUD ---
        addNewsBtn.onclick = () => {
            newsModalTitle.textContent = 'Add News';
            newsForm.reset();
            newsIdInput.value = '';
            openModal(newsModal);
        };

        async function editNews(id) {
            const { data, error } = await supabaseAdmin.from('news').select('*').eq('id', id).single();
            if (error) {
                console.error('Error fetching news for edit:', error);
                return;
            }
            newsModalTitle.textContent = 'Edit News';
            newsIdInput.value = data.id;
            newsTitleInput.value = data.title;
            newsContentInput.value = data.content;
            newsImageUrlInput.value = data.image_url || '';
            openModal(newsModal);
        }

        newsForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = newsIdInput.value;
            const newsData = {
                title: newsTitleInput.value,
                content: newsContentInput.value,
                image_url: newsImageUrlInput.value || null,
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseAdmin.from('news').update(newsData).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseAdmin.from('news').insert([newsData]));
            }

            if (error) {
                console.error('Error saving news:', error);
                alert('Failed to save news.');
            } else {
                alert('News saved successfully!');
                closeModal(newsModal);
                loadNews();
            }
        };

        async function deleteNews(id) {
            if (!confirm('Are you sure you want to delete this news item?')) return;
            const { error } = await supabaseAdmin.from('news').delete().eq('id', id);
            if (error) {
                console.error('Error deleting news:', error);
                alert('Failed to delete news.');
            } else {
                alert('News deleted successfully!');
                loadNews();
            }
        }

        // --- About Info CRUD ---
        addAboutInfoBtn.onclick = () => {
            aboutInfoModalTitle.textContent = 'Add About Info';
            aboutInfoForm.reset();
            aboutInfoIdInput.value = '';
            openModal(aboutInfoModal);
        };

        async function editAboutInfo(id) {
            const { data, error } = await supabaseAdmin.from('about_info').select('*').eq('id', id).single();
            if (error) {
                console.error('Error fetching about info for edit:', error);
                return;
            }
            aboutInfoModalTitle.textContent = 'Edit About Info';
            aboutInfoIdInput.value = data.id;
            aboutSocialNameInput.value = data.social_name;
            aboutSocialLinkOrValueInput.value = data.social_link_or_value;
            openModal(aboutInfoModal);
        }

        aboutInfoForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = aboutInfoIdInput.value;
            const aboutInfoData = {
                social_name: aboutSocialNameInput.value,
                social_link_or_value: aboutSocialLinkOrValueInput.value,
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseAdmin.from('about_info').update(aboutInfoData).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseAdmin.from('about_info').insert([aboutInfoData]));
            }

            if (error) {
                console.error('Error saving about info:', error);
                alert('Failed to save about info.');
            } else {
                alert('About Info saved successfully!');
                closeModal(aboutInfoModal);
                loadAboutInfo();
            }
        };

        async function deleteAboutInfo(id) {
            if (!confirm('Are you sure you want to delete this about info item?')) return;
            const { error } = await supabaseAdmin.from('about_info').delete().eq('id', id);
            if (error) {
                console.error('Error deleting about info:', error);
                alert('Failed to delete about info.');
            } else {
                alert('About Info deleted successfully!');
                loadAboutInfo();
            }
        }

        // --- Mining Plans CRUD ---
        addPlanBtn.onclick = () => {
            planModalTitle.textContent = 'Add Mining Plan';
            planForm.reset();
            planIdInput.value = '';
            planIconStyleSelect.value = 'circle'; // Default value
            openModal(planModal);
        };

        async function editMiningPlan(id) {
            const { data, error } = await supabaseAdmin.from('mining_plans').select('*').eq('id', id).single();
            if (error) {
                console.error('Error fetching mining plan for edit:', error);
                return;
            }
            planModalTitle.textContent = 'Edit Mining Plan';
            planIdInput.value = data.id;
            planNameInput.value = data.name;
            planCostInput.value = data.cost;
            planTotalReturnInput.value = data.total_return;
            planDurationDaysInput.value = data.duration_days;
            planPaymentMethodInput.value = data.payment_method;
            planPaymentPhoneInput.value = data.payment_phone;
            planIconUrlInput.value = data.icon_url || '';
            planIconStyleSelect.value = data.icon_style || 'circle';
            openModal(planModal);
        }

        planForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = planIdInput.value;
            const planData = {
                name: planNameInput.value,
                cost: parseFloat(planCostInput.value),
                total_return: parseFloat(planTotalReturnInput.value),
                duration_days: parseInt(planDurationDaysInput.value),
                payment_method: planPaymentMethodInput.value,
                payment_phone: planPaymentPhoneInput.value,
                icon_url: planIconUrlInput.value || null,
                icon_style: planIconStyleSelect.value,
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseAdmin.from('mining_plans').update(planData).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseAdmin.from('mining_plans').insert([planData]));
            }

            if (error) {
                console.error('Error saving mining plan:', error);
                alert('Failed to save mining plan.');
            } else {
                alert('Mining Plan saved successfully!');
                closeModal(planModal);
                loadMiningPlans();
            }
        };

        async function deleteMiningPlan(id) {
            if (!confirm('Are you sure you want to delete this mining plan?')) return;
            const { error } = await supabaseAdmin.from('mining_plans').delete().eq('id', id);
            if (error) {
                console.error('Error deleting mining plan:', error);
                alert('Failed to delete mining plan.');
            } else {
                alert('Mining Plan deleted successfully!');
                loadMiningPlans();
            }
        }

        // --- Tasks CRUD ---
        function hideAllTaskRewardFields() {
            taskCashRewardGroup.style.display = 'none';
            taskMiningPowerRewardGroup.style.display = 'none';
            taskMiningDurationHoursGroup.style.display = 'none';
            taskPurchaseGoalAmountGroup.style.display = 'none';
            taskGoalRewardAmountGroup.style.display = 'none';
            taskCashRewardInput.removeAttribute('required');
            taskMiningPowerRewardInput.removeAttribute('required');
            taskMiningDurationHoursInput.removeAttribute('required');
            taskPurchaseGoalAmountInput.removeAttribute('required');
            taskGoalRewardAmountInput.removeAttribute('required');
        }

        taskRewardTypeSelect.onchange = () => {
            hideAllTaskRewardFields();
            const selectedType = taskRewardTypeSelect.value;
            if (selectedType === 'cash') {
                taskCashRewardGroup.style.display = 'block';
                taskCashRewardInput.setAttribute('required', 'true');
            } else if (selectedType === 'mining_power') {
                taskMiningPowerRewardGroup.style.display = 'block';
                taskMiningDurationHoursGroup.style.display = 'block';
                taskMiningPowerRewardInput.setAttribute('required', 'true');
                taskMiningDurationHoursInput.setAttribute('required', 'true');
            } else if (selectedType === 'purchase_goal') {
                taskPurchaseGoalAmountGroup.style.display = 'block';
                taskGoalRewardAmountGroup.style.display = 'block';
                taskPurchaseGoalAmountInput.setAttribute('required', 'true');
                taskGoalRewardAmountInput.setAttribute('required', 'true');
            }
        };

        addTaskBtn.onclick = () => {
            taskModalTitle.textContent = 'Add Task';
            taskForm.reset();
            taskIdInput.value = '';
            hideAllTaskRewardFields();
            openModal(taskModal);
        };

        async function editTask(id) {
            const { data, error } = await supabaseAdmin.from('tasks').select('*').eq('id', id).single();
            if (error) {
                console.error('Error fetching task for edit:', error);
                return;
            }
            taskModalTitle.textContent = 'Edit Task';
            taskIdInput.value = data.id;
            taskTitleInput.value = data.title;
            taskLinkInput.value = data.link || '';
            taskRewardTypeSelect.value = data.reward_type;
            taskCashRewardInput.value = data.cash_reward || '';
            taskMiningPowerRewardInput.value = data.mining_power_reward || '';
            taskMiningDurationHoursInput.value = data.mining_duration_hours || '';
            taskPurchaseGoalAmountInput.value = data.purchase_goal_amount || '';
            taskGoalRewardAmountInput.value = data.goal_reward_amount || '';
            taskUserLimitInput.value = data.user_limit || '';

            taskRewardTypeSelect.onchange(); // Trigger change to show correct fields
            openModal(taskModal);
        }

        taskForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = taskIdInput.value;
            const rewardType = taskRewardTypeSelect.value;
            const taskData = {
                title: taskTitleInput.value,
                link: taskLinkInput.value || null,
                reward_type: rewardType,
                cash_reward: null,
                mining_power_reward: null,
                mining_duration_hours: null,
                purchase_goal_amount: null,
                goal_reward_amount: null,
                user_limit: taskUserLimitInput.value ? parseInt(taskUserLimitInput.value) : null,
            };

            if (rewardType === 'cash') {
                taskData.cash_reward = parseFloat(taskCashRewardInput.value);
            } else if (rewardType === 'mining_power') {
                taskData.mining_power_reward = parseFloat(taskMiningPowerRewardInput.value);
                taskData.mining_duration_hours = parseInt(taskMiningDurationHoursInput.value);
            } else if (rewardType === 'purchase_goal') {
                taskData.purchase_goal_amount = parseFloat(taskPurchaseGoalAmountInput.value);
                taskData.goal_reward_amount = parseFloat(taskGoalRewardAmountInput.value);
            }

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseAdmin.from('tasks').update(taskData).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseAdmin.from('tasks').insert([taskData]));
            }

            if (error) {
                console.error('Error saving task:', error);
                alert('Failed to save task.');
            } else {
                alert('Task saved successfully!');
                closeModal(taskModal);
                loadTasks();
            }
        };

        async function deleteTask(id) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            const { error } = await supabaseAdmin.from('tasks').delete().eq('id', id);
            if (error) {
                console.error('Error deleting task:', error);
                alert('Failed to delete task.');
            } else {
                alert('Task deleted successfully!');
                loadTasks();
            }
        }

        // --- Social Links CRUD ---
        addSocialLinkBtn.onclick = () => {
            socialLinkModalTitle.textContent = 'Add Social Link';
            socialLinkForm.reset();
            socialLinkIdInput.value = '';
            openModal(socialLinkModal);
        };

        async function editSocialLink(id) {
            const { data, error } = await supabaseAdmin.from('social_links').select('*').eq('id', id).single();
            if (error) {
                console.error('Error fetching social link for edit:', error);
                return;
            }
            socialLinkModalTitle.textContent = 'Edit Social Link';
            socialLinkIdInput.value = data.id;
            socialLinkPlatformInput.value = data.platform;
            socialLinkVideoUrlInput.value = data.video_url;
            openModal(socialLinkModal);
        }

        socialLinkForm.onsubmit = async (e) => {
            e.preventDefault();
            const id = socialLinkIdInput.value;
            const socialLinkData = {
                platform: socialLinkPlatformInput.value,
                video_url: socialLinkVideoUrlInput.value,
            };

            let error;
            if (id) {
                // Update
                ({ error } = await supabaseAdmin.from('social_links').update(socialLinkData).eq('id', id));
            } else {
                // Insert
                ({ error } = await supabaseAdmin.from('social_links').insert([socialLinkData]));
            }

            if (error) {
                console.error('Error saving social link:', error);
                alert('Failed to save social link.');
            } else {
                alert('Social Link saved successfully!');
                closeModal(socialLinkModal);
                loadSocialLinks();
            }
        };

        async function deleteSocialLink(id) {
            if (!confirm('Are you sure you want to delete this social link?')) return;
            const { error } = await supabaseAdmin.from('social_links').delete().eq('id', id);
            if (error) {
                console.error('Error deleting social link:', error);
                alert('Failed to delete social link.');
            } else {
                alert('Social Link deleted successfully!');
                loadSocialLinks();
            }
        }

        // --- Global Chat Management ---
        async function deleteGlobalChatMessage(id) {
            if (!confirm('Are you sure you want to delete this chat message?')) return;
            const { error } = await supabaseAdmin.from('global_chat_messages').delete().eq('id', id);
            if (error) {
                console.error('Error deleting global chat message:', error);
                alert('Failed to delete chat message.');
            } else {
                alert('Chat message deleted successfully!');
                loadGlobalChatMessages();
            }
        }

        // --- Support Message Management ---
        async function replyToSupportMessage(userId) {
            const replyContent = prompt('Enter your reply message:');
            if (replyContent === null || replyContent.trim() === '') {
                alert('Reply cannot be empty.');
                return;
            }

            const { error } = await supabaseAdmin.from('support_messages').insert([
                {
                    user_id: userId,
                    sent_by_admin: true,
                    content: replyContent,
                    is_read_by_user: false, // User needs to read this
                    is_read_by_admin: true // Admin has sent and read it
                }
            ]);

            if (error) {
                console.error('Error sending reply:', error);
                alert('Failed to send reply.');
            } else {
                alert('Reply sent successfully!');
                loadSupportMessages();
            }
        }

        async function deleteSupportMessage(id) {
            if (!confirm('Are you sure you want to delete this support message?')) return;
            const { error } = await supabaseAdmin.from('support_messages').delete().eq('id', id);
            if (error) {
                console.error('Error deleting support message:', error);
                alert('Failed to delete support message.');
            } else {
                alert('Support message deleted successfully!');
                loadSupportMessages();
            }
        }

    </script>
</body>
</html>
